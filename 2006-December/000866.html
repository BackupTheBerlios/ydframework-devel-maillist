<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [ydf-devel] r2274 - in YDFramework2.0/trunk/examples/weblog: .	include
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/ydframework-devel/2006-December/index.html" >
   <LINK REL="made" HREF="mailto:ydframework-devel%40lists.berlios.de?Subject=Re%3A%20%5Bydf-devel%5D%20r2274%20-%20in%20YDFramework2.0/trunk/examples/weblog%3A%20.%0A%09include&In-Reply-To=%3C200612271048.kBRAmLMH003958%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000865.html">
   <LINK REL="Next"  HREF="000867.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[ydf-devel] r2274 - in YDFramework2.0/trunk/examples/weblog: .	include</H1>
    <B>pclaerhout at BerliOS</B> 
    <A HREF="mailto:ydframework-devel%40lists.berlios.de?Subject=Re%3A%20%5Bydf-devel%5D%20r2274%20-%20in%20YDFramework2.0/trunk/examples/weblog%3A%20.%0A%09include&In-Reply-To=%3C200612271048.kBRAmLMH003958%40sheep.berlios.de%3E"
       TITLE="[ydf-devel] r2274 - in YDFramework2.0/trunk/examples/weblog: .	include">pclaerhout at mail.berlios.de
       </A><BR>
    <I>Wed Dec 27 11:48:21 CET 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="000865.html">[ydf-devel] r2273 -	YDFramework2.0/trunk/YDFramework2/addons/YDAkismet
</A></li>
        <LI>Next message: <A HREF="000867.html">[ydf-devel] r2275 - YDFramework2.0/trunk/examples
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#866">[ date ]</a>
              <a href="thread.html#866">[ thread ]</a>
              <a href="subject.html#866">[ subject ]</a>
              <a href="author.html#866">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: pclaerhout
Date: 2006-12-27 11:48:19 +0100 (Wed, 27 Dec 2006)
New Revision: 2274

Modified:
   YDFramework2.0/trunk/examples/weblog/include/YDWeblogAPI.php
   YDFramework2.0/trunk/examples/weblog/item.php
Log:
Changed the safehtml filter to the API class instead when adding a comment.

Modified: YDFramework2.0/trunk/examples/weblog/include/YDWeblogAPI.php
===================================================================
--- YDFramework2.0/trunk/examples/weblog/include/YDWeblogAPI.php	2006-12-27 10:47:33 UTC (rev 2273)
+++ YDFramework2.0/trunk/examples/weblog/include/YDWeblogAPI.php	2006-12-27 10:48:19 UTC (rev 2274)
@@ -1,1048 +1,1052 @@
-&lt;?php
-
-    // Function to save the configuration
-    function YDWeblogSaveConfig( $values ) {
-
-        // Remove some unneeded values
-        unset( $values['name'] );
-        unset( $values['email'] );
-        unset( $values['password'] );
-
-        // Add some default ones
-        if ( ! isset( $values['weblog_entries_fp'] ) ) {
-            $values['weblog_entries_fp'] = 5;
-        }
-        if ( ! isset( $values['email_new_comment'] ) ) {
-            $values['email_new_comment'] = true;
-        }
-        if ( ! isset( $values['use_cache'] ) ) {
-            $values['use_cache'] = false;
-        }
-        if ( ! isset( $values['max_syndicated_items'] ) ) {
-            $values['max_syndicated_items'] = 20;
-        }
-        if ( ! isset( $values['include_debug_info'] ) ) {
-            $values['include_debug_info'] = 0;
-        }
-        if ( ! isset( $values['dflt_is_draft'] ) ) {
-            $values['dflt_is_draft'] = false;
-        }
-        if ( empty( $values['db_pass'] ) ) {
-            $values['db_pass'] = YDConfig::get( 'db_pass', '' );
-        }
-
-        // Construct the new config text
-        $cfg = '&lt;?php' . &quot;\n\n&quot;;
-        $cfg .= '    // Do not edit this file manually!' . &quot;\n&quot;;
-        $cfg .= '    // Only edit this file using the admin tools!' . &quot;\n\n&quot;;
-
-        // Loop over the config values
-        foreach ( $values as $key=&gt;$val ) {
-
-            // Ignore items starting with an underscore
-            if ( substr( $key, 0, 1 ) != '_' ) {
-
-                // Escape strings
-                $key = str_replace( &quot;'&quot;, &quot;\\'&quot;, $key );
-                $val = str_replace( &quot;'&quot;, &quot;\\'&quot;, $val );
-
-                // Don't enclose numeric values with quotes
-                if ( is_bool( $val ) ) {
-                    $val = ( $val ) ? 'true' : 'false';
-                    $cfg .= &quot;    YDConfig::set( '&quot; . $key . &quot;', &quot; . $val . &quot; );\n&quot;;
-                } elseif ( is_numeric( $val ) ) {
-                    $cfg .= &quot;    YDConfig::set( '&quot; . $key . &quot;', &quot; . $val . &quot; );\n&quot;;
-                } else {
-                    $cfg .= &quot;    YDConfig::set( '&quot; . $key . &quot;', '&quot; . $val . &quot;' );\n&quot;;
-                }
-            }
-        }
-        $cfg .= &quot;\n&quot; . '?&gt;';
-
-        // Open the config file
-        $f = fopen( dirname( __FILE__ ) . '/config.php', 'w' );
-        fwrite( $f, $cfg );
-        fclose( $f );
-
-        // Set the right permissions
-        //@chmod( dirname( __FILE__ ) . '/config.php', 0700 );
-
-        // Create a .htaccess file if needed
-        $htaccessPath = dirname( dirname( __FILE__ ) ) . '/.htaccess';
-        if ( ! is_file( $htaccessPath ) ) {
-
-            // The htaccess data
-            $data = 'RewriteEngine on' . YD_CRLF;
-            $data .= 'Options +FollowSymlinks' . YD_CRLF;
-            $data .= 'RewriteRule ^item_([0-9]+).php?$ item.php?id=$1 [L]' . YD_CRLF;
-            $data .= 'RewriteRule ^page_([0-9]+).php?$ page.php?id=$1 [L]' . YD_CRLF;
-            $data .= 'RewriteRule ^category_([0-9]+).php?$ category.php?id=$1 [L]' . YD_CRLF;
-            $data .= 'RewriteRule ^link_([0-9]+).php?$ link.php?id=$1 [L]' . YD_CRLF;
-            $data .= 'RewriteRule ^image/(.*) item_gallery.php?id=$1 [L]' . YD_CRLF;
-
-            // Open the config file
-            $f = fopen( $htaccessPath, 'w' );
-            fwrite( $f, $data );
-            fclose( $f );
-
-            // Set the right permissions
-            //@chmod( $htaccessPath, 0700 );
-
-        }
-
-    }
-
-    // Function to format a string with list values
-    function YDFormatStringWithListValues( $string ) {
-        $string = str_replace( ';', ',', $string );
-        $string = explode( ',', $string );
-        foreach ( $string as $k=&gt;$v ) {
-            if ( trim( $v ) == '' ) {
-                unset( $string[$k] );
-            } else {
-                $string[$k] = trim( $v );
-            }
-        }
-        return implode( ', ', $string );
-    }
-
-    // Class defining our weblog API
-    class YDWeblogAPI extends YDBase {
-
-        // Class constructor
-        function YDWeblogAPI() {
-
-            // Initialize the parent
-            $this-&gt;YDBase();
-
-            // Get the database connection
-            $this-&gt;db = YDDatabase::getInstance(
-                'mysql',
-                YDConfig::get( 'db_name', 'YDWeblog' ), YDConfig::get( 'db_user', 'root' ),
-                YDConfig::get( 'db_pass', '' ), YDConfig::get( 'db_host', 'localhost' )
-            );
-
-            // Get a link to the database metadata
-            $this-&gt;dbmeta = new YDDatabaseMetaData( $this-&gt;db );
-
-            // Upgrade the schema if needed
-            $this-&gt;upgradeSchemaIfNeeded();
-
-            // The array that will hold the image metadata
-            $this-&gt;imagemetadata = null;
-
-            // Delete spam comments older than 7 days
-            $sql = 'DELETE FROM #_comments WHERE is_spam = 1 AND created &lt; (unix_timestamp()-604800)';
-            $this-&gt;db-&gt;executeSql( $sql );
-
-            // Delete the old IP numbers from spam check
-            $comment_interval = YDConfig::get( 'comment_interval', 10 );
-            if ( $comment_interval != '' &amp;&amp; is_numeric( $comment_interval ) ) {
-                $sql = 'DELETE FROM #_spamcheck WHERE lastvisit &lt; (unix_timestamp()-' . $comment_interval . ')';
-                $this-&gt;db-&gt;executeSql( $sql );
-            }
-
-            // Check against akismet if a key is there
-            if ( YDConfig::get( 'akismet_key', '' ) != '' ) {
-
-                // Include the YDAkismet addon
-                include_once( YD_DIR_HOME_ADD . '/YDAkismet/YDAkismet.php' );
-
-                // Get the URL of the weblog
-                $weblog_url = dirname( YDRequest::getCurrentUrl( true ) ) . '/';
-
-                // Initialize YDAkismet
-                $this-&gt;akismet = new YDAkismet( $weblog_url, YDConfig::get( 'akismet_key', '' ) );
-
-            } else {
-
-                // No akismet
-                $this-&gt;akismet = null;
-
-            }
-
-        }
-
-        // Get the schema version
-        function getSchemaVersion() {
-
-            // Create the schemaversion table if it doesn't exists
-            if ( ! $this-&gt;dbmeta-&gt;tableExists( '#_schemaversion' ) ) {
-                $sql = 'CREATE TABLE #_schemaversion (installed INT(11), version INT (11))';
-                $this-&gt;db-&gt;executeSql( $sql );
-            }
-
-            // Check the schema version
-            $schema_version = $this-&gt;db-&gt;getValue( 'select version from #_schemaversion order by installed desc, version desc' );
-
-            // Return the schema version
-            return ( $schema_version === false  ) ? 0 : intval( $schema_version );
-
-        }
-
-        // Get the full schema information
-        function getFullSchemaVersion() {
-            $this-&gt;getSchemaVersion();
-            return $this-&gt;db-&gt;getRecord( 'select installed, version from #_schemaversion order by installed desc, version desc' );
-        }
-
-        // Function to set the schema version
-        function setSchemaVersion( $version ) {
-            $values = array();
-            $values['installed'] = time();
-            $values['version'] = $version;
-            $this-&gt;db-&gt;executeInsert( '#_schemaversion', $values );
-        }
-
-        // Upgrade the schema if needed
-        function upgradeSchemaIfNeeded() {
-
-            // The current weblog schema version
-            $current_schema = 7;
-
-            // Get the schema version
-            $installed_schema = $this-&gt;getSchemaVersion();
-
-            // Check if we have the required schema version
-            if ( $installed_schema &lt; $current_schema ) {
-
-                // Add any missing comments fields
-                $fields = $this-&gt;dbmeta-&gt;getFields( '#_comments' );
-                $this-&gt;executeIfMissing( 'useragent', $fields, 'ALTER TABLE #_comments ADD useragent varchar(255) AFTER userip' );
-                $this-&gt;executeIfMissing( 'userrequrl', $fields, 'ALTER TABLE #_comments ADD userrequrl varchar(255) AFTER useragent' );
-                $this-&gt;executeIfMissing( 'is_spam', $fields, 'ALTER TABLE #_comments ADD is_spam TINYINT(1) DEFAULT &quot;0&quot; NOT NULL AFTER comment' );
-
-                // Add any missing items fields
-                $fields = $this-&gt;dbmeta-&gt;getFields( '#_items' );
-                $this-&gt;executeIfMissing( 'body_more', $fields, 'ALTER TABLE #_items ADD body_more LONGTEXT AFTER body' );
-                $this-&gt;executeIfMissing( 'is_draft', $fields, 'ALTER TABLE #_items ADD is_draft TINYINT(1) DEFAULT &quot;0&quot; NOT NULL AFTER num_comments' );
-                $this-&gt;executeIfPresent( 'allow_comments', $fields, 'ALTER TABLE #_items DROP allow_comments' );
-                $this-&gt;executeIfPresent( 'auto_close', $fields, 'ALTER TABLE #_items DROP auto_close' );
-
-                // Add any missing pages field
-                $fields = $this-&gt;dbmeta-&gt;getFields( '#_pages' );
-                $this-&gt;executeIfMissing( 'is_draft', $fields, 'ALTER TABLE #_pages ADD is_draft TINYINT(1) DEFAULT &quot;0&quot; NOT NULL AFTER body' );
-
-                // Get the list of indexes for the items table
-                $indexes = $this-&gt;dbmeta-&gt;getIndexes( '#_items' );
-                $this-&gt;executeIfMissing( 'is_draft', $indexes, 'ALTER TABLE #_items ADD INDEX is_draft (is_draft)' );
-
-                // Get the list of indexes for the pages table
-                $indexes = $this-&gt;dbmeta-&gt;getIndexes( '#_pages' );
-                $this-&gt;executeIfMissing( 'is_draft', $indexes, 'ALTER TABLE #_pages ADD INDEX is_draft (is_draft)' );
-
-                // Get the list of indexes for the users table
-                $indexes = $this-&gt;dbmeta-&gt;getIndexes( '#_users' );
-                $this-&gt;executeIfPresent( 'email', $indexes, 'ALTER TABLE #_users DROP INDEX email' );
-                $this-&gt;executeIfMissing( 'name',  $indexes, 'ALTER TABLE #_users ADD UNIQUE name (name)' );
-
-                // Fix the shemaversion table if needed
-                $this-&gt;db-&gt;executeSql( 'ALTER TABLE #_schemaversion CHANGE installed installed INT(11)' );
-                $this-&gt;db-&gt;executeSql( 'UPDATE #_schemaversion SET installed = unix_timestamp() WHERE installed = 0' );
-
-                // Drop the statistics tables
-                $this-&gt;db-&gt;executeSql( 'DROP TABLE IF EXISTS #_statistics' );
-                $this-&gt;db-&gt;executeSql( 'DROP TABLE IF EXISTS #_statistics_init' );
-
-                // Create the image_metadata table
-                if ( ! $this-&gt;dbmeta-&gt;tableExists( '#_imagemetadata' ) ) {
-                    $this-&gt;db-&gt;executeSql(
-                          'CREATE TABLE #_imagemetadata ('
-                        . '  id int(11) NOT NULL auto_increment,'
-                        . '  img_path varchar(255) NOT NULL default \'\','
-                        . '  title varchar(255) default NULL,'
-                        . '  description longtext,'
-                        . '  created int(11) default NULL,'
-                        . '  modified int(11) default NULL,'
-                        . '  PRIMARY KEY  (id),'
-                        . '  UNIQUE KEY img_path (img_path)'
-                        . ')'
-                    );
-                }
-
-                // Create the spamcheck table
-                if ( ! $this-&gt;dbmeta-&gt;tableExists( '#_spamcheck' ) ) {
-                    $this-&gt;db-&gt;executeSql(
-                          'CREATE TABLE #_spamcheck ('
-                        . '  id int(11) NOT NULL auto_increment,'
-                        . '  userip varchar(20) default NULL,'
-                        . '  lastvisit int(11) default NULL,'
-                        . '  PRIMARY KEY  (id),'
-                        . '  UNIQUE KEY userip (userip)'
-                        . ')'
-                    );
-                }
-
-                // Update the schema information
-                $this-&gt;setSchemaVersion( $current_schema );
-
-            }
-
-        }
-
-        // Function to execute SQL if the item is missing
-        function executeIfMissing( $needle, $haystack, $sql ) {
-            if ( ! in_array( $needle, $haystack ) ) {
-                $this-&gt;db-&gt;executeSql( $sql );
-            }
-        }
-
-        // Function to execute SQL if the item is not missing
-        function executeIfPresent( $needle, $haystack, $sql ) {
-            if ( in_array( $needle, $haystack ) ) {
-                $this-&gt;db-&gt;executeSql( $sql );
-            }
-        }
-
-        // Function to auto add some records to an item
-        function _fixItem( $item, $order='created desc, title' ) {
-
-            // Return false if no item
-            if ( ! $item ) {
-                return $item;
-            }
-
-            // Get the item indexes for the indicated weblog (cached to minimize the number of SQL queries)
-            $cacheName = 'YD_CACHE_WEBLOG_ITEMIDS_' . md5( strtolower( $order ) );
-            if ( ! isset( $GLOBALS[ $cacheName ] ) ) {
-                $sql = $this-&gt;_prepareQuery( 'SELECT id FROM #_items', $order );
-                $item_ids = $this-&gt;db-&gt;getValuesByName( $sql, 'id' );
-                $GLOBALS[ $cacheName ] = $item_ids;
-            }
-
-            // Get the ID of the previous and the next item
-            $pos = array_search( $item['id'], $GLOBALS[ $cacheName ] );
-            $item['newer_id'] = ( $pos == 0 ) ? false : $GLOBALS[ $cacheName ][$pos-1] ;
-            $item['older_id'] = ( $pos == sizeof( $GLOBALS[ $cacheName ] )-1 ) ? false : $GLOBALS[ $cacheName ][$pos+1] ;
-
-            // Add the year, month and yearmonth fields
-            $item['yearmonth'] = ucwords( strftime( '%B %Y', $item['created'] ) );
-            $item['month']     = ucwords( strftime( '%B',    $item['created'] ) );
-            $item['year']      = ucwords( strftime( '%Y',    $item['created'] ) );
-
-            // Get the list of images related to this item
-            $imgPath = dirname( __FILE__ ) . '/../' . YDConfig::get( 'dir_uploads', 'uploads' ) . '/item_' . $item['id'] .'/';
-
-            // Get the list of pictures if any
-            if ( is_dir( $imgPath ) ) {
-
-                // Get a handle to the directory
-                $dir = new YDFSDirectory( dirname( __FILE__ ) . '/../' . YDConfig::get( 'dir_uploads', 'uploads' ) . '/item_' . $item['id'] .'/' );
-
-                // Get the list of files
-                $images = $dir-&gt;getContents( array( '!index.html', '!index.php', '!m_*.*', '!s_*.*' ), null, array( 'YDFSImage' ) );
-
-                // Make the relative path for each file
-                foreach ( $images as $key=&gt;$image ) {
-
-                    // Generate the thumbnails if not there yet
-                    if ( ! is_file( $dir-&gt;getAbsolutePath() . '/s_' . $image-&gt;getBasename() ) ) {
-                        $image-&gt;saveThumbnail( 48, 48, $dir-&gt;getAbsolutePath() . '/s_' . $image-&gt;getBasename() );
-                    }
-                    if ( ! is_file( $dir-&gt;getAbsolutePath() . '/m_' . $image-&gt;getBasename() ) ) {
-                        $image-&gt;saveThumbnail( 100, 100, $dir-&gt;getAbsolutePath() . '/m_' . $image-&gt;getBasename() );
-                    }
-
-                    // Set the relative path
-                    $dir_uploads = dirname( __FILE__ ) . '/../' . YDConfig::get( 'dir_uploads', 'uploads' );
-                    $dir_uploads = new YDFSDirectory( $dir_uploads );
-                    $image-&gt;relative_path = str_replace( $dir_uploads-&gt;getAbsolutePath(), '', $image-&gt;getAbsolutePath() );
-
-                    // Update the backslashes
-                    $image-&gt;relative_path = ltrim( str_replace( '\\', '/', $image-&gt;relative_path ), '/' );
-
-                    // Merge the title and description if any
-                    $image = $this-&gt;getItemImageMetaData( $image );
-
-                    // Create the full title, including item title, image title and description if any
-                    $image-&gt;full_description = $item['title'] . ' &raquo; ' . $image-&gt;title;
-                    if ( $image-&gt;description ) {
-                        $image-&gt;full_description .= '&lt;p class=&quot;img_description&quot;&gt;'
-                                                 . YDTemplate_modifier_bbcode( $image-&gt;description ) . '&lt;/p&gt;';
-                    }
-                    $image-&gt;full_description_html = htmlspecialchars( $image-&gt;full_description, ENT_QUOTES );
-
-                    // Make links to the thumbnails
-                    $image-&gt;relative_path_s = dirname( $image-&gt;relative_path ) . '/s_' . basename( $image-&gt;relative_path );
-                    $image-&gt;relative_path_m = dirname( $image-&gt;relative_path ) . '/m_' . basename( $image-&gt;relative_path );
-
-                    // Add the thumbnails as objects
-                    $image-&gt;relative_path_s_obj = new YDFSImage( $dir_uploads-&gt;getAbsolutePath() . '/' . $image-&gt;relative_path_s );
-                    $image-&gt;relative_path_m_obj = new YDFSImage( $dir_uploads-&gt;getAbsolutePath() . '/' . $image-&gt;relative_path_m );
-
-                    // Update the original image
-                    $images[$key] = $image;
-
-                }
-
-                // Add it to the item
-                $item['images'] = $images;
-
-            } else {
-
-                // No images for this item
-                $item['images'] = array();
-
-            }
-
-            // Fix the image paths
-            if( strtolower( basename( dirname( YD_SELF_FILE ) ) ) != 'manage' ) {
-                $uploads = YDConfig::get( 'dir_uploads', 'uploads' );
-                $item['body'] = str_replace( '../' . $uploads, $uploads, $item['body'] );
-                $item['body_more'] = str_replace( '../' . $uploads, $uploads, $item['body_more'] );
-            }
-
-            // Get the count of images
-            $item['num_images'] = sizeof( $item['images'] );
-
-            // Return the fixed item
-            return $item;
-
-        }
-
-        // Fix a list of items
-        function _fixItems( $items, $order='created desc, title' ) {
-            foreach ( $items as $key=&gt;$item ) {
-                $items[$key] = $this-&gt;_fixItem( $item, $order );
-            }
-            return $items;
-        }
-
-        // Function to initialize image metadata
-        function initImageMetaData() {
-
-            // Get the image metadata if not there yet
-            if ( is_null( $this-&gt;imagemetadata ) ) {
-                $this-&gt;imagemetadata = $this-&gt;db-&gt;getRecords( 'SELECT * FROM #_imagemetadata' );
-                $this-&gt;imagemetadata = YDArrayUtil::convertToNested( $this-&gt;imagemetadata, 'img_path' );
-                foreach ( $this-&gt;imagemetadata as $key=&gt;$val ) {
-                    $this-&gt;imagemetadata[$key] = $val[0];
-                }
-            }
-
-        }
-
-        // Get the title and description for an item image
-        function getItemImageMetaData( $image ) {
-
-            // Initialize the image data
-            $this-&gt;initImageMetaData();
-
-            // Start with the default settings
-            $image-&gt;title = $image-&gt;getBasenameNoExt();
-            $image-&gt;description = '';
-
-            // Add the image data if any
-            if ( isset( $this-&gt;imagemetadata[ $image-&gt;relative_path ] ) ) {
-                $image-&gt;title = $this-&gt;imagemetadata[ $image-&gt;relative_path ]['title'];
-                $image-&gt;description = $this-&gt;imagemetadata[ $image-&gt;relative_path ]['description'];
-            }
-
-            // Return the image metadata
-            return $image;
-
-        }
-
-        // Update the image data for an item in the database
-        function setItemImageMetaData( $item, $data ) {
-            $values = $data;
-            $values['img_path'] = $item;
-            $result = $this-&gt;_executeUpdate( '#_imagemetadata', $values, 'img_path = ' . $this-&gt;str( $item ) );
-            if ( $result == '0' ) {
-                $result = $this-&gt;_executeInsert( '#_imagemetadata', $values );
-            }
-            return $result;
-        }
-
-        // Function to delete the image data for an item in the database
-        function removeImageMetaData( $image ) {
-            $sql = 'DELETE FROM #_imagemetadata WHERE img_path = ' . $this-&gt;str( $image );
-            return $this-&gt;db-&gt;executeSql( $sql );
-        }
-
-        // Function to get a single item
-        function getItem( $where ) {
-            $result = $this-&gt;getItems( 1, 0, 'created desc, title', $where );
-            return ( $result &amp;&amp; sizeof( $result ) == 1 ) ? $result[0] : $result;
-        }
-
-        // Get the non draft items
-        function getPublicItems( $limit=-1, $offset=-1, $order='created desc, title', $where='AND is_draft = 0' ) {
-            return $this-&gt;getItems( $limit, $offset, $order, $where );
-        }
-
-        // Function to get the items of the weblog
-        function getItems( $limit=-1, $offset=-1, $order='created desc, title', $where='' ) {
-            $sql = 'SELECT i.id, i.category_id, i.title, i.body, i.body_more, i.num_comments, i.created, i.modified, '
-                 . 'i.is_draft, '
-                 . 'c.title as category, u.email as user_email, u.name as user_name FROM #_items i, #_categories c, '
-                 . '#_users u WHERE i.category_id = c.id AND i.user_id = u.id ';
-            $sql = $this-&gt;_prepareQuery( $sql . $where, $order );
-            return $this-&gt;_fixItems( $this-&gt;db-&gt;getRecords( $sql, $limit, $offset ) );
-        }
-
-        // Get related items
-        function getRelatedItemsByItem( $limit, $item ) {
-
-            // Get the items from the same category
-            $items = $this-&gt;getItems(
-                -1, -1, 'created desc, title', 'AND is_draft = 0 AND i.category_id = '
-              . $this-&gt;str( $item['category_id'] ) . ' and i.id &lt;&gt; ' . $this-&gt;str( $item['id'] )
-            );
-
-            // Shuffle the items
-            shuffle( $items );
-
-            // Get the right rows
-            $items = array_slice( $items, 0, $limit );
-
-            // Sort them by date
-            $sorted = array();
-            foreach ( $items as $key=&gt;$item ) {
-                $sorted[ $key ] = intval( $item['created'] );
-            }
-            sort( $sorted );
-
-            // Rearrange the array
-            $sorted_items = array();
-            foreach ( $sorted as $key=&gt;$date ) {
-                array_push( $sorted_items, $items[ $key ] );
-            }
-
-            // Return the items
-            return array_values( $sorted_items );
-
-        }
-
-        // Get a publc item by it's ID
-        function getPublicItemByID( $item_id ) {
-            return $this-&gt;getItem( 'AND is_draft = 0 AND i.id = ' . $this-&gt;str( $item_id ) );
-        }
-
-        // Get an item by it's ID
-        function getItemById( $item_id ) {
-            return $this-&gt;getItem( 'AND i.id = ' . $this-&gt;str( $item_id ) );
-        }
-
-        // Add an item
-        function addItem( $values ) {
-            return $this-&gt;_executeInsert( '#_items', $values );
-        }
-
-        // Update an item
-        function updateItem( $values ) {
-            unset( $values['user_id'] );
-            return $this-&gt;db-&gt;executeUpdate( '#_items', $values, 'id = ' . $this-&gt;str( $values['id'] ) );
-        }
-
-        // Delete an item
-        function deleteItem( $item_id ) {
-            $sql = $this-&gt;_prepareQuery( 'DELETE FROM #_comments WHERE item_id = ' . $this-&gt;str( $item_id ) );
-            $this-&gt;db-&gt;executeSql( $sql );
-            return $this-&gt;_deleteFromTableUsingID( '#_items', $item_id );
-        }
-
-        // Get the comments for an item
-        function getComments( $item_id=null, $order='created', $limit=-1, $offset=-1, $public_only=false, $spam_only=false ) {
-            $query = 'SELECT c.id as id, c.item_id as item_id, c.username as username, c.useremail as useremail, c.userwebsite as userwebsite, c.userip as userip, c.useragent as useragent, c.userrequrl as userrequrl, c.comment as comment, c.is_spam as is_spam, c.created as created, c.modified as modified, i.title as item_title, i.is_draft as item_is_draft FROM #_comments c, #_items i WHERE c.item_id = i.id';
-            if ( $item_id ) {
-                $query .= ' and item_id = ' . $this-&gt;str( $item_id );
-            }
-            if ( $public_only == true ) {
-                $query .= ' and i.is_draft = 0';
-            }
-            if ( $spam_only == true ) {
-                $query .= ' and c.is_spam = 1';
-            } else {
-                $query .= ' and c.is_spam = 0';
-            }
-            $records = $this-&gt;db-&gt;getRecords( $this-&gt;_prepareQuery( $query, $order ), $limit, $offset );
-            foreach ( $records as $key=&gt;$record ) {
-                $records[$key]['comment'] = trim( $record['comment'] );
-            }
-            return $records;
-        }
-
-        // Get duplicate comments based on the current values
-        function isDuplicateComment( $values ) {
-            $values['comment'] = trim( strtolower( $values['comment'] ) );
-            $values['username'] = trim( strtolower( $values['username'] ) );
-            $sql = 'SELECT COUNT(*) AS comment_count FROM #_comments WHERE item_id = ' . $this-&gt;str( $values['item_id'] )
-                 . ' AND TRIM( LOWER( username ) ) = ' . $this-&gt;str( $values['username'] )
-                 . ' AND TRIM( LOWER( comment ) ) = ' . $this-&gt;str( $values['comment'] );
-            $result = intval( $this-&gt;db-&gt;getValueByName( $sql, 'comment_count' ) );
-            return ( $result &gt; 0 );
-        }
-
-        // Get a comment by it's ID
-        function getCommentById( $comment_id ) {
-            $sql = $this-&gt;_prepareQuery( 'SELECT c.id as id, c.item_id as item_id, c.username as username, c.useremail as useremail, c.userwebsite as userwebsite, c.userip as userip, c.useragent as useragent, c.userrequrl as userrequrl, c.comment as comment, c.is_spam as is_spam, c.created as created, c.modified as modified, i.title as item_title FROM #_comments c, #_items i WHERE c.item_id = i.id and c.id = ' . $this-&gt;str( $comment_id ) );
-            $record  = $this-&gt;db-&gt;getRecord( $sql );
-            $record['comment'] = trim( $record['comment'] );
-            return $record;
-        }
-
-        // Add a comment
-        function addComment( $values ) {
-
-            // Update the values
-            $values['userip'] = $_SERVER['REMOTE_ADDR'];
-            $values['useragent'] = $_SERVER['HTTP_USER_AGENT'];
-            $values['userrequrl'] = $_SERVER['REQUEST_URI'];
-            $values['is_spam'] = 0;
-
-            // Check against akismet if a key is there
-            if ( YDConfig::get( 'akismet_key', '' ) != '' ) {
-
-                // Check if it's spam or not
-                $result = $this-&gt;akismet-&gt;checkComment(
-                    $values['comment'], $values['username'], $values['useremail'], $values['userwebsite'],
-                    $values['userip'], $values['useragent']
-                );
-
-                // Update the comment values
-                if ( $result == NULL || $result === false ) {
-                    $values['is_spam'] = '0';
-                } else {
-                    $values['is_spam'] = '1';
-                }
-
-            }
-
-            // Add the comment
-            $result = $this-&gt;_executeInsert( '#_comments', $values );
-            $comment_id = $this-&gt;db-&gt;getLastInsertID();
-
-            // Only update the items table if not spam
-            if ( ! $values['is_spam'] ) {
-                $sql = 'UPDATE #_items SET num_comments = num_comments+1 WHERE id = ' . $this-&gt;str( $values['item_id'] );
-                $this-&gt;db-&gt;executeSql( $sql );
-            }
-
-            // Update the comment
-            $values['id'] = $comment_id;
-
-            // Return the comment id
-            return $values;
-
-        }
-
-        // Update a comment
-        function updateComment( $values ) {
-            return $this-&gt;db-&gt;executeUpdate( '#_comments', $values, 'id = ' . $this-&gt;str( $values['id'] ) );
-        }
-
-        // Update a comment and mark it as spam
-        function updateCommentAsSpam( $comment_id ) {
-
-            // Update the comment
-            $comment = $this-&gt;getCommentById( $comment_id );
-            $comment['is_spam'] = 1;
-            unset( $comment['item_title'] );
-            $this-&gt;updateComment( $comment );
-            $sql = 'UPDATE #_items SET num_comments = num_comments-1 WHERE id = ' . $this-&gt;str( $comment['item_id'] );
-            $this-&gt;db-&gt;executeSql( $sql );
-
-            // Check against akismet if a key is there
-            if ( YDConfig::get( 'akismet_key', '' ) != '' ) {
-
-                // Submit as spam
-                $this-&gt;akismet-&gt;submitSpam(
-                    $comment['comment'], $comment['username'], $comment['useremail'], $comment['userwebsite'],
-                    $comment['userip'], $comment['useragent']
-                );
-
-            }
-
-        }
-
-        // Update a comment and unmark it as spam
-        function updateCommentAsNotSpam( $comment_id ) {
-
-            // Update the comment
-            $comment = $this-&gt;getCommentById( $comment_id );
-            $comment['is_spam'] = 0;
-            unset( $comment['item_title'] );
-            $this-&gt;updateComment( $comment );
-            $sql = 'UPDATE #_items SET num_comments = num_comments+1 WHERE id = ' . $this-&gt;str( $comment['item_id'] );
-            $this-&gt;db-&gt;executeSql( $sql );
-
-            // Check against akismet if a key is there
-            if ( YDConfig::get( 'akismet_key', '' ) != '' ) {
-
-                // Submit as ham
-                $this-&gt;akismet-&gt;submitHam(
-                    $comment['comment'], $comment['username'], $comment['useremail'], $comment['userwebsite'],
-                    $comment['userip'], $comment['useragent']
-                );
-
-            }
-
-        }
-
-        // Delete a comment
-        function deleteComment( $comment_id ) {
-            $comment = $this-&gt;getCommentById( $comment_id );
-            $result = $this-&gt;_deleteFromTableUsingID( '#_comments', $comment_id );
-            if ( ! $comment['is_spam'] ) {
-                $sql = 'UPDATE #_items SET num_comments = num_comments-1 WHERE id = ' . $this-&gt;str( $comment['item_id'] );
-                $this-&gt;db-&gt;executeSql( $sql );
-            }
-            return $result;
-        }
-
-        // Get the comment subscriber list
-        function getCommentSubscribers( $item_id ) {
-            $sql = $this-&gt;_prepareQuery(
-                'SELECT DISTINCT useremail FROM #_comments WHERE item_id = ' . $this-&gt;str( $item_id )
-              . ' AND NOT ISNULL( useremail ) AND useremail &lt;&gt; \'\''
-            );
-            return $this-&gt;db-&gt;getValuesByName( $sql, 'useremail' );
-        }
-
-        // Get the categories
-        function getCategories( $order='title' ) {
-            $result = $this-&gt;_selectFromTable( '#_categories', $order );
-            $sql = $this-&gt;_prepareQuery( 'SELECT category_id, COUNT(*) AS num_items FROM #_items i WHERE is_draft=0 GROUP BY category_id' );
-            $num_items = $this-&gt;db-&gt;getAsAssocArray( $sql, 'category_id', 'num_items' );
-            foreach ( $result as $key=&gt;$val ) {
-                if ( isset( $num_items[ $val['id'] ] ) ) {
-                    $result[ $key ]['num_items'] = $num_items[ $val['id'] ];
-                } else {
-                    $result[ $key ]['num_items'] = '0';
-                }
-            }
-            return $result;
-        }
-
-        // Get the categories as an associative array
-        function getCategoriesAsAssoc( $order='title' ) {
-            $sql = $this-&gt;_prepareQuery( 'SELECT id, title FROM #_categories', $order );
-            return $this-&gt;db-&gt;getAsAssocArray( $sql, 'id', 'title' );
-        }
-
-        // Get a category by it's ID
-        function getCategoryById( $category_id ) {
-            return $this-&gt;_selectFromTableUsingID( '#_categories', $category_id );
-        }
-
-        // Get a category by it's name
-        function getCategoryByName( $name ) {
-            $sql = $this-&gt;_prepareQuery( 'SELECT * FROM #_categories WHERE title = ' . $this-&gt;str( $name ) );
-            return $this-&gt;db-&gt;getRecord( $sql );
-        }
-
-        // Get the items by category
-        function getItemsByCategoryId( $category_id, $limit=-1, $offset=-1, $order='created desc, title' ) {
-            return $this-&gt;getItems( $limit, $offset, $order, 'AND is_draft = 0 AND i.category_id = ' . $this-&gt;str( $category_id ) );
-        }
-
-        // Add a category
-        function addCategory( $values ) {
-            return $this-&gt;_executeInsert( '#_categories', $values );
-        }
-
-        // Update a category
-        function updateCategory( $values ) {
-            return $this-&gt;db-&gt;executeUpdate( '#_categories', $values, 'id = ' . $this-&gt;str( $values['id'] ) );
-        }
-
-        // Delete a category
-        function deleteCategory( $category_id ) {
-            return $this-&gt;_deleteFromTableUsingID( '#_categories', $category_id );
-        }
-
-        // Get the public pages
-        function getPublicPages( $order='title', $where=' AND p.is_draft=0' ) {
-            return $this-&gt;getPages( $order, $where );
-        }
-
-        // Get the pages
-        function getPages( $order='title', $where='' ) {
-            $sql = $this-&gt;_prepareQuery(
-                'SELECT p.id, p.title, p.body, p.is_draft, p.created, p.modified, u.email as user_email, u.name as user_name '
-              . 'FROM #_pages p, #_users u WHERE p.user_id = u.id'
-            );
-            if ( ! empty( $where ) ) {
-                $sql .= ' ' . $where;
-            }
-            return $this-&gt;db-&gt;getRecords( $sql );
-        }
-
-        // Get a public page by it's ID
-        function getPublicPageByID( $page_id, $where=' AND p.is_draft=0' ) {
-            return $this-&gt;getPageByID( $page_id, $where );
-        }
-
-        // Get a page by it's ID
-        function getPageByID( $page_id, $where='' ) {
-            $sql = $this-&gt;_prepareQuery(
-                'SELECT p.id, p.title, p.body, p.is_draft, p.created, p.modified, u.email as user_email, u.name as user_name FROM '
-                . '#_pages p, #_users u WHERE p.user_id = u.id AND p.id = ' . $this-&gt;str( $page_id )
-            );
-            if ( ! empty( $where ) ) {
-                $sql .= ' ' . $where;
-            }
-            return $this-&gt;db-&gt;getRecord( $sql );
-        }
-
-        // Add a page
-        function addPage( $values ) {
-            return $this-&gt;_executeInsert( '#_pages', $values );
-        }
-
-        // Update a page
-        function updatePage( $values ) {
-            unset( $values['user_id'] );
-            return $this-&gt;db-&gt;executeUpdate( '#_pages', $values, 'id = ' . $this-&gt;str( $values['id'] ) );
-        }
-
-        // Delete a page
-        function deletePage( $page_id ) {
-            return $this-&gt;_deleteFromTableUsingID( '#_pages', $page_id );
-        }
-
-        // Get the links
-        function getLinks( $order='title' ) {
-            return $this-&gt;_selectFromTable( '#_links', $order );
-        }
-
-        // Get a link by it's ID
-        function getLinkByID( $link_id ) {
-            return $this-&gt;_selectFromTableUsingID( '#_links', $link_id );
-        }
-
-        // Get a link by it's url
-        function getLinkByUrl( $url ) {
-            $sql = $this-&gt;_prepareQuery( 'SELECT * FROM #_links WHERE url = ' . $this-&gt;str( $url ) );
-            return $this-&gt;db-&gt;getRecord( $sql );
-        }
-
-        // Add a link
-        function addLink( $values ) {
-            return $this-&gt;_executeInsert( '#_links', $values );
-        }
-
-        // Update a link
-        function updateLink( $values ) {
-            return $this-&gt;db-&gt;executeUpdate( '#_links', $values, 'id = ' . $this-&gt;str( $values['id'] ) );
-        }
-
-        // Delete a link
-        function deleteLink( $link_id ) {
-            return $this-&gt;_deleteFromTableUsingID( '#_links', $link_id );
-        }
-
-        // Function to increase the link num_visits
-        function updateLinkNumVisits( $link_id ) {
-            $sql = 'UPDATE #_links SET num_visits = num_visits+1 WHERE id = ' . $this-&gt;str( $link_id );
-            $this-&gt;db-&gt;executeSql( $sql );
-        }
-
-        // Check the user login
-        function checkLogin( $user, $password ) {
-            return $this-&gt;db-&gt;getRecord(
-                'SELECT * FROM #_users WHERE name = ' . $this-&gt;str( $user ) . ' AND password = ' . $this-&gt;str( $password )
-            );
-        }
-
-        // Get the number of items
-        function getStatsItemCount() {
-            return $this-&gt;db-&gt;getValue( 'SELECT count(*) FROM #_items' );
-        }
-
-        // Get the number of comments
-        function getStatsCommentCount() {
-            return $this-&gt;db-&gt;getValue( 'SELECT count(*) FROM #_comments' );
-        }
-
-        // Get the commenter statistics
-        function getCommenterStats( $limit=10 ) {
-            return $this-&gt;db-&gt;getRecords(
-                'SELECT username, count(*) as hits FROM #_comments GROUP BY username ORDER BY hits DESC', $limit
-            );
-        }
-
-        // Get the list of users
-        function getUsers( $order='name' ) {
-            $sql = $this-&gt;_prepareQuery( 'SELECT * FROM #_users', $order );
-            return $this-&gt;db-&gt;getRecords( $sql );
-        }
-
-        // Function to get a user by it's ID
-        function getUserByID( $user_id ) {
-            return $this-&gt;_selectFromTableUsingID( '#_users', $user_id );
-        }
-
-        // Function to get a user by his name
-        function getUserByName( $user_name ) {
-            $sql = 'SELECT * FROM #_users WHERE LOWER( name ) = ' . $this-&gt;str( strtolower( $user_name ) );
-            return $this-&gt;db-&gt;getRecord( $sql );
-        }
-
-        // Replace the user with another one
-        function replaceUser( $old, $new ) {
-            $sql = 'UPDATE #_items SET user_id = ' . $this-&gt;str( $new ) . ' WHERE user_id = ' . $this-&gt;str( $old );
-            $this-&gt;db-&gt;executeSql( $sql );
-            $sql = 'UPDATE #_pages SET user_id = ' . $this-&gt;str( $new ) . ' WHERE user_id = ' . $this-&gt;str( $old );
-            $this-&gt;db-&gt;executeSql( $sql );
-        }
-
-        // Function to save a user
-        function saveUser( $user ) {
-
-            // Unset the submit value
-            unset( $user['cmdSubmit'] );
-
-            // Convert the password to md5
-            if ( ! empty( $user['password'] ) ) {
-                $user['password'] = md5( $user['password'] );
-            } else {
-                unset( $user['password'] );
-            }
-
-            // Check if we need to update or insert
-            if ( empty( $user['id'] ) ) {
-                $user['created']= time();
-                $user['modified'] = time();
-                unset( $user['id'] );
-                return $this-&gt;db-&gt;executeInsert( '#_users', $user );
-            } else {
-                if ( empty( $user['created'] ) ) {
-                    $user['created']= time();
-                }
-                $user['modified'] = time();
-                unset( $user['name'] );
-                return $this-&gt;db-&gt;executeUpdate( '#_users', $user, 'id = ' . $this-&gt;str( $user['id'] ) );
-            }
-
-        }
-
-        // Delete a user from the database
-        function deleteUser( $user_id ) {
-            $sql = 'DELETE FROM #_users WHERE id = ' . $this-&gt;str( $user_id );
-            $this-&gt;db-&gt;executeSql( $sql );
-        }
-
-        // Check if we are in the spam_check table, which means we have a spam attack
-        function inSpamAttack() {
-            $comment_interval = YDConfig::get( 'comment_interval', 10 );
-            if ( $comment_interval != '' &amp;&amp; is_numeric( $comment_interval ) ) {
-                $sql = 'SELECT * FROM #_spamcheck WHERE userip = ' . $this-&gt;str( $_SERVER['REMOTE_ADDR'] );
-                return $this-&gt;db-&gt;getRecord( $sql );
-            }
-        }
-
-        // Mark ourselves in the spam check table
-        function spamCheckMark() {
-            $comment_interval = YDConfig::get( 'comment_interval', 10 );
-            if ( $comment_interval != '' &amp;&amp; is_numeric( $comment_interval ) ) {
-                $values = array( 'userip' =&gt; $_SERVER['REMOTE_ADDR'], 'lastvisit' =&gt; time() );
-                $this-&gt;db-&gt;executeInsert( '#_spamcheck', $values );
-            }
-        }
-
-        // Delete the spam comments
-        function emptySpam() {
-            $sql = 'DELETE FROM #_comments WHERE is_spam = 1';
-            $this-&gt;db-&gt;executeSql( $sql );
-        }
-
-        // Function to resize an uploaded image. Takes a YDFSImage object as it's argument
-        function resizeUploadedImage( $image ) {
-
-            // Convert the YDFSFile objects to images
-            if ( is_object( $image ) &amp;&amp; strtolower( get_class( $image ) ) == 'ydfsfile' ) {
-                $image = new YDFSImage( $image-&gt;getAbsolutePath() );
-            }
-
-            // Convert strings to images
-            if ( is_string( $image ) ) {
-                $image = new YDFSImage( $image );
-            }
-
-            // Get the maximum X and Y size
-            $max_x = YDConfig::get( 'max_img_size_x', '' );
-            $max_y = YDConfig::get( 'max_img_size_y', '' );
-            $max_x = empty( $max_x ) ? 999999 : $max_x;
-            $max_y = empty( $max_y ) ? 999999 : $max_y;
-
-            // Do nothing if maximum sizes are specified
-            if ( $max_x == 99999 &amp;&amp; $max_y == 999999 ) {
-                return $image;
-            }
-
-            // Resize the image
-            $image-&gt;saveThumbnail( $max_x, $max_y, $image-&gt;getAbsolutePath() );
-
-            // Return the image
-            return $image;
-
-        }
-
-        // Prepare a query
-        function _prepareQuery( $sql, $order=null ) {
-            return is_null( $order ) ? $sql : $sql . ' ORDER BY ' . $order;
-        }
-
-        // Execute an insert
-        function _executeInsert( $table, $values ) {
-            if ( @ empty( $values['created'] ) ) {
-                $values['created'] = time();
-            }
-            if ( @ empty( $values['modified'] ) ) {
-                $values['modified'] = time();
-            }
-            foreach ( $values as $key=&gt;$val ) {
-                if ( substr( $key, 0, 3 ) == 'cmd' ) {
-                    unset( $values[$key] );
-                }
-            }
-            return $this-&gt;db-&gt;executeInsert( $table, $values );
-        }
-
-        // Execute an update
-        function _executeUpdate( $table, $values, $where ) {
-            if ( @ empty( $values['created'] ) ) {
-                $values['created'] = time();
-            }
-            $values['modified'] = time();
-            foreach ( $values as $key=&gt;$val ) {
-                if ( substr( $key, 0, 3 ) == 'cmd' ) {
-                    unset( $values[$key] );
-                }
-            }
-            return $this-&gt;db-&gt;executeUpdate( $table, $values, $where );
-        }
-
-        // Select items from a table with a given table name
-        function _selectFromTable( $table, $order=null, $limit=-1, $offset=-1 ) {
-            $sql = $this-&gt;_prepareQuery( 'SELECT * FROM ' . $table, $order, $limit, $offset );
-            return $this-&gt;db-&gt;getRecords( $sql );
-         }
-
-        // Select items from a table with a given id
-        function _selectFromTableUsingID( $table, $id ) {
-            $sql = $this-&gt;_prepareQuery( 'SELECT * FROM ' . $table . ' WHERE id = ' . $this-&gt;str( $id ) );
-            return $this-&gt;db-&gt;getRecord( $sql );
-        }
-
-        // Delete items from a table with a given id
-        function _deleteFromTableUsingID( $table, $id ) {
-            $sql = $this-&gt;_prepareQuery( 'DELETE FROM ' . $table . ' WHERE id = ' . $this-&gt;str( $id ) );
-            return $this-&gt;db-&gt;executeSql( $sql );
-        }
-
-        // Escapes a string
-        function str( $t ) {
-            return '\''. $this-&gt;db-&gt;escape( $t ) . '\'';
-        }
-
-        // Get a translation from the translation table
-        function t( $t ) {
-            return YDTplModT( array( 'w' =&gt; $t ) );
-        }
-
-    }
-
-?&gt;
+&lt;?php
+
+    // Function to save the configuration
+    function YDWeblogSaveConfig( $values ) {
+
+        // Remove some unneeded values
+        unset( $values['name'] );
+        unset( $values['email'] );
+        unset( $values['password'] );
+
+        // Add some default ones
+        if ( ! isset( $values['weblog_entries_fp'] ) ) {
+            $values['weblog_entries_fp'] = 5;
+        }
+        if ( ! isset( $values['email_new_comment'] ) ) {
+            $values['email_new_comment'] = true;
+        }
+        if ( ! isset( $values['use_cache'] ) ) {
+            $values['use_cache'] = false;
+        }
+        if ( ! isset( $values['max_syndicated_items'] ) ) {
+            $values['max_syndicated_items'] = 20;
+        }
+        if ( ! isset( $values['include_debug_info'] ) ) {
+            $values['include_debug_info'] = 0;
+        }
+        if ( ! isset( $values['dflt_is_draft'] ) ) {
+            $values['dflt_is_draft'] = false;
+        }
+        if ( empty( $values['db_pass'] ) ) {
+            $values['db_pass'] = YDConfig::get( 'db_pass', '' );
+        }
+
+        // Construct the new config text
+        $cfg = '&lt;?php' . &quot;\n\n&quot;;
+        $cfg .= '    // Do not edit this file manually!' . &quot;\n&quot;;
+        $cfg .= '    // Only edit this file using the admin tools!' . &quot;\n\n&quot;;
+
+        // Loop over the config values
+        foreach ( $values as $key=&gt;$val ) {
+
+            // Ignore items starting with an underscore
+            if ( substr( $key, 0, 1 ) != '_' ) {
+
+                // Escape strings
+                $key = str_replace( &quot;'&quot;, &quot;\\'&quot;, $key );
+                $val = str_replace( &quot;'&quot;, &quot;\\'&quot;, $val );
+
+                // Don't enclose numeric values with quotes
+                if ( is_bool( $val ) ) {
+                    $val = ( $val ) ? 'true' : 'false';
+                    $cfg .= &quot;    YDConfig::set( '&quot; . $key . &quot;', &quot; . $val . &quot; );\n&quot;;
+                } elseif ( is_numeric( $val ) ) {
+                    $cfg .= &quot;    YDConfig::set( '&quot; . $key . &quot;', &quot; . $val . &quot; );\n&quot;;
+                } else {
+                    $cfg .= &quot;    YDConfig::set( '&quot; . $key . &quot;', '&quot; . $val . &quot;' );\n&quot;;
+                }
+            }
+        }
+        $cfg .= &quot;\n&quot; . '?&gt;';
+
+        // Open the config file
+        $f = fopen( dirname( __FILE__ ) . '/config.php', 'w' );
+        fwrite( $f, $cfg );
+        fclose( $f );
+
+        // Set the right permissions
+        //@chmod( dirname( __FILE__ ) . '/config.php', 0700 );
+
+        // Create a .htaccess file if needed
+        $htaccessPath = dirname( dirname( __FILE__ ) ) . '/.htaccess';
+        if ( ! is_file( $htaccessPath ) ) {
+
+            // The htaccess data
+            $data = 'RewriteEngine on' . YD_CRLF;
+            $data .= 'Options +FollowSymlinks' . YD_CRLF;
+            $data .= 'RewriteRule ^item_([0-9]+).php?$ item.php?id=$1 [L]' . YD_CRLF;
+            $data .= 'RewriteRule ^page_([0-9]+).php?$ page.php?id=$1 [L]' . YD_CRLF;
+            $data .= 'RewriteRule ^category_([0-9]+).php?$ category.php?id=$1 [L]' . YD_CRLF;
+            $data .= 'RewriteRule ^link_([0-9]+).php?$ link.php?id=$1 [L]' . YD_CRLF;
+            $data .= 'RewriteRule ^image/(.*) item_gallery.php?id=$1 [L]' . YD_CRLF;
+
+            // Open the config file
+            $f = fopen( $htaccessPath, 'w' );
+            fwrite( $f, $data );
+            fclose( $f );
+
+            // Set the right permissions
+            //@chmod( $htaccessPath, 0700 );
+
+        }
+
+    }
+
+    // Function to format a string with list values
+    function YDFormatStringWithListValues( $string ) {
+        $string = str_replace( ';', ',', $string );
+        $string = explode( ',', $string );
+        foreach ( $string as $k=&gt;$v ) {
+            if ( trim( $v ) == '' ) {
+                unset( $string[$k] );
+            } else {
+                $string[$k] = trim( $v );
+            }
+        }
+        return implode( ', ', $string );
+    }
+
+    // Class defining our weblog API
+    class YDWeblogAPI extends YDBase {
+
+        // Class constructor
+        function YDWeblogAPI() {
+
+            // Initialize the parent
+            $this-&gt;YDBase();
+
+            // Get the database connection
+            $this-&gt;db = YDDatabase::getInstance(
+                'mysql',
+                YDConfig::get( 'db_name', 'YDWeblog' ), YDConfig::get( 'db_user', 'root' ),
+                YDConfig::get( 'db_pass', '' ), YDConfig::get( 'db_host', 'localhost' )
+            );
+
+            // Get a link to the database metadata
+            $this-&gt;dbmeta = new YDDatabaseMetaData( $this-&gt;db );
+
+            // Upgrade the schema if needed
+            $this-&gt;upgradeSchemaIfNeeded();
+
+            // The array that will hold the image metadata
+            $this-&gt;imagemetadata = null;
+
+            // Delete spam comments older than 7 days
+            $sql = 'DELETE FROM #_comments WHERE is_spam = 1 AND created &lt; (unix_timestamp()-604800)';
+            $this-&gt;db-&gt;executeSql( $sql );
+
+            // Delete the old IP numbers from spam check
+            $comment_interval = YDConfig::get( 'comment_interval', 10 );
+            if ( $comment_interval != '' &amp;&amp; is_numeric( $comment_interval ) ) {
+                $sql = 'DELETE FROM #_spamcheck WHERE lastvisit &lt; (unix_timestamp()-' . $comment_interval . ')';
+                $this-&gt;db-&gt;executeSql( $sql );
+            }
+
+            // Check against akismet if a key is there
+            if ( YDConfig::get( 'akismet_key', '' ) != '' ) {
+
+                // Include the YDAkismet addon
+                include_once( YD_DIR_HOME_ADD . '/YDAkismet/YDAkismet.php' );
+
+                // Get the URL of the weblog
+                $weblog_url = dirname( YDRequest::getCurrentUrl( true ) ) . '/';
+
+                // Initialize YDAkismet
+                $this-&gt;akismet = new YDAkismet( $weblog_url, YDConfig::get( 'akismet_key', '' ) );
+
+            } else {
+
+                // No akismet
+                $this-&gt;akismet = null;
+
+            }
+
+        }
+
+        // Get the schema version
+        function getSchemaVersion() {
+
+            // Create the schemaversion table if it doesn't exists
+            if ( ! $this-&gt;dbmeta-&gt;tableExists( '#_schemaversion' ) ) {
+                $sql = 'CREATE TABLE #_schemaversion (installed INT(11), version INT (11))';
+                $this-&gt;db-&gt;executeSql( $sql );
+            }
+
+            // Check the schema version
+            $schema_version = $this-&gt;db-&gt;getValue( 'select version from #_schemaversion order by installed desc, version desc' );
+
+            // Return the schema version
+            return ( $schema_version === false  ) ? 0 : intval( $schema_version );
+
+        }
+
+        // Get the full schema information
+        function getFullSchemaVersion() {
+            $this-&gt;getSchemaVersion();
+            return $this-&gt;db-&gt;getRecord( 'select installed, version from #_schemaversion order by installed desc, version desc' );
+        }
+
+        // Function to set the schema version
+        function setSchemaVersion( $version ) {
+            $values = array();
+            $values['installed'] = time();
+            $values['version'] = $version;
+            $this-&gt;db-&gt;executeInsert( '#_schemaversion', $values );
+        }
+
+        // Upgrade the schema if needed
+        function upgradeSchemaIfNeeded() {
+
+            // The current weblog schema version
+            $current_schema = 7;
+
+            // Get the schema version
+            $installed_schema = $this-&gt;getSchemaVersion();
+
+            // Check if we have the required schema version
+            if ( $installed_schema &lt; $current_schema ) {
+
+                // Add any missing comments fields
+                $fields = $this-&gt;dbmeta-&gt;getFields( '#_comments' );
+                $this-&gt;executeIfMissing( 'useragent', $fields, 'ALTER TABLE #_comments ADD useragent varchar(255) AFTER userip' );
+                $this-&gt;executeIfMissing( 'userrequrl', $fields, 'ALTER TABLE #_comments ADD userrequrl varchar(255) AFTER useragent' );
+                $this-&gt;executeIfMissing( 'is_spam', $fields, 'ALTER TABLE #_comments ADD is_spam TINYINT(1) DEFAULT &quot;0&quot; NOT NULL AFTER comment' );
+
+                // Add any missing items fields
+                $fields = $this-&gt;dbmeta-&gt;getFields( '#_items' );
+                $this-&gt;executeIfMissing( 'body_more', $fields, 'ALTER TABLE #_items ADD body_more LONGTEXT AFTER body' );
+                $this-&gt;executeIfMissing( 'is_draft', $fields, 'ALTER TABLE #_items ADD is_draft TINYINT(1) DEFAULT &quot;0&quot; NOT NULL AFTER num_comments' );
+                $this-&gt;executeIfPresent( 'allow_comments', $fields, 'ALTER TABLE #_items DROP allow_comments' );
+                $this-&gt;executeIfPresent( 'auto_close', $fields, 'ALTER TABLE #_items DROP auto_close' );
+
+                // Add any missing pages field
+                $fields = $this-&gt;dbmeta-&gt;getFields( '#_pages' );
+                $this-&gt;executeIfMissing( 'is_draft', $fields, 'ALTER TABLE #_pages ADD is_draft TINYINT(1) DEFAULT &quot;0&quot; NOT NULL AFTER body' );
+
+                // Get the list of indexes for the items table
+                $indexes = $this-&gt;dbmeta-&gt;getIndexes( '#_items' );
+                $this-&gt;executeIfMissing( 'is_draft', $indexes, 'ALTER TABLE #_items ADD INDEX is_draft (is_draft)' );
+
+                // Get the list of indexes for the pages table
+                $indexes = $this-&gt;dbmeta-&gt;getIndexes( '#_pages' );
+                $this-&gt;executeIfMissing( 'is_draft', $indexes, 'ALTER TABLE #_pages ADD INDEX is_draft (is_draft)' );
+
+                // Get the list of indexes for the users table
+                $indexes = $this-&gt;dbmeta-&gt;getIndexes( '#_users' );
+                $this-&gt;executeIfPresent( 'email', $indexes, 'ALTER TABLE #_users DROP INDEX email' );
+                $this-&gt;executeIfMissing( 'name',  $indexes, 'ALTER TABLE #_users ADD UNIQUE name (name)' );
+
+                // Fix the shemaversion table if needed
+                $this-&gt;db-&gt;executeSql( 'ALTER TABLE #_schemaversion CHANGE installed installed INT(11)' );
+                $this-&gt;db-&gt;executeSql( 'UPDATE #_schemaversion SET installed = unix_timestamp() WHERE installed = 0' );
+
+                // Drop the statistics tables
+                $this-&gt;db-&gt;executeSql( 'DROP TABLE IF EXISTS #_statistics' );
+                $this-&gt;db-&gt;executeSql( 'DROP TABLE IF EXISTS #_statistics_init' );
+
+                // Create the image_metadata table
+                if ( ! $this-&gt;dbmeta-&gt;tableExists( '#_imagemetadata' ) ) {
+                    $this-&gt;db-&gt;executeSql(
+                          'CREATE TABLE #_imagemetadata ('
+                        . '  id int(11) NOT NULL auto_increment,'
+                        . '  img_path varchar(255) NOT NULL default \'\','
+                        . '  title varchar(255) default NULL,'
+                        . '  description longtext,'
+                        . '  created int(11) default NULL,'
+                        . '  modified int(11) default NULL,'
+                        . '  PRIMARY KEY  (id),'
+                        . '  UNIQUE KEY img_path (img_path)'
+                        . ')'
+                    );
+                }
+
+                // Create the spamcheck table
+                if ( ! $this-&gt;dbmeta-&gt;tableExists( '#_spamcheck' ) ) {
+                    $this-&gt;db-&gt;executeSql(
+                          'CREATE TABLE #_spamcheck ('
+                        . '  id int(11) NOT NULL auto_increment,'
+                        . '  userip varchar(20) default NULL,'
+                        . '  lastvisit int(11) default NULL,'
+                        . '  PRIMARY KEY  (id),'
+                        . '  UNIQUE KEY userip (userip)'
+                        . ')'
+                    );
+                }
+
+                // Update the schema information
+                $this-&gt;setSchemaVersion( $current_schema );
+
+            }
+
+        }
+
+        // Function to execute SQL if the item is missing
+        function executeIfMissing( $needle, $haystack, $sql ) {
+            if ( ! in_array( $needle, $haystack ) ) {
+                $this-&gt;db-&gt;executeSql( $sql );
+            }
+        }
+
+        // Function to execute SQL if the item is not missing
+        function executeIfPresent( $needle, $haystack, $sql ) {
+            if ( in_array( $needle, $haystack ) ) {
+                $this-&gt;db-&gt;executeSql( $sql );
+            }
+        }
+
+        // Function to auto add some records to an item
+        function _fixItem( $item, $order='created desc, title' ) {
+
+            // Return false if no item
+            if ( ! $item ) {
+                return $item;
+            }
+
+            // Get the item indexes for the indicated weblog (cached to minimize the number of SQL queries)
+            $cacheName = 'YD_CACHE_WEBLOG_ITEMIDS_' . md5( strtolower( $order ) );
+            if ( ! isset( $GLOBALS[ $cacheName ] ) ) {
+                $sql = $this-&gt;_prepareQuery( 'SELECT id FROM #_items', $order );
+                $item_ids = $this-&gt;db-&gt;getValuesByName( $sql, 'id' );
+                $GLOBALS[ $cacheName ] = $item_ids;
+            }
+
+            // Get the ID of the previous and the next item
+            $pos = array_search( $item['id'], $GLOBALS[ $cacheName ] );
+            $item['newer_id'] = ( $pos == 0 ) ? false : $GLOBALS[ $cacheName ][$pos-1] ;
+            $item['older_id'] = ( $pos == sizeof( $GLOBALS[ $cacheName ] )-1 ) ? false : $GLOBALS[ $cacheName ][$pos+1] ;
+
+            // Add the year, month and yearmonth fields
+            $item['yearmonth'] = ucwords( strftime( '%B %Y', $item['created'] ) );
+            $item['month']     = ucwords( strftime( '%B',    $item['created'] ) );
+            $item['year']      = ucwords( strftime( '%Y',    $item['created'] ) );
+
+            // Get the list of images related to this item
+            $imgPath = dirname( __FILE__ ) . '/../' . YDConfig::get( 'dir_uploads', 'uploads' ) . '/item_' . $item['id'] .'/';
+
+            // Get the list of pictures if any
+            if ( is_dir( $imgPath ) ) {
+
+                // Get a handle to the directory
+                $dir = new YDFSDirectory( dirname( __FILE__ ) . '/../' . YDConfig::get( 'dir_uploads', 'uploads' ) . '/item_' . $item['id'] .'/' );
+
+                // Get the list of files
+                $images = $dir-&gt;getContents( array( '!index.html', '!index.php', '!m_*.*', '!s_*.*' ), null, array( 'YDFSImage' ) );
+
+                // Make the relative path for each file
+                foreach ( $images as $key=&gt;$image ) {
+
+                    // Generate the thumbnails if not there yet
+                    if ( ! is_file( $dir-&gt;getAbsolutePath() . '/s_' . $image-&gt;getBasename() ) ) {
+                        $image-&gt;saveThumbnail( 48, 48, $dir-&gt;getAbsolutePath() . '/s_' . $image-&gt;getBasename() );
+                    }
+                    if ( ! is_file( $dir-&gt;getAbsolutePath() . '/m_' . $image-&gt;getBasename() ) ) {
+                        $image-&gt;saveThumbnail( 100, 100, $dir-&gt;getAbsolutePath() . '/m_' . $image-&gt;getBasename() );
+                    }
+
+                    // Set the relative path
+                    $dir_uploads = dirname( __FILE__ ) . '/../' . YDConfig::get( 'dir_uploads', 'uploads' );
+                    $dir_uploads = new YDFSDirectory( $dir_uploads );
+                    $image-&gt;relative_path = str_replace( $dir_uploads-&gt;getAbsolutePath(), '', $image-&gt;getAbsolutePath() );
+
+                    // Update the backslashes
+                    $image-&gt;relative_path = ltrim( str_replace( '\\', '/', $image-&gt;relative_path ), '/' );
+
+                    // Merge the title and description if any
+                    $image = $this-&gt;getItemImageMetaData( $image );
+
+                    // Create the full title, including item title, image title and description if any
+                    $image-&gt;full_description = $item['title'] . ' &raquo; ' . $image-&gt;title;
+                    if ( $image-&gt;description ) {
+                        $image-&gt;full_description .= '&lt;p class=&quot;img_description&quot;&gt;'
+                                                 . YDTemplate_modifier_bbcode( $image-&gt;description ) . '&lt;/p&gt;';
+                    }
+                    $image-&gt;full_description_html = htmlspecialchars( $image-&gt;full_description, ENT_QUOTES );
+
+                    // Make links to the thumbnails
+                    $image-&gt;relative_path_s = dirname( $image-&gt;relative_path ) . '/s_' . basename( $image-&gt;relative_path );
+                    $image-&gt;relative_path_m = dirname( $image-&gt;relative_path ) . '/m_' . basename( $image-&gt;relative_path );
+
+                    // Add the thumbnails as objects
+                    $image-&gt;relative_path_s_obj = new YDFSImage( $dir_uploads-&gt;getAbsolutePath() . '/' . $image-&gt;relative_path_s );
+                    $image-&gt;relative_path_m_obj = new YDFSImage( $dir_uploads-&gt;getAbsolutePath() . '/' . $image-&gt;relative_path_m );
+
+                    // Update the original image
+                    $images[$key] = $image;
+
+                }
+
+                // Add it to the item
+                $item['images'] = $images;
+
+            } else {
+
+                // No images for this item
+                $item['images'] = array();
+
+            }
+
+            // Fix the image paths
+            if( strtolower( basename( dirname( YD_SELF_FILE ) ) ) != 'manage' ) {
+                $uploads = YDConfig::get( 'dir_uploads', 'uploads' );
+                $item['body'] = str_replace( '../' . $uploads, $uploads, $item['body'] );
+                $item['body_more'] = str_replace( '../' . $uploads, $uploads, $item['body_more'] );
+            }
+
+            // Get the count of images
+            $item['num_images'] = sizeof( $item['images'] );
+
+            // Return the fixed item
+            return $item;
+
+        }
+
+        // Fix a list of items
+        function _fixItems( $items, $order='created desc, title' ) {
+            foreach ( $items as $key=&gt;$item ) {
+                $items[$key] = $this-&gt;_fixItem( $item, $order );
+            }
+            return $items;
+        }
+
+        // Function to initialize image metadata
+        function initImageMetaData() {
+
+            // Get the image metadata if not there yet
+            if ( is_null( $this-&gt;imagemetadata ) ) {
+                $this-&gt;imagemetadata = $this-&gt;db-&gt;getRecords( 'SELECT * FROM #_imagemetadata' );
+                $this-&gt;imagemetadata = YDArrayUtil::convertToNested( $this-&gt;imagemetadata, 'img_path' );
+                foreach ( $this-&gt;imagemetadata as $key=&gt;$val ) {
+                    $this-&gt;imagemetadata[$key] = $val[0];
+                }
+            }
+
+        }
+
+        // Get the title and description for an item image
+        function getItemImageMetaData( $image ) {
+
+            // Initialize the image data
+            $this-&gt;initImageMetaData();
+
+            // Start with the default settings
+            $image-&gt;title = $image-&gt;getBasenameNoExt();
+            $image-&gt;description = '';
+
+            // Add the image data if any
+            if ( isset( $this-&gt;imagemetadata[ $image-&gt;relative_path ] ) ) {
+                $image-&gt;title = $this-&gt;imagemetadata[ $image-&gt;relative_path ]['title'];
+                $image-&gt;description = $this-&gt;imagemetadata[ $image-&gt;relative_path ]['description'];
+            }
+
+            // Return the image metadata
+            return $image;
+
+        }
+
+        // Update the image data for an item in the database
+        function setItemImageMetaData( $item, $data ) {
+            $values = $data;
+            $values['img_path'] = $item;
+            $result = $this-&gt;_executeUpdate( '#_imagemetadata', $values, 'img_path = ' . $this-&gt;str( $item ) );
+            if ( $result == '0' ) {
+                $result = $this-&gt;_executeInsert( '#_imagemetadata', $values );
+            }
+            return $result;
+        }
+
+        // Function to delete the image data for an item in the database
+        function removeImageMetaData( $image ) {
+            $sql = 'DELETE FROM #_imagemetadata WHERE img_path = ' . $this-&gt;str( $image );
+            return $this-&gt;db-&gt;executeSql( $sql );
+        }
+
+        // Function to get a single item
+        function getItem( $where ) {
+            $result = $this-&gt;getItems( 1, 0, 'created desc, title', $where );
+            return ( $result &amp;&amp; sizeof( $result ) == 1 ) ? $result[0] : $result;
+        }
+
+        // Get the non draft items
+        function getPublicItems( $limit=-1, $offset=-1, $order='created desc, title', $where='AND is_draft = 0' ) {
+            return $this-&gt;getItems( $limit, $offset, $order, $where );
+        }
+
+        // Function to get the items of the weblog
+        function getItems( $limit=-1, $offset=-1, $order='created desc, title', $where='' ) {
+            $sql = 'SELECT i.id, i.category_id, i.title, i.body, i.body_more, i.num_comments, i.created, i.modified, '
+                 . 'i.is_draft, '
+                 . 'c.title as category, u.email as user_email, u.name as user_name FROM #_items i, #_categories c, '
+                 . '#_users u WHERE i.category_id = c.id AND i.user_id = u.id ';
+            $sql = $this-&gt;_prepareQuery( $sql . $where, $order );
+            return $this-&gt;_fixItems( $this-&gt;db-&gt;getRecords( $sql, $limit, $offset ) );
+        }
+
+        // Get related items
+        function getRelatedItemsByItem( $limit, $item ) {
+
+            // Get the items from the same category
+            $items = $this-&gt;getItems(
+                -1, -1, 'created desc, title', 'AND is_draft = 0 AND i.category_id = '
+              . $this-&gt;str( $item['category_id'] ) . ' and i.id &lt;&gt; ' . $this-&gt;str( $item['id'] )
+            );
+
+            // Shuffle the items
+            shuffle( $items );
+
+            // Get the right rows
+            $items = array_slice( $items, 0, $limit );
+
+            // Sort them by date
+            $sorted = array();
+            foreach ( $items as $key=&gt;$item ) {
+                $sorted[ $key ] = intval( $item['created'] );
+            }
+            sort( $sorted );
+
+            // Rearrange the array
+            $sorted_items = array();
+            foreach ( $sorted as $key=&gt;$date ) {
+                array_push( $sorted_items, $items[ $key ] );
+            }
+
+            // Return the items
+            return array_values( $sorted_items );
+
+        }
+
+        // Get a publc item by it's ID
+        function getPublicItemByID( $item_id ) {
+            return $this-&gt;getItem( 'AND is_draft = 0 AND i.id = ' . $this-&gt;str( $item_id ) );
+        }
+
+        // Get an item by it's ID
+        function getItemById( $item_id ) {
+            return $this-&gt;getItem( 'AND i.id = ' . $this-&gt;str( $item_id ) );
+        }
+
+        // Add an item
+        function addItem( $values ) {
+            return $this-&gt;_executeInsert( '#_items', $values );
+        }
+
+        // Update an item
+        function updateItem( $values ) {
+            unset( $values['user_id'] );
+            return $this-&gt;db-&gt;executeUpdate( '#_items', $values, 'id = ' . $this-&gt;str( $values['id'] ) );
+        }
+
+        // Delete an item
+        function deleteItem( $item_id ) {
+            $sql = $this-&gt;_prepareQuery( 'DELETE FROM #_comments WHERE item_id = ' . $this-&gt;str( $item_id ) );
+            $this-&gt;db-&gt;executeSql( $sql );
+            return $this-&gt;_deleteFromTableUsingID( '#_items', $item_id );
+        }
+
+        // Get the comments for an item
+        function getComments( $item_id=null, $order='created', $limit=-1, $offset=-1, $public_only=false, $spam_only=false ) {
+            $query = 'SELECT c.id as id, c.item_id as item_id, c.username as username, c.useremail as useremail, c.userwebsite as userwebsite, c.userip as userip, c.useragent as useragent, c.userrequrl as userrequrl, c.comment as comment, c.is_spam as is_spam, c.created as created, c.modified as modified, i.title as item_title, i.is_draft as item_is_draft FROM #_comments c, #_items i WHERE c.item_id = i.id';
+            if ( $item_id ) {
+                $query .= ' and item_id = ' . $this-&gt;str( $item_id );
+            }
+            if ( $public_only == true ) {
+                $query .= ' and i.is_draft = 0';
+            }
+            if ( $spam_only == true ) {
+                $query .= ' and c.is_spam = 1';
+            } else {
+                $query .= ' and c.is_spam = 0';
+            }
+            $records = $this-&gt;db-&gt;getRecords( $this-&gt;_prepareQuery( $query, $order ), $limit, $offset );
+            foreach ( $records as $key=&gt;$record ) {
+                $records[$key]['comment'] = trim( $record['comment'] );
+            }
+            return $records;
+        }
+
+        // Get duplicate comments based on the current values
+        function isDuplicateComment( $values ) {
+            $values['comment'] = trim( strtolower( $values['comment'] ) );
+            $values['username'] = trim( strtolower( $values['username'] ) );
+            $sql = 'SELECT COUNT(*) AS comment_count FROM #_comments WHERE item_id = ' . $this-&gt;str( $values['item_id'] )
+                 . ' AND TRIM( LOWER( username ) ) = ' . $this-&gt;str( $values['username'] )
+                 . ' AND TRIM( LOWER( comment ) ) = ' . $this-&gt;str( $values['comment'] );
+            $result = intval( $this-&gt;db-&gt;getValueByName( $sql, 'comment_count' ) );
+            return ( $result &gt; 0 );
+        }
+
+        // Get a comment by it's ID
+        function getCommentById( $comment_id ) {
+            $sql = $this-&gt;_prepareQuery( 'SELECT c.id as id, c.item_id as item_id, c.username as username, c.useremail as useremail, c.userwebsite as userwebsite, c.userip as userip, c.useragent as useragent, c.userrequrl as userrequrl, c.comment as comment, c.is_spam as is_spam, c.created as created, c.modified as modified, i.title as item_title FROM #_comments c, #_items i WHERE c.item_id = i.id and c.id = ' . $this-&gt;str( $comment_id ) );
+            $record  = $this-&gt;db-&gt;getRecord( $sql );
+            $record['comment'] = trim( $record['comment'] );
+            return $record;
+        }
+
+        // Add a comment
+        function addComment( $values ) {
+
+            // Update the values
+            $values['userip'] = $_SERVER['REMOTE_ADDR'];
+            $values['useragent'] = $_SERVER['HTTP_USER_AGENT'];
+            $values['userrequrl'] = $_SERVER['REQUEST_URI'];
+            $values['is_spam'] = '0';
+
+            // Check against akismet if a key is there
+            if ( YDConfig::get( 'akismet_key', '' ) != '' ) {
+
+                // Check if it's spam or not
+                $result = $this-&gt;akismet-&gt;checkComment(
+                    $values['comment'], $values['username'], $values['useremail'], $values['userwebsite'],
+                    $values['userip'], $values['useragent']
+                );
+
+                // Update the comment values
+                if ( $result == NULL || $result === false ) {
+                    $values['is_spam'] = '0';
+                } else {
+                    $values['is_spam'] = '1';
+                }
+
+            }
+
+            // Safe the HTML from the comment
+            $values['comment'] = YDFormFilter_safe_html( $values['comment'] );
+
+            // Add the comment
+            $result = $this-&gt;_executeInsert( '#_comments', $values );
+            $comment_id = $this-&gt;db-&gt;getLastInsertID();
+
+            // Only update the items table if not spam
+            if ( ! $values['is_spam'] ) {
+                $sql = 'UPDATE #_items SET num_comments = num_comments+1 WHERE id = ' . $this-&gt;str( $values['item_id'] );
+                $this-&gt;db-&gt;executeSql( $sql );
+            }
+
+            // Update the comment
+            $values['id'] = $comment_id;
+
+            // Return the comment id
+            return $values;
+
+        }
+
+        // Update a comment
+        function updateComment( $values ) {
+            $values['comment'] = YDFormFilter_safe_html( $values['comment'] );
+            return $this-&gt;db-&gt;executeUpdate( '#_comments', $values, 'id = ' . $this-&gt;str( $values['id'] ) );
+        }
+
+        // Update a comment and mark it as spam
+        function updateCommentAsSpam( $comment_id ) {
+
+            // Update the comment
+            $comment = $this-&gt;getCommentById( $comment_id );
+            $comment['is_spam'] = 1;
+            unset( $comment['item_title'] );
+            $this-&gt;updateComment( $comment );
+            $sql = 'UPDATE #_items SET num_comments = num_comments-1 WHERE id = ' . $this-&gt;str( $comment['item_id'] );
+            $this-&gt;db-&gt;executeSql( $sql );
+
+            // Check against akismet if a key is there
+            if ( YDConfig::get( 'akismet_key', '' ) != '' ) {
+
+                // Submit as spam
+                $this-&gt;akismet-&gt;submitSpam(
+                    $comment['comment'], $comment['username'], $comment['useremail'], $comment['userwebsite'],
+                    $comment['userip'], $comment['useragent']
+                );
+
+            }
+
+        }
+
+        // Update a comment and unmark it as spam
+        function updateCommentAsNotSpam( $comment_id ) {
+
+            // Update the comment
+            $comment = $this-&gt;getCommentById( $comment_id );
+            $comment['is_spam'] = 0;
+            unset( $comment['item_title'] );
+            $this-&gt;updateComment( $comment );
+            $sql = 'UPDATE #_items SET num_comments = num_comments+1 WHERE id = ' . $this-&gt;str( $comment['item_id'] );
+            $this-&gt;db-&gt;executeSql( $sql );
+
+            // Check against akismet if a key is there
+            if ( YDConfig::get( 'akismet_key', '' ) != '' ) {
+
+                // Submit as ham
+                $this-&gt;akismet-&gt;submitHam(
+                    $comment['comment'], $comment['username'], $comment['useremail'], $comment['userwebsite'],
+                    $comment['userip'], $comment['useragent']
+                );
+
+            }
+
+        }
+
+        // Delete a comment
+        function deleteComment( $comment_id ) {
+            $comment = $this-&gt;getCommentById( $comment_id );
+            $result = $this-&gt;_deleteFromTableUsingID( '#_comments', $comment_id );
+            if ( ! $comment['is_spam'] ) {
+                $sql = 'UPDATE #_items SET num_comments = num_comments-1 WHERE id = ' . $this-&gt;str( $comment['item_id'] );
+                $this-&gt;db-&gt;executeSql( $sql );
+            }
+            return $result;
+        }
+
+        // Get the comment subscriber list
+        function getCommentSubscribers( $item_id ) {
+            $sql = $this-&gt;_prepareQuery(
+                'SELECT DISTINCT useremail FROM #_comments WHERE item_id = ' . $this-&gt;str( $item_id )
+              . ' AND NOT ISNULL( useremail ) AND useremail &lt;&gt; \'\''
+            );
+            return $this-&gt;db-&gt;getValuesByName( $sql, 'useremail' );
+        }
+
+        // Get the categories
+        function getCategories( $order='title' ) {
+            $result = $this-&gt;_selectFromTable( '#_categories', $order );
+            $sql = $this-&gt;_prepareQuery( 'SELECT category_id, COUNT(*) AS num_items FROM #_items i WHERE is_draft=0 GROUP BY category_id' );
+            $num_items = $this-&gt;db-&gt;getAsAssocArray( $sql, 'category_id', 'num_items' );
+            foreach ( $result as $key=&gt;$val ) {
+                if ( isset( $num_items[ $val['id'] ] ) ) {
+                    $result[ $key ]['num_items'] = $num_items[ $val['id'] ];
+                } else {
+                    $result[ $key ]['num_items'] = '0';
+                }
+            }
+            return $result;
+        }
+
+        // Get the categories as an associative array
+        function getCategoriesAsAssoc( $order='title' ) {
+            $sql = $this-&gt;_prepareQuery( 'SELECT id, title FROM #_categories', $order );
+            return $this-&gt;db-&gt;getAsAssocArray( $sql, 'id', 'title' );
+        }
+
+        // Get a category by it's ID
+        function getCategoryById( $category_id ) {
+            return $this-&gt;_selectFromTableUsingID( '#_categories', $category_id );
+        }
+
+        // Get a category by it's name
+        function getCategoryByName( $name ) {
+            $sql = $this-&gt;_prepareQuery( 'SELECT * FROM #_categories WHERE title = ' . $this-&gt;str( $name ) );
+            return $this-&gt;db-&gt;getRecord( $sql );
+        }
+
+        // Get the items by category
+        function getItemsByCategoryId( $category_id, $limit=-1, $offset=-1, $order='created desc, title' ) {
+            return $this-&gt;getItems( $limit, $offset, $order, 'AND is_draft = 0 AND i.category_id = ' . $this-&gt;str( $category_id ) );
+        }
+
+        // Add a category
+        function addCategory( $values ) {
+            return $this-&gt;_executeInsert( '#_categories', $values );
+        }
+
+        // Update a category
+        function updateCategory( $values ) {
+            return $this-&gt;db-&gt;executeUpdate( '#_categories', $values, 'id = ' . $this-&gt;str( $values['id'] ) );
+        }
+
+        // Delete a category
+        function deleteCategory( $category_id ) {
+            return $this-&gt;_deleteFromTableUsingID( '#_categories', $category_id );
+        }
+
+        // Get the public pages
+        function getPublicPages( $order='title', $where=' AND p.is_draft=0' ) {
+            return $this-&gt;getPages( $order, $where );
+        }
+
+        // Get the pages
+        function getPages( $order='title', $where='' ) {
+            $sql = $this-&gt;_prepareQuery(
+                'SELECT p.id, p.title, p.body, p.is_draft, p.created, p.modified, u.email as user_email, u.name as user_name '
+              . 'FROM #_pages p, #_users u WHERE p.user_id = u.id'
+            );
+            if ( ! empty( $where ) ) {
+                $sql .= ' ' . $where;
+            }
+            return $this-&gt;db-&gt;getRecords( $sql );
+        }
+
+        // Get a public page by it's ID
+        function getPublicPageByID( $page_id, $where=' AND p.is_draft=0' ) {
+            return $this-&gt;getPageByID( $page_id, $where );
+        }
+
+        // Get a page by it's ID
+        function getPageByID( $page_id, $where='' ) {
+            $sql = $this-&gt;_prepareQuery(
+                'SELECT p.id, p.title, p.body, p.is_draft, p.created, p.modified, u.email as user_email, u.name as user_name FROM '
+                . '#_pages p, #_users u WHERE p.user_id = u.id AND p.id = ' . $this-&gt;str( $page_id )
+            );
+            if ( ! empty( $where ) ) {
+                $sql .= ' ' . $where;
+            }
+            return $this-&gt;db-&gt;getRecord( $sql );
+        }
+
+        // Add a page
+        function addPage( $values ) {
+            return $this-&gt;_executeInsert( '#_pages', $values );
+        }
+
+        // Update a page
+        function updatePage( $values ) {
+            unset( $values['user_id'] );
+            return $this-&gt;db-&gt;executeUpdate( '#_pages', $values, 'id = ' . $this-&gt;str( $values['id'] ) );
+        }
+
+        // Delete a page
+        function deletePage( $page_id ) {
+            return $this-&gt;_deleteFromTableUsingID( '#_pages', $page_id );
+        }
+
+        // Get the links
+        function getLinks( $order='title' ) {
+            return $this-&gt;_selectFromTable( '#_links', $order );
+        }
+
+        // Get a link by it's ID
+        function getLinkByID( $link_id ) {
+            return $this-&gt;_selectFromTableUsingID( '#_links', $link_id );
+        }
+
+        // Get a link by it's url
+        function getLinkByUrl( $url ) {
+            $sql = $this-&gt;_prepareQuery( 'SELECT * FROM #_links WHERE url = ' . $this-&gt;str( $url ) );
+            return $this-&gt;db-&gt;getRecord( $sql );
+        }
+
+        // Add a link
+        function addLink( $values ) {
+            return $this-&gt;_executeInsert( '#_links', $values );
+        }
+
+        // Update a link
+        function updateLink( $values ) {
+            return $this-&gt;db-&gt;executeUpdate( '#_links', $values, 'id = ' . $this-&gt;str( $values['id'] ) );
+        }
+
+        // Delete a link
+        function deleteLink( $link_id ) {
+            return $this-&gt;_deleteFromTableUsingID( '#_links', $link_id );
+        }
+
+        // Function to increase the link num_visits
+        function updateLinkNumVisits( $link_id ) {
+            $sql = 'UPDATE #_links SET num_visits = num_visits+1 WHERE id = ' . $this-&gt;str( $link_id );
+            $this-&gt;db-&gt;executeSql( $sql );
+        }
+
+        // Check the user login
+        function checkLogin( $user, $password ) {
+            return $this-&gt;db-&gt;getRecord(
+                'SELECT * FROM #_users WHERE name = ' . $this-&gt;str( $user ) . ' AND password = ' . $this-&gt;str( $password )
+            );
+        }
+
+        // Get the number of items
+        function getStatsItemCount() {
+            return $this-&gt;db-&gt;getValue( 'SELECT count(*) FROM #_items' );
+        }
+
+        // Get the number of comments
+        function getStatsCommentCount() {
+            return $this-&gt;db-&gt;getValue( 'SELECT count(*) FROM #_comments' );
+        }
+
+        // Get the commenter statistics
+        function getCommenterStats( $limit=10 ) {
+            return $this-&gt;db-&gt;getRecords(
+                'SELECT username, count(*) as hits FROM #_comments GROUP BY username ORDER BY hits DESC', $limit
+            );
+        }
+
+        // Get the list of users
+        function getUsers( $order='name' ) {
+            $sql = $this-&gt;_prepareQuery( 'SELECT * FROM #_users', $order );
+            return $this-&gt;db-&gt;getRecords( $sql );
+        }
+
+        // Function to get a user by it's ID
+        function getUserByID( $user_id ) {
+            return $this-&gt;_selectFromTableUsingID( '#_users', $user_id );
+        }
+
+        // Function to get a user by his name
+        function getUserByName( $user_name ) {
+            $sql = 'SELECT * FROM #_users WHERE LOWER( name ) = ' . $this-&gt;str( strtolower( $user_name ) );
+            return $this-&gt;db-&gt;getRecord( $sql );
+        }
+
+        // Replace the user with another one
+        function replaceUser( $old, $new ) {
+            $sql = 'UPDATE #_items SET user_id = ' . $this-&gt;str( $new ) . ' WHERE user_id = ' . $this-&gt;str( $old );
+            $this-&gt;db-&gt;executeSql( $sql );
+            $sql = 'UPDATE #_pages SET user_id = ' . $this-&gt;str( $new ) . ' WHERE user_id = ' . $this-&gt;str( $old );
+            $this-&gt;db-&gt;executeSql( $sql );
+        }
+
+        // Function to save a user
+        function saveUser( $user ) {
+
+            // Unset the submit value
+            unset( $user['cmdSubmit'] );
+
+            // Convert the password to md5
+            if ( ! empty( $user['password'] ) ) {
+                $user['password'] = md5( $user['password'] );
+            } else {
+                unset( $user['password'] );
+            }
+
+            // Check if we need to update or insert
+            if ( empty( $user['id'] ) ) {
+                $user['created']= time();
+                $user['modified'] = time();
+                unset( $user['id'] );
+                return $this-&gt;db-&gt;executeInsert( '#_users', $user );
+            } else {
+                if ( empty( $user['created'] ) ) {
+                    $user['created']= time();
+                }
+                $user['modified'] = time();
+                unset( $user['name'] );
+                return $this-&gt;db-&gt;executeUpdate( '#_users', $user, 'id = ' . $this-&gt;str( $user['id'] ) );
+            }
+
+        }
+
+        // Delete a user from the database
+        function deleteUser( $user_id ) {
+            $sql = 'DELETE FROM #_users WHERE id = ' . $this-&gt;str( $user_id );
+            $this-&gt;db-&gt;executeSql( $sql );
+        }
+
+        // Check if we are in the spam_check table, which means we have a spam attack
+        function inSpamAttack() {
+            $comment_interval = YDConfig::get( 'comment_interval', 10 );
+            if ( $comment_interval != '' &amp;&amp; is_numeric( $comment_interval ) ) {
+                $sql = 'SELECT * FROM #_spamcheck WHERE userip = ' . $this-&gt;str( $_SERVER['REMOTE_ADDR'] );
+                return $this-&gt;db-&gt;getRecord( $sql );
+            }
+        }
+
+        // Mark ourselves in the spam check table
+        function spamCheckMark() {
+            $comment_interval = YDConfig::get( 'comment_interval', 10 );
+            if ( $comment_interval != '' &amp;&amp; is_numeric( $comment_interval ) ) {
+                $values = array( 'userip' =&gt; $_SERVER['REMOTE_ADDR'], 'lastvisit' =&gt; time() );
+                $this-&gt;db-&gt;executeInsert( '#_spamcheck', $values );
+            }
+        }
+
+        // Delete the spam comments
+        function emptySpam() {
+            $sql = 'DELETE FROM #_comments WHERE is_spam = 1';
+            $this-&gt;db-&gt;executeSql( $sql );
+        }
+
+        // Function to resize an uploaded image. Takes a YDFSImage object as it's argument
+        function resizeUploadedImage( $image ) {
+
+            // Convert the YDFSFile objects to images
+            if ( is_object( $image ) &amp;&amp; strtolower( get_class( $image ) ) == 'ydfsfile' ) {
+                $image = new YDFSImage( $image-&gt;getAbsolutePath() );
+            }
+
+            // Convert strings to images
+            if ( is_string( $image ) ) {
+                $image = new YDFSImage( $image );
+            }
+
+            // Get the maximum X and Y size
+            $max_x = YDConfig::get( 'max_img_size_x', '' );
+            $max_y = YDConfig::get( 'max_img_size_y', '' );
+            $max_x = empty( $max_x ) ? 999999 : $max_x;
+            $max_y = empty( $max_y ) ? 999999 : $max_y;
+
+            // Do nothing if maximum sizes are specified
+            if ( $max_x == 99999 &amp;&amp; $max_y == 999999 ) {
+                return $image;
+            }
+
+            // Resize the image
+            $image-&gt;saveThumbnail( $max_x, $max_y, $image-&gt;getAbsolutePath() );
+
+            // Return the image
+            return $image;
+
+        }
+
+        // Prepare a query
+        function _prepareQuery( $sql, $order=null ) {
+            return is_null( $order ) ? $sql : $sql . ' ORDER BY ' . $order;
+        }
+
+        // Execute an insert
+        function _executeInsert( $table, $values ) {
+            if ( @ empty( $values['created'] ) ) {
+                $values['created'] = time();
+            }
+            if ( @ empty( $values['modified'] ) ) {
+                $values['modified'] = time();
+            }
+            foreach ( $values as $key=&gt;$val ) {
+                if ( substr( $key, 0, 3 ) == 'cmd' ) {
+                    unset( $values[$key] );
+                }
+            }
+            return $this-&gt;db-&gt;executeInsert( $table, $values );
+        }
+
+        // Execute an update
+        function _executeUpdate( $table, $values, $where ) {
+            if ( @ empty( $values['created'] ) ) {
+                $values['created'] = time();
+            }
+            $values['modified'] = time();
+            foreach ( $values as $key=&gt;$val ) {
+                if ( substr( $key, 0, 3 ) == 'cmd' ) {
+                    unset( $values[$key] );
+                }
+            }
+            return $this-&gt;db-&gt;executeUpdate( $table, $values, $where );
+        }
+
+        // Select items from a table with a given table name
+        function _selectFromTable( $table, $order=null, $limit=-1, $offset=-1 ) {
+            $sql = $this-&gt;_prepareQuery( 'SELECT * FROM ' . $table, $order, $limit, $offset );
+            return $this-&gt;db-&gt;getRecords( $sql );
+         }
+
+        // Select items from a table with a given id
+        function _selectFromTableUsingID( $table, $id ) {
+            $sql = $this-&gt;_prepareQuery( 'SELECT * FROM ' . $table . ' WHERE id = ' . $this-&gt;str( $id ) );
+            return $this-&gt;db-&gt;getRecord( $sql );
+        }
+
+        // Delete items from a table with a given id
+        function _deleteFromTableUsingID( $table, $id ) {
+            $sql = $this-&gt;_prepareQuery( 'DELETE FROM ' . $table . ' WHERE id = ' . $this-&gt;str( $id ) );
+            return $this-&gt;db-&gt;executeSql( $sql );
+        }
+
+        // Escapes a string
+        function str( $t ) {
+            return '\''. $this-&gt;db-&gt;escape( $t ) . '\'';
+        }
+
+        // Get a translation from the translation table
+        function t( $t ) {
+            return YDTplModT( array( 'w' =&gt; $t ) );
+        }
+
+    }
+
+?&gt;

Modified: YDFramework2.0/trunk/examples/weblog/item.php
===================================================================
--- YDFramework2.0/trunk/examples/weblog/item.php	2006-12-27 10:47:33 UTC (rev 2273)
+++ YDFramework2.0/trunk/examples/weblog/item.php	2006-12-27 10:48:19 UTC (rev 2274)
@@ -1,197 +1,197 @@
-&lt;?php
-
-    // Include the Yellow Duck Framework
-    include_once( dirname( __FILE__ ) . '/include/YDWeblog_init.php' );
-
-    // Includes
-    YDInclude( 'YDForm.php' );
-
-    // Class definition
-    class item extends YDWeblogRequest {
-
-        // Class constructor
-        function item() {
-
-            // Initialize the parent
-            $this-&gt;YDWeblogRequest();
-
-            // Disable caching
-            $this-&gt;caching = false;
-
-        }
-
-        // Default action
-        function actionDefault() {
-
-            // Get the ID from the query string
-            $id = $this-&gt;getIdFromQS();
-
-            // Get the weblog details and go to the default view if none is matched
-            $item  = @ $this-&gt;weblog-&gt;getPublicItemById( $id );
-            $this-&gt;redirectIfMissing( $item );
-
-            // Get the related items
-            $related_items = $this-&gt;weblog-&gt;getRelatedItemsByItem( YDConfig::get( 'weblog_entries_fp', 5 ), $item );
-
-            // Convert the list of images to a table of 3 columns
-            $item['images_as_table'] = YDArrayUtil::convertToTable( $item['images'], 3, true );
-
-            // Get the comments
-            $comments = $this-&gt;weblog-&gt;getComments( $id );
-
-            // Assign the variables to the template
-            $this-&gt;tpl-&gt;assign( 'title', $item['title'] );
-            $this-&gt;tpl-&gt;assign( 'item', $item );
-            $this-&gt;tpl-&gt;assign( 'related_items', $related_items );
-            $this-&gt;tpl-&gt;assign( 'comments', $comments );
-
-            // Create the comments form
-            $form = new YDWeblogForm(
-                'comments', 'POST', YDTplModLinkItemRespond( $item ), '_self', array( 'id' =&gt; 'commentform' )
-            );
-
-            // Add the fields
-            $form-&gt;addElement( 'text', 'username', t( 'name' ) );
-            $form-&gt;addElement( 'text', 'useremail', t( 'mail_not_published' ) );
-            $form-&gt;addElement( 'text', 'userwebsite', t( 'website' ) );
-            $form-&gt;addElement( 'textarea', 'comment', '' );
-            $form-&gt;addElement( 'submit', 'cmdSubmit', t( 'submit_comment' ), array( 'class' =&gt; 'button' ) );
-            $form-&gt;addElement( 'hidden', 'item_id' );
-
-            // Set the defaults
-            $defaults = array();
-            $defaults['item_id']     = $id;
-            $defaults['username']    = empty( $_COOKIE['YD_USER_NAME'] ) ? '' : $_COOKIE['YD_USER_NAME'];
-            $defaults['useremail']   = empty( $_COOKIE['YD_USER_EMAIL'] ) ? '' : $_COOKIE['YD_USER_EMAIL'];
-            $defaults['userwebsite'] = empty( $_COOKIE['YD_USER_WEBSITE'] ) ? '' : $_COOKIE['YD_USER_WEBSITE'];
-            $form-&gt;setDefaults( $defaults );
-
-            // Set the rules
-            $form-&gt;addRule( 'username',    'required',      t( 'err_name' ) );
-            $form-&gt;addRule( 'username',    'not_email',     t( 'err_name_email' ) );
-            $form-&gt;addRule( 'username',    'maxlength',     t( 'err_name_length' ), 35 );
-            $form-&gt;addRule( 'useremail',   'email',         t( 'err_email' ) );
-            $form-&gt;addRule( 'useremail',   'required',      t( 'err_email' ) );
-            $form-&gt;addRule( 'userwebsite', 'httpurl',       t( 'err_website' ) );
-            $form-&gt;addRule( 'comment',     'required',      t( 'err_comment' ) );
-            $form-&gt;addRule( 'comment',     'maxlength',     t( 'err_comment_length' ), YDConfig::get( 'max_comment_length', 1500 ) );
-            $form-&gt;addRule( 'comment',     'maxhyperlinks', t( 'err_comment_links' ), YDConfig::get( 'max_comment_links', 1 ) );
-            $form-&gt;addFormRule( array( &amp; $this, 'checkDuplicateComments' ) );
-
-            // Add the filters
-            $form-&gt;addFilters( array( 'username', 'useremail', 'userwebsite' ), 'strip_html' );
-            $form-&gt;addFilter( 'comment', 'safe_html' );
-
-            // Process the form
-            if ( $form-&gt;validate() === true ) {
-
-                // Post request, so check comment interval
-                if ( $this-&gt;weblog-&gt;inSpamAttack() ) {
-                    die( '&lt;b&gt;ERROR:&lt;/b&gt; Comment interval exceeded. Refusing request.' );
-                } else {
-                    $this-&gt;weblog-&gt;spamCheckMark();
-                }
-
-                // Get the form values
-                $values = $form-&gt;getValues();
-
-                // Simple spam protection
-                if ( ! empty( $values['userwebsite'] ) &amp;&amp; strpos( $values['userwebsite'], '.' ) === false ) {
-                    $this-&gt;redirect( YDTplModLinkItem( $item, '#comment-' . $comment_id ) );
-                }
-
-                // Fix any faulty web addresses
-                if ( ! empty( $values['userwebsite'] ) &amp;&amp; substr( strtolower( $values['userwebsite'] ), 0, 7 ) != '<A HREF="http://">http://</A>' ) {
-                    $values['userwebsite'] = '<A HREF="http://">http://</A>' . $values['userwebsite'];
-                }
-
-                // Save the username, useremail and userwebsite
-                setcookie( 'YD_USER_NAME',    $values['username'],    time() + 31536000, '/' );
-                setcookie( 'YD_USER_EMAIL',   $values['useremail'],   time() + 31536000, '/' );
-                setcookie( 'YD_USER_WEBSITE', $values['userwebsite'], time() + 31536000, '/' );
-
-                // Add the values to the database
-                $comment = $this-&gt;weblog-&gt;addComment( $values );
-
-                // Send an email if configured
-                if ( $comment['id'] &gt; 0 &amp;&amp; YDConfig::get( 'email_new_comment', true ) ) {
-
-                    // Include the YDEmail library
-                    YDInclude( 'YDEmail.php' );
-
-                    // Get the list of subscriptions
-                    $subscribers = $this-&gt;weblog-&gt;getCommentSubscribers( $id );
-
-                    // Get the list of subscriptions
-                    $users = $this-&gt;weblog-&gt;getUsers();
-
-                    // Add the comment to the email template
-                    $this-&gt;tpl-&gt;assign( 'eml_comment', $comment );
-
-                    // Create the email and send it
-                    $eml = new YDEmail();
-                    if ( ! empty( $item['user_email'] ) ) {
-                        $eml-&gt;setFrom( $item['user_email'], YDConfig::get( 'weblog_title', 'Untitled Weblog' ) );
-                    } else {
-                        $eml-&gt;setFrom( '<A HREF="https://lists.berlios.de/mailman/listinfo/ydframework-devel">nobody at nowhere.com</A>', YDConfig::get( 'weblog_title', 'Untitled Weblog' ) );
-                    }
-                    $eml-&gt;setReplyTo( '<A HREF="https://lists.berlios.de/mailman/listinfo/ydframework-devel">no at reply.net</A>' );
-                    $eml-&gt;addBcc( $item['user_email'] );
-
-                    // Spam emails do not go to the subscribers
-                    if ( strval( $comment['is_spam'] ) == '0' ) {
-                        foreach ( $subscribers as $subscriber ) {
-                            $eml-&gt;addBcc( $subscriber );
-                        }
-                    }
-
-                    // Email the item owners
-                    foreach ( $users as $user ) {
-                        $eml-&gt;addBcc( $user['email'], $user['name'] );
-                    }
-
-                    // Set the subject and body
-                    if ( strval( $comment['is_spam'] ) == '0' ) {
-                        $eml-&gt;setSubject( t('new_comment') . ': ' . strip_tags( $item['title'] ) );
-                        $eml-&gt;setHtmlBody( $this-&gt;fetch( 'comment_email' ) );
-                    } else {
-                        $eml-&gt;setSubject( '[spam] ' . t('new_comment') . ': ' . strip_tags( $item['title'] ) );
-                        $eml-&gt;setHtmlBody( $this-&gt;fetch( 'comment_email_spam' ) );
-                    }
-
-                    // Send the email
-                    $eml-&gt;send();
-
-                }
-
-                // Clear the cache
-                $this-&gt;clearCache();
-
-                // Redirect to the item
-                $this-&gt;redirect( YDTplModLinkItem( $item, '#comment-' . $comment['id'] ) );
-
-            }
-
-            // Add the form to the template
-            $this-&gt;tpl-&gt;assignForm( 'comments_form', $form );
-
-            // Display the template
-            $this-&gt;display();
-
-        }
-
-        // Function to check for duplicate comments
-        function checkDuplicateComments( $fields ) {
-            if ( $this-&gt;weblog-&gt;isDuplicateComment( $fields ) === true ) {
-                return array( '__ALL__' =&gt; t( 'err_duplicate_comment' ) );
-            } else {
-                return true;
-            }
-        }
-
-    }
-
-    // Process the request
-    YDInclude( 'YDF2_process.php' );
-
+&lt;?php
+
+    // Include the Yellow Duck Framework
+    include_once( dirname( __FILE__ ) . '/include/YDWeblog_init.php' );
+
+    // Includes
+    YDInclude( 'YDForm.php' );
+
+    // Class definition
+    class item extends YDWeblogRequest {
+
+        // Class constructor
+        function item() {
+
+            // Initialize the parent
+            $this-&gt;YDWeblogRequest();
+
+            // Disable caching
+            $this-&gt;caching = false;
+
+        }
+
+        // Default action
+        function actionDefault() {
+
+            // Get the ID from the query string
+            $id = $this-&gt;getIdFromQS();
+
+            // Get the weblog details and go to the default view if none is matched
+            $item  = @ $this-&gt;weblog-&gt;getPublicItemById( $id );
+            $this-&gt;redirectIfMissing( $item );
+
+            // Get the related items
+            $related_items = $this-&gt;weblog-&gt;getRelatedItemsByItem( YDConfig::get( 'weblog_entries_fp', 5 ), $item );
+
+            // Convert the list of images to a table of 3 columns
+            $item['images_as_table'] = YDArrayUtil::convertToTable( $item['images'], 3, true );
+
+            // Get the comments
+            $comments = $this-&gt;weblog-&gt;getComments( $id );
+
+            // Assign the variables to the template
+            $this-&gt;tpl-&gt;assign( 'title', $item['title'] );
+            $this-&gt;tpl-&gt;assign( 'item', $item );
+            $this-&gt;tpl-&gt;assign( 'related_items', $related_items );
+            $this-&gt;tpl-&gt;assign( 'comments', $comments );
+
+            // Create the comments form
+            $form = new YDWeblogForm(
+                'comments', 'POST', YDTplModLinkItemRespond( $item ), '_self', array( 'id' =&gt; 'commentform' )
+            );
+
+            // Add the fields
+            $form-&gt;addElement( 'text', 'username', t( 'name' ) );
+            $form-&gt;addElement( 'text', 'useremail', t( 'mail_not_published' ) );
+            $form-&gt;addElement( 'text', 'userwebsite', t( 'website' ) );
+            $form-&gt;addElement( 'textarea', 'comment', '' );
+            $form-&gt;addElement( 'submit', 'cmdSubmit', t( 'submit_comment' ), array( 'class' =&gt; 'button' ) );
+            $form-&gt;addElement( 'hidden', 'item_id' );
+
+            // Set the defaults
+            $defaults = array();
+            $defaults['item_id']     = $id;
+            $defaults['username']    = empty( $_COOKIE['YD_USER_NAME'] ) ? '' : $_COOKIE['YD_USER_NAME'];
+            $defaults['useremail']   = empty( $_COOKIE['YD_USER_EMAIL'] ) ? '' : $_COOKIE['YD_USER_EMAIL'];
+            $defaults['userwebsite'] = empty( $_COOKIE['YD_USER_WEBSITE'] ) ? '' : $_COOKIE['YD_USER_WEBSITE'];
+            $form-&gt;setDefaults( $defaults );
+
+            // Set the rules
+            $form-&gt;addRule( 'username',    'required',      t( 'err_name' ) );
+            $form-&gt;addRule( 'username',    'not_email',     t( 'err_name_email' ) );
+            $form-&gt;addRule( 'username',    'maxlength',     t( 'err_name_length' ), 35 );
+            $form-&gt;addRule( 'useremail',   'email',         t( 'err_email' ) );
+            $form-&gt;addRule( 'useremail',   'required',      t( 'err_email' ) );
+            $form-&gt;addRule( 'userwebsite', 'httpurl',       t( 'err_website' ) );
+            $form-&gt;addRule( 'comment',     'required',      t( 'err_comment' ) );
+            $form-&gt;addRule( 'comment',     'maxlength',     t( 'err_comment_length' ), YDConfig::get( 'max_comment_length', 1500 ) );
+            $form-&gt;addRule( 'comment',     'maxhyperlinks', t( 'err_comment_links' ), YDConfig::get( 'max_comment_links', 1 ) );
+            $form-&gt;addFormRule( array( &amp; $this, 'checkDuplicateComments' ) );
+
+            // Add the filters
+            $form-&gt;addFilters( array( 'username', 'useremail', 'userwebsite' ), 'strip_html' );
+            //$form-&gt;addFilter( 'comment', 'safe_html' );
+
+            // Process the form
+            if ( $form-&gt;validate() === true ) {
+
+                // Post request, so check comment interval
+                if ( $this-&gt;weblog-&gt;inSpamAttack() ) {
+                    die( '&lt;b&gt;ERROR:&lt;/b&gt; Comment interval exceeded. Refusing request.' );
+                } else {
+                    $this-&gt;weblog-&gt;spamCheckMark();
+                }
+
+                // Get the form values
+                $values = $form-&gt;getValues();
+
+                // Simple spam protection
+                if ( ! empty( $values['userwebsite'] ) &amp;&amp; strpos( $values['userwebsite'], '.' ) === false ) {
+                    $this-&gt;redirect( YDTplModLinkItem( $item, '#comment-' . $comment_id ) );
+                }
+
+                // Fix any faulty web addresses
+                if ( ! empty( $values['userwebsite'] ) &amp;&amp; substr( strtolower( $values['userwebsite'] ), 0, 7 ) != '<A HREF="http://">http://</A>' ) {
+                    $values['userwebsite'] = '<A HREF="http://">http://</A>' . $values['userwebsite'];
+                }
+
+                // Save the username, useremail and userwebsite
+                setcookie( 'YD_USER_NAME',    $values['username'],    time() + 31536000, '/' );
+                setcookie( 'YD_USER_EMAIL',   $values['useremail'],   time() + 31536000, '/' );
+                setcookie( 'YD_USER_WEBSITE', $values['userwebsite'], time() + 31536000, '/' );
+
+                // Add the values to the database
+                $comment = $this-&gt;weblog-&gt;addComment( $values );
+
+                // Send an email if configured
+                if ( $comment['id'] &gt; 0 &amp;&amp; YDConfig::get( 'email_new_comment', true ) ) {
+
+                    // Include the YDEmail library
+                    YDInclude( 'YDEmail.php' );
+
+                    // Get the list of subscriptions
+                    $subscribers = $this-&gt;weblog-&gt;getCommentSubscribers( $id );
+
+                    // Get the list of subscriptions
+                    $users = $this-&gt;weblog-&gt;getUsers();
+
+                    // Add the comment to the email template
+                    $this-&gt;tpl-&gt;assign( 'eml_comment', $comment );
+
+                    // Create the email and send it
+                    $eml = new YDEmail();
+                    if ( ! empty( $item['user_email'] ) ) {
+                        $eml-&gt;setFrom( $item['user_email'], YDConfig::get( 'weblog_title', 'Untitled Weblog' ) );
+                    } else {
+                        $eml-&gt;setFrom( '<A HREF="https://lists.berlios.de/mailman/listinfo/ydframework-devel">nobody at nowhere.com</A>', YDConfig::get( 'weblog_title', 'Untitled Weblog' ) );
+                    }
+                    $eml-&gt;setReplyTo( '<A HREF="https://lists.berlios.de/mailman/listinfo/ydframework-devel">no at reply.net</A>' );
+                    $eml-&gt;addBcc( $item['user_email'] );
+
+                    // Spam emails do not go to the subscribers
+                    if ( strval( $comment['is_spam'] ) == '0' ) {
+                        foreach ( $subscribers as $subscriber ) {
+                            $eml-&gt;addBcc( $subscriber );
+                        }
+                    }
+
+                    // Email the item owners
+                    foreach ( $users as $user ) {
+                        $eml-&gt;addBcc( $user['email'], $user['name'] );
+                    }
+
+                    // Set the subject and body
+                    if ( strval( $comment['is_spam'] ) == '0' ) {
+                        $eml-&gt;setSubject( t('new_comment') . ': ' . strip_tags( $item['title'] ) );
+                        $eml-&gt;setHtmlBody( $this-&gt;fetch( 'comment_email' ) );
+                    } else {
+                        $eml-&gt;setSubject( '[spam] ' . t('new_comment') . ': ' . strip_tags( $item['title'] ) );
+                        $eml-&gt;setHtmlBody( $this-&gt;fetch( 'comment_email_spam' ) );
+                    }
+
+                    // Send the email
+                    $eml-&gt;send();
+
+                }
+
+                // Clear the cache
+                $this-&gt;clearCache();
+
+                // Redirect to the item
+                $this-&gt;redirect( YDTplModLinkItem( $item, '#comment-' . $comment['id'] ) );
+
+            }
+
+            // Add the form to the template
+            $this-&gt;tpl-&gt;assignForm( 'comments_form', $form );
+
+            // Display the template
+            $this-&gt;display();
+
+        }
+
+        // Function to check for duplicate comments
+        function checkDuplicateComments( $fields ) {
+            if ( $this-&gt;weblog-&gt;isDuplicateComment( $fields ) === true ) {
+                return array( '__ALL__' =&gt; t( 'err_duplicate_comment' ) );
+            } else {
+                return true;
+            }
+        }
+
+    }
+
+    // Process the request
+    YDInclude( 'YDF2_process.php' );
+
 ?&gt;
\ No newline at end of file


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000865.html">[ydf-devel] r2273 -	YDFramework2.0/trunk/YDFramework2/addons/YDAkismet
</A></li>
	<LI>Next message: <A HREF="000867.html">[ydf-devel] r2275 - YDFramework2.0/trunk/examples
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#866">[ date ]</a>
              <a href="thread.html#866">[ thread ]</a>
              <a href="subject.html#866">[ subject ]</a>
              <a href="author.html#866">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/ydframework-devel">More information about the YDFramework-devel
mailing list</a><br>
</body></html>
