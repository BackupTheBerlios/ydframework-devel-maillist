<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [ydf-devel] r2040 - in YDFramework2.0/trunk/YDFramework2/addons: .	YDCMComponent YDCMComponent/languages	YDCMComponent/languages/YDCMPage YDCMComponent/languages/YDCMUsers
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/ydframework-devel/2006-August/index.html" >
   <LINK REL="made" HREF="mailto:ydframework-devel%40lists.berlios.de?Subject=Re%3A%20%5Bydf-devel%5D%20r2040%20-%20in%20YDFramework2.0/trunk/YDFramework2/addons%3A%20.%0A%09YDCMComponent%20YDCMComponent/languages%0A%09YDCMComponent/languages/YDCMPage%20YDCMComponent/languages/YDCMUsers&In-Reply-To=%3C200608231513.k7NFD25W013169%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000549.html">
   <LINK REL="Next"  HREF="000551.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[ydf-devel] r2040 - in YDFramework2.0/trunk/YDFramework2/addons: .	YDCMComponent YDCMComponent/languages	YDCMComponent/languages/YDCMPage YDCMComponent/languages/YDCMUsers</H1>
    <B>ximian at mail.berlios.de</B> 
    <A HREF="mailto:ydframework-devel%40lists.berlios.de?Subject=Re%3A%20%5Bydf-devel%5D%20r2040%20-%20in%20YDFramework2.0/trunk/YDFramework2/addons%3A%20.%0A%09YDCMComponent%20YDCMComponent/languages%0A%09YDCMComponent/languages/YDCMPage%20YDCMComponent/languages/YDCMUsers&In-Reply-To=%3C200608231513.k7NFD25W013169%40sheep.berlios.de%3E"
       TITLE="[ydf-devel] r2040 - in YDFramework2.0/trunk/YDFramework2/addons: .	YDCMComponent YDCMComponent/languages	YDCMComponent/languages/YDCMPage YDCMComponent/languages/YDCMUsers">ximian at mail.berlios.de
       </A><BR>
    <I>Wed Aug 23 17:13:02 CEST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="000549.html">[ydf-devel] r2039 - YDFramework2.0/trunk/YDFramework2/YDClasses
</A></li>
        <LI>Next message: <A HREF="000551.html">[ydf-devel] r2041 - YDFramework2.0/trunk/examples/cm/backend
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#550">[ date ]</a>
              <a href="thread.html#550">[ thread ]</a>
              <a href="subject.html#550">[ subject ]</a>
              <a href="author.html#550">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ximian
Date: 2006-08-23 17:11:13 +0200 (Wed, 23 Aug 2006)
New Revision: 2040

Added:
   YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/
   YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMAudit.php
   YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMComp.php
   YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMComponent.php
   YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMHelpdesk.php
   YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMLanguages.php
   YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMLink.php
   YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMLocks.php
   YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMPage.php
   YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMPermissions.php
   YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMRootmenu.php
   YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMStatistics.php
   YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMStatistics_system.php
   YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMStatistics_visits.php
   YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMTemplates.php
   YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMTree.php
   YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMUsers.php
   YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/languages/
   YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/languages/YDCMPage/
   YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/languages/YDCMPage/en.php
   YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/languages/YDCMPage/pt.php
   YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/languages/YDCMUsers/
   YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/languages/YDCMUsers/en.php
   YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/languages/YDCMUsers/pt.php
   YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/languages/en.php
   YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/languages/pt.php
Removed:
   YDFramework2.0/trunk/YDFramework2/addons/YDCMHelpdesk/
   YDFramework2.0/trunk/YDFramework2/addons/YDCMLink/
   YDFramework2.0/trunk/YDFramework2/addons/YDCMPage/
   YDFramework2.0/trunk/YDFramework2/addons/YDCMRootmenu/
Log:
- all YDCM files are now in same addon

Added: YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMAudit.php
===================================================================
--- YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMAudit.php	2006-08-23 15:09:37 UTC (rev 2039)
+++ YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMAudit.php	2006-08-23 15:11:13 UTC (rev 2040)
@@ -0,0 +1,114 @@
+&lt;?php
+
+    /*
+
+        Yellow Duck Framework version 2.0
+        (c) Copyright 2002-2005 Pieter Claerhout
+
+        This library is free software; you can redistribute it and/or
+        modify it under the terms of the GNU Lesser General Public
+        License as published by the Free Software Foundation; either
+        version 2.1 of the License, or (at your option) any later version.
+
+        This library is distributed in the hope that it will be useful,
+        but WITHOUT ANY WARRANTY; without even the implied warranty of
+        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
+        Lesser General Public License for more details.
+
+        You should have received a copy of the GNU Lesser General Public
+        License along with this library; if not, write to the Free Software
+        Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
+
+    */
+
+    // Check if the framework is loaded
+    if ( ! defined( 'YD_FW_NAME' ) ) {
+        die( 'Yellow Duck Framework is not loaded.' );
+    }
+
+    class YDCMAudit extends YDDatabaseObject {
+    
+        function YDCMAudit() {
+        
+			// init database object
+            $this-&gt;YDDatabaseObject();
+			
+			// register database as default
+            $this-&gt;registerDatabase();
+
+			// register table for this component
+            $this-&gt;registerTable( 'YDCMAudit' );
+
+            // register custom key
+            $this-&gt;registerKey( 'audit_id', true );
+
+            // register custom fields
+			$this-&gt;registerField( 'user_id' );
+			$this-&gt;registerField( 'date' );
+			$this-&gt;registerField( 'object' );
+			$this-&gt;registerField( 'object_action' );
+			$this-&gt;registerField( 'object_id' );
+			$this-&gt;registerField( 'browser' );
+			$this-&gt;registerField( 'platform' );
+			$this-&gt;registerField( 'url' );
+
+			// register custom relation
+            $rel = &amp; $this-&gt;registerRelation( 'YDCMUsers', false, 'YDCMUsers' );
+			$rel-&gt;setLocalKey( 'user_id' );
+            $rel-&gt;setForeignKey( 'user_id' );
+			$rel-&gt;setForeignJoin( 'LEFT' );
+		}
+
+
+        /**
+         *  This function counts visits of a object
+         *
+         *  @param $id       Object id (content_id)
+         *  @param $user_id  (Optional) User id (0 means visitors)
+         *  @param $period   (Optional) Period for count. Valid values: 'week', 'month', year'
+         *
+         *  @returns    an array of labels =&gt; values
+         */
+		function getObjectVisits( $id, $user_id = 0, $period = 'week' ){
+		
+			YDInclude( 'YDDate.php' );
+		
+			// compute start date
+			$date = new YDDate();
+
+			$labels = array();
+			
+			if ( $period == 'week' )
+				for( $i = 0; $i &lt; 7; $i++ ){
+					$labels[] = $date-&gt;getDayName();
+					$date-&gt;addDay( -1 );
+				}
+
+			if ( $period == 'month' )
+				for( $i = 0; $i &lt; 4; $i++ ){
+					$labels[] = $date-&gt;getMonthName();
+					$date-&gt;addMonth( -1 );
+				}
+
+			if ( $period == 'year' )
+				for( $i = 0; $i &lt; 3; $i++ ){
+					$labels[] = $date-&gt;getYear();
+					$date-&gt;addYear( -1 );
+				}
+
+			
+			$labels = array_reverse( $labels );
+
+		
+			$this-&gt;resetAll();
+			
+			$this-&gt;user_id = intval( $user_id );
+			
+		
+		}
+		
+		
+		
+
+    }
+?&gt;
\ No newline at end of file

Added: YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMComp.php
===================================================================
--- YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMComp.php	2006-08-23 15:09:37 UTC (rev 2039)
+++ YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMComp.php	2006-08-23 15:11:13 UTC (rev 2040)
@@ -0,0 +1,276 @@
+&lt;?php
+
+    /*
+
+        Yellow Duck Framework version 2.0
+        (c) Copyright 2002-2005 Pieter Claerhout
+
+        This library is free software; you can redistribute it and/or
+        modify it under the terms of the GNU Lesser General Public
+        License as published by the Free Software Foundation; either
+        version 2.1 of the License, or (at your option) any later version.
+
+        This library is distributed in the hope that it will be useful,
+        but WITHOUT ANY WARRANTY; without even the implied warranty of
+        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
+        Lesser General Public License for more details.
+
+        You should have received a copy of the GNU Lesser General Public
+        License along with this library; if not, write to the Free Software
+        Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
+
+    */
+
+    // Check if the framework is loaded
+    if ( ! defined( 'YD_FW_NAME' ) ) {
+        die( 'Yellow Duck Framework is not loaded.' );
+    }
+
+	require_once( dirname( __FILE__ ) . '/YDCMTree.php' );
+	require_once( dirname( __FILE__ ) . '/YDCMLanguages.php' );
+
+    class YDCMComp extends YDDatabaseObject {
+    
+        function YDCMComp( $type, $id ) {
+        
+			// init component as non default
+            $this-&gt;YDDatabaseObject();
+			
+			// register database as default
+            $this-&gt;registerDatabase();
+
+			// register table for this component
+            $this-&gt;registerTable( 'YDCMComp' );
+
+            // register custom key
+            $this-&gt;registerKey( 'component_id', true );
+
+			// register fields	
+			$this-&gt;registerField( 'title' );
+			$this-&gt;registerField( 'version_default' );
+			$this-&gt;registerField( 'version_date' );
+
+			// add static relations to tree and language
+			$this-&gt;registerField( 'content_id' );
+       		$rel = &amp; $this-&gt;registerRelation( 'YDCMTree', false, 'YDCMTree' );
+			$rel-&gt;setLocalKey( 'content_id' );
+			$rel-&gt;setForeignKey( 'content_id' );
+
+			$this-&gt;registerField( 'language_id' );
+       		$rel = &amp; $this-&gt;registerRelation( 'YDCMLanguages', false, 'YDCMLanguages' );
+			$rel-&gt;setLocalKey( 'language_id' );
+			$rel-&gt;setForeignKey( 'language_id' );
+
+			$this-&gt;registerField( 'user_id' );
+       		$rel = &amp; $this-&gt;registerRelation( 'YDCMUsers', false, 'YDCMUsers' );
+			$rel-&gt;setLocalKey( 'user_id' );
+			$rel-&gt;setForeignKey( 'user_id' );
+
+			// add dynamic relation
+       		$rel = &amp; $this-&gt;registerRelation( $type, false, $type );
+			$rel-&gt;setLocalKey( 'component_id' );
+			$rel-&gt;setForeignKey( 'component_id' );
+			$rel-&gt;setForeignJoin( 'LEFT' );
+
+			// store component id
+			$this-&gt;_id = intval( $id );
+			
+			// store type for future use
+			$this-&gt;_type = $type;
+		}
+
+
+        /**
+         *  This function return an array of parent nodes giving an node id
+         *
+         *  @returns    An array with all parent nodes
+         */
+		function getPath(){
+		
+			// 1st step: GET nleft and nright of this node. yes, it's ugly.. 
+			// TODO: change it with a better tree implementation
+			$this-&gt;resetAll();
+			$this-&gt;content_id  = $this-&gt;_id;
+			$this-&gt;language_id = YDLocale::get();
+
+			if ( $this-&gt;find( 'ydcmtree' ) != 1 ) return array();
+
+			$node = $this-&gt;getValues( false, false, false, false );
+		
+			// 2nd step: GET parents (based on previous nleft and nright)
+			$this-&gt;resetAll();
+
+			$this-&gt;language_id = YDLocale::get();
+			$this-&gt;where( 'YDCMTree.nleft  &lt;= ' . intval( $node[ 'nleft' ] ) );
+			$this-&gt;where( 'YDCMTree.nright &gt;= ' . intval( $node[ 'nright' ] ) );
+			$this-&gt;orderBy( 'YDCMTree.nlevel' );
+			$this-&gt;find( 'ydcmtree' );
+
+			return $this-&gt;getResults( false, false, false,false );
+		}
+
+
+        /**
+         *  This function returns the path string to a node
+         *
+         *  @param $separator    Html separator string
+         *  @param $classParents Html class for html links of parents
+         *  @param $classCurrent Html class for span ( current element )
+         *
+         *  @returns    An html string
+         */
+		function getBreadcrum( $separator, $classParents, $classCurrent ){
+
+			// init array for results
+			$res = array();
+
+			// init url object
+			$url = new YDUrl( YD_SELF_SCRIPT );
+
+			// cycle elements to get titles
+			foreach( $this-&gt;getPath() as $elements ){
+			
+				// set url var ID to this element
+				$url-&gt;setQueryVar( 'id',        $elements[ 'component_id' ] );
+				$url-&gt;setQueryVar( 'component', $elements[ 'type' ] );
+
+				// compute class name
+				if ( $this-&gt;_id != $elements[ 'content_id' ] ) $res[] = '&lt;a class=&quot;' . $classParents . '&quot; href=&quot;' . $url-&gt;getUrl() . '&quot;&gt;' . $elements[ 'title' ] . '&lt;/a&gt;';
+				else                                           $res[] = '&lt;span class=&quot;' . $classCurrent . '&quot;&gt;' . $elements[ 'title' ] . '&lt;/span&gt;';
+			}
+
+			// return html string
+			return implode( $separator, $res );
+		}
+		
+		
+        /**
+         *  This function returns an array with all direct children
+         *
+         *  @returns    An array with all direct children
+         */
+		function getMenu(){
+		
+			$this-&gt;resetAll();
+
+			$this-&gt;language_id = YDLocale::get();
+			$this-&gt;where( 'YDCMTree.parent_id  = ' . $this-&gt;_id );
+			$this-&gt;find( 'ydcmtree' );
+			
+			return $this-&gt;getResults( false, false, false, false );
+		}
+
+
+        /**
+         *  This function will render all menu elements
+         *
+         *  @returns    An array with all direct children
+         */
+		function renderMenu(){
+
+			$menu = array();
+
+			$url = new YDUrl( YD_SELF_SCRIPT );
+
+			// render each element
+			foreach( $this-&gt;getMenu() as $element ){
+
+				$el = new $element[ 'type' ];
+				$menu[] = $el-&gt;render( $element, $url );
+			}
+
+			return $menu;
+		}
+
+
+        /**
+         *  This function return node attributes
+         *
+         *  @returns    An array with all attributes
+         */
+		function getNode(){
+		
+			// delete previous stored values
+			$this-&gt;resetAll();
+
+			// define our id to find		
+			$this-&gt;content_id  = $this-&gt;_id;
+			$this-&gt;language_id = YDLocale::get();
+			
+			$this-&gt;limit( 1 );
+			
+			// find node
+			$this-&gt;findAll();
+			
+			// parse html
+			if ( isset( $this-&gt;html ) )  $this-&gt;html  = htmlentities( $this-&gt;html );
+			if ( isset( $this-&gt;xhtml ) ) $this-&gt;xhtml = htmlentities( $this-&gt;xhtml );
+
+			// return node attributes without relation prefixs
+			return $this-&gt;getValues( false, false, false, false );
+		}
+
+
+        /**
+         *  This function return node infomation
+         *
+         *  @returns    An array with all information: array( 'description' =&gt; .., 'versions' =&gt; .., 'versions_total' =&gt; .. )
+         */
+		function getInfo(){
+		
+			// delete previous stored values
+			$this-&gt;resetAll();
+
+			// define our id to find		
+			$this-&gt;content_id  = $this-&gt;_id;
+
+			// order versions by version date
+			$this-&gt;orderBy( 'version_date', 'desc' );
+			
+			// find node
+			$this-&gt;find( 'ydcmtree', 'ydcmusers', strtolower( $this-&gt;_type ) );
+
+			$versions = $this-&gt;getResultsAsAssocArray( array( 'language_id', 'version_date' ) );
+			
+			// init description and total of versions
+			$description    = array();
+			$versions_total = 0;
+
+			// cycle versions, count and get first description (they must be all the same)
+			foreach( $versions as $v =&gt; $arr ){
+			
+				$versions_total += count( $arr );
+			
+				if ( empty( $description ) ) $description = array_values( $arr );
+			}
+
+			// parse publish dates
+			if ( $description[0][ 'YDCMTree_state' ] != 2 ){
+				$description[0][ 'YDCMTree_published_date_start_trans' ] = t('not applicable');
+				$description[0][ 'YDCMTree_published_date_end_trans' ]   = t('not applicable');
+			}
+
+			// parse access
+			if ( $description[0][ 'YDCMTree_access' ] == 1 ) $description[0][ 'YDCMTree_access_trans' ] = t('public');
+			else                                             $description[0][ 'YDCMTree_access_trans' ] = t('private');
+
+			// parse state
+			switch ($description[0][ 'YDCMTree_state' ]){
+				case 0 : $description[0][ 'YDCMTree_state_trans' ] = t('not published'); break;
+				case 1 : $description[0][ 'YDCMTree_state_trans' ] = t('published');     break;
+				case 2 : $description[0][ 'YDCMTree_state_trans' ] = t('schedule');      break;
+			}
+
+			// parse searcheable
+			if ( $description[0][ 'YDCMTree_searcheable' ] == 1 ) $description[0][ 'YDCMTree_searcheable_trans' ] = t('yes');
+			else                                                  $description[0][ 'YDCMTree_searcheable_trans' ] = t('no');
+
+			// return the information array
+			return array(	'description'    =&gt; $description[0],
+							'versions'       =&gt; $versions,
+							'versions_total' =&gt; $versions_total );
+		}
+
+}
+
+?&gt;
\ No newline at end of file

Added: YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMComponent.php
===================================================================
--- YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMComponent.php	2006-08-23 15:09:37 UTC (rev 2039)
+++ YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMComponent.php	2006-08-23 15:11:13 UTC (rev 2040)
@@ -0,0 +1,406 @@
+&lt;?php
+
+    /*
+
+        Yellow Duck Framework version 2.0
+        (c) Copyright 2002-2005 Pieter Claerhout
+
+        This library is free software; you can redistribute it and/or
+        modify it under the terms of the GNU Lesser General Public
+        License as published by the Free Software Foundation; either
+        version 2.1 of the License, or (at your option) any later version.
+
+        This library is distributed in the hope that it will be useful,
+        but WITHOUT ANY WARRANTY; without even the implied warranty of
+        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
+        Lesser General Public License for more details.
+
+        You should have received a copy of the GNU Lesser General Public
+        License along with this library; if not, write to the Free Software
+        Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
+
+    */
+
+    // Check if the framework is loaded
+    if ( ! defined( 'YD_FW_NAME' ) ) {
+        die( 'Yellow Duck Framework is not loaded.' );
+    }
+
+	// include YDF libs
+    YDInclude( 'YDDatabaseObject.php' );
+	YDInclude( 'YDDatabaseTree.php' );
+	YDInclude( 'YDUrl.php' );
+	YDInclude( 'YDError.php' );
+
+	// include YDCM libs
+	YDInclude( 'YDCMComp.php' );
+
+	// add generic translation directory
+	YDLocale::addDirectory( dirname( __FILE__ ) . '/languages/' );
+
+    class YDCMComponent extends YDDatabaseObject {
+
+        function YDCMComponent( $type, $id ) {
+
+			// init DB object
+            $this-&gt;YDDatabaseObject();
+
+            $this-&gt;_author = 'unknown author';
+            $this-&gt;_version = 'unknown version';
+            $this-&gt;_copyright = 'no copyright';
+            $this-&gt;_description = 'no description';
+
+			// register database as default
+            $this-&gt;registerDatabase();
+
+			// register table for this component
+            $this-&gt;registerTable( $type );
+
+			// add standard relation
+			$this-&gt;registerField( 'component_id' );
+       		$rel = &amp; $this-&gt;registerRelation( 'YDCMComp', false, 'YDCMComp' );
+			$rel-&gt;setLocalKey( 'component_id' );
+			$rel-&gt;setForeignKey( 'component_id' );
+
+			// add comp object
+			$this-&gt;comp = new YDCMComp( $type, $id );
+			
+			$this-&gt;_id = intval( $id );
+		}
+
+
+        /**
+         *  This function sets a new id for this component
+         *
+         *  @param $id           Component id
+         */
+		function setId( $id ){
+
+			// set id for all operations in this class
+			$this-&gt;_id       = intval( $id );
+
+			// set id for internal YDComp object
+			$this-&gt;comp-&gt;_id = intval( $id );
+		}
+
+
+        /**
+         *  This function renders this element for menu
+         *
+         *  @returns    The YDDatabaseTree object for YDComponent static methods
+         */
+		function __getYDDatabaseTree(){
+		
+			// TODO: position is required and we must change order from 'parent_id' to 'parent_id ASC, position ASC'
+			$tree = new YDDatabaseTree( 'default', 'YDCMTree', 'content_id', 'parent_id', 'parent_id' );
+
+			// TODO: set sort by parent &amp; position
+			// $tree-&gt;setSortField( 'parent_id ASC, position ASC' );
+
+			// add tree fields
+			$tree-&gt;addField( 'type' );
+			$tree-&gt;addField( 'state' );
+			$tree-&gt;addField( 'reference' );
+			$tree-&gt;addField( 'access' );
+			$tree-&gt;addField( 'searcheable' );
+			$tree-&gt;addField( 'published_date_start' );
+			$tree-&gt;addField( 'published_date_end' );
+			$tree-&gt;addField( 'candrag' );
+			$tree-&gt;addField( 'candrop' );
+			
+			return $tree;		
+		}
+
+
+        /**
+         *  This function renders this element for menu
+         *
+         *  @param $id           Component id
+         *  @param $urlObj       Url object
+         *
+         *  @returns    An html string
+         */
+		function render( $id, &amp; $url ){
+		
+			return '';
+		}
+
+
+        /**
+         *  This function will render a menu
+         *
+         *  @returns    An array with all direct children
+         */
+		function renderMenu(){
+		
+			return $this-&gt;comp-&gt;renderMenu();
+		}
+
+
+        /**
+         *  This function returns all node attributes
+         *
+         *  @returns    An array with node attributes
+         */
+		function getNode(){
+
+			// check if we have already node attributes (some sort of caching)
+			if ( !isset( $this-&gt;__nodeProperties ) ) 
+				$this-&gt;__nodeProperties = $this-&gt;comp-&gt;getNode();
+		
+			return $this-&gt;__nodeProperties;
+		}
+
+
+		function getInfo(){
+		
+			return $this-&gt;comp-&gt;getInfo();
+		}
+
+        /**
+         *  This function returns a node attribute
+         *
+         *  @param $attribute           Attribute name
+         *
+         *  @returns    The node attribute
+         */
+		function get( $attribute ){
+
+			$node = $this-&gt;getNode();
+
+			// return attribute if exists 
+			if ( isset( $node[ $attribute ] ) ) return $node[ $attribute ];
+
+			return false;
+		}
+
+
+        /**
+         *  This function returns all elements (except root)
+         *
+         *  @returns    all tree elements 
+         *  @static
+         */
+		function getTreeElements( $id = null ){
+
+			// init db tree object
+			$tree = YDCMComponent::__getYDDatabaseTree();
+
+			// check if we have a custom id
+			if( is_null( $id ) ) $id = $this-&gt;_id;
+
+			return $tree-&gt;getDescendants( $id );
+		}
+
+
+        /**
+         *  This function checks if elements are valid drag&amp;dropable
+         *
+         *  @param $x  Id of dragable node
+         *  @param $y  Id of dropable node
+         *
+         *  @returns    false if elements are invalid, an associative array with node types (eg: array( $x =&gt; 'PHCMPage', $y =&gt; 'PHCMRootmenu ))'
+         *  @static
+         */
+		function getDragDropElements( $x = null, $y = null ){
+		
+			// get tree module
+			$treeObj = YDCMComponent::module( 'YDCMTree' );
+
+			// check drop validation
+			return $treeObj-&gt;getDragDropElements( $x, $y );
+		}
+
+
+        /**
+         *  This function returns the path to current node
+         *
+         *  @returns    An array with all parents
+         */
+		function getPath(){
+
+			return $this-&gt;comp-&gt;getPath();
+		}
+
+
+        /**
+         *  This function returns all direct elements of a menu
+         *
+         *  @returns    An array with all direct children
+         */
+		function getMenu(){
+
+			return $this-&gt;comp-&gt;getMenu();
+		}
+
+
+        /**
+         *  This function returns the path string to current node
+         *
+         *  @param $separator    (Optional) Html separator string
+         *  @param $classParents (Optional) Html class for html links of parents
+         *  @param $classCurrent (Optional) Url object for element links
+         *
+         *  @returns    An html string
+         */
+		function getBreadcrum( $separator = ' &gt; ', $classParents = 'breadParents', $classCurrent = 'breadCurrent' ){
+
+			// get breadcrum from component
+			return $this-&gt;comp-&gt;getBreadcrum( $separator, $classParents, $classCurrent );
+		}
+
+
+        /**
+         *  This function returns the component author
+         *
+         *  @returns    component author
+         */
+		function getAuthor(){
+
+			return $this-&gt;_author;
+		}
+
+
+        /**
+         *  This function returns the component version
+         *
+         *  @returns    component version
+         */
+		function getVersion(){
+
+			return $this-&gt;_version;
+		}
+
+
+        /**
+         *  This function returns the component copyright
+         *
+         *  @returns    component copyright
+         */
+		function getCopyright(){
+
+			return $this-&gt;_copyright;
+		}
+
+
+        /**
+         *  This function returns the component description
+         *
+         *  @returns    component description
+         */
+		function getDescription(){
+
+			return $this-&gt;_description;
+		}
+
+
+        /**
+         *  This function sets a node state
+         *
+         *  @param $state      The state code
+         *
+         *  @returns    1 if state changed, 0 otherwise
+         */
+		function setState( $state, $id = null ){
+
+			// init db tree object
+			$tree = YDCMComponent::__getYDDatabaseTree();
+
+			// check if static
+			if( is_null( $id ) ) $id = $this-&gt;_id;
+
+			return $tree-&gt;updateNode( array( 'state' =&gt; $state ), $id );
+		}
+
+
+        /**
+         *  This function deletes the tree part of a component only
+         *
+         */
+		function deleteNode(){
+
+			// init db tree object
+			$tree = YDCMComponent::__getYDDatabaseTree();
+
+			return $tree-&gt;deleteNode( $this-&gt;_id );
+		}
+
+
+        /**
+         *  This function adds a standard node in the tree. Experimental
+         *
+         *  @param $values  Node values
+         */
+		function addNode( $values, $parent_id = null ){
+
+			// init db tree object
+			$tree = YDCMComponent::__getYDDatabaseTree();
+
+			// use YDDatabasetree method
+			return $tree-&gt;addNode( $values, $parent_id );
+		}
+
+
+        /**
+         *  This function updates a node
+         *
+         *  @param $values  Node values
+         */
+		function updateNode( $values, $node_id = null ){
+
+			// init db tree object
+			$tree = YDCMComponent::__getYDDatabaseTree();
+
+			// use YDDatabasetree method
+			return $tree-&gt;updateNode( $values, $node_id );
+		}
+
+
+        /**
+         *  This function moves a node
+         *
+         *  @param $values  Node values
+         */
+		function moveNode( $x, $y ){
+
+			// init db tree object
+			$tree = YDCMComponent::__getYDDatabaseTree();
+
+			// use YDDatabasetree method
+			return $tree-&gt;moveNode( $x, $y );
+		}
+
+
+    }
+
+
+	@define ( YD_ERROR_OK, 1000 );
+	
+    YDConfig::set( 'YD_ERROR_LEVELS', array(
+            YD_ERROR_NOTICE  =&gt; 'Notice',
+            YD_ERROR_WARNING =&gt; 'Warning',
+            YD_ERROR_FATAL   =&gt; 'Fatal',
+            YD_ERROR_OK      =&gt; 'Ok'
+        ));
+
+	// experimental class to handle all YDCM method results
+	class YDResult extends YDError{
+	
+        /**
+         *  This method creates a OK type
+         *
+         *  @param  $message  The message.
+         *  @param  $value    (optional) A custom value
+         *
+         *  @returns     An YDCMResult object.
+         *
+         *  @static
+         */
+        function ok( $message, $value = null ) {
+            return YDError::_error( YD_ERROR_OK, $message, $value );
+        }
+
+
+	}
+
+?&gt;
\ No newline at end of file

Added: YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMHelpdesk.php
===================================================================
--- YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMHelpdesk.php	2006-08-23 15:09:37 UTC (rev 2039)
+++ YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMHelpdesk.php	2006-08-23 15:11:13 UTC (rev 2040)
@@ -0,0 +1,476 @@
+&lt;?php
+
+    /*
+
+        Yellow Duck Framework version 2.0
+        (c) Copyright 2002-2005 Pieter Claerhout
+
+        This library is free software; you can redistribute it and/or
+        modify it under the terms of the GNU Lesser General Public
+        License as published by the Free Software Foundation; either
+        version 2.1 of the License, or (at your option) any later version.
+
+        This library is distributed in the hope that it will be useful,
+        but WITHOUT ANY WARRANTY; without even the implied warranty of
+        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
+        Lesser General Public License for more details.
+
+        You should have received a copy of the GNU Lesser General Public
+        License along with this library; if not, write to the Free Software
+        Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
+
+    */
+
+    // Check if the framework is loaded
+    if ( ! defined( 'YD_FW_NAME' ) ) {
+        die( 'Yellow Duck Framework is not loaded.' );
+    }
+
+
+	YDInclude( 'YDForm.php' );
+	YDInclude( 'YDCMComponent.php' );
+
+	// load users module of YDCMComponent
+	YDCMComponent::module( 'YDCMUsers' );
+
+	// add local translation directory
+	YDLocale::addDirectory( dirname( __FILE__ ) . '/languages/' );
+
+	// set posts form name
+	YDConfig::set( 'YDCMHELPDESK_FORMPOST', 'YDCMHelpdeskFormPost', false );
+
+	// set default states
+	YDConfig::set( 'YDCMHELPDESK_STATES', array( 'allstates', 'closed', 'open', 'pendent' ), false );
+
+	// set default types
+	YDConfig::set( 'YDCMHELPDESK_TYPES', array( 'email', 'telephone', 'personal' ), false );
+
+    // set default urgencies (TODO: maybe 'priorities')
+    YDConfig::set( 'YDCMHELPDESK_URGENCIES', array( 'allurgencies' =&gt; array(),
+	                                                'low'          =&gt; array( 'color' =&gt; '#00FF00' ), 
+                                                    'medium'       =&gt; array( 'color' =&gt; '#FF9900' ), 
+													'high'         =&gt; array( 'color' =&gt; '#FF9900' ) ), false );
+
+
+    class YDCMHelpdesk extends YDCMComponent {
+    
+        function YDCMHelpdesk() {
+        
+			// init component
+            $this-&gt;YDCMComponent( 'YDCMHelpdesk' );
+
+            $this-&gt;_author = 'Francisco Azevedo';
+            $this-&gt;_version = '0.1';
+            $this-&gt;_copyright = '(c) Copyright 2006 Francisco Azevedo';
+            $this-&gt;_description = 'This is a simple helpdesk component';
+
+			// register custom fields
+			$this-&gt;registerField( 'title' );
+						
+			// custom relation
+            $rel = &amp; $this-&gt;registerRelation( 'YDCMHelpdesk_posts', false, 'YDCMHelpdesk_posts' );
+			$rel-&gt;setLocalKey( 'component_id' );
+            $rel-&gt;setForeignKey( 'component_id' );
+			$rel-&gt;setForeignJoin( 'LEFT' );
+		}
+
+
+        /**
+         *  This function creates a new helpdesk
+         *
+         *  @param $title  Helpdesk title
+         *  @param $language_id  (Optional) Language code of the heldesk
+         *  @param $reference  (Optional) Node reference
+         *  @param $parent_id  (Optional) Id of the parent help desk
+         */
+		function addHelpdesk( $title, $language_id = 'all', $reference = '', $parent_id = 0 ){
+		
+			// add node to content tree
+			$node = array();
+			$node[ 'type' ]        = 'YDCMHelpdesk';
+			$node[ 'reference' ]   = $reference;
+			$node[ 'state' ]       = 1;
+			$node[ 'access' ]      = 1;
+			$node[ 'searcheable' ] = 0;
+
+			// add tree node
+			// TODO: check if parent_id exist
+			$id = $this-&gt;addNode( $node, intval( $parent_id ) );
+		
+			// add a standard title
+			return $this-&gt;addTitle( $id, $title, $language_id );
+		}
+
+		
+		function addTitle( $id, $title, $language_id ){
+		
+			// reset values
+			$this-&gt;resetValues();
+
+			// add a default helpdesk title
+			// TODO: check if language code exist
+			$this-&gt;content_id  = $id;
+			$this-&gt;title       = $title;
+			$this-&gt;language_id = $language_id;
+
+			// insert values
+			return $this-&gt;insert();
+		}
+
+
+        /**
+         *  This static function returns an array of possible states
+         *
+         *  @param $translated  (Optional) boolean that defines if result uses translation strings
+         */
+		function getStates( $translated = false ){
+		
+			return YDCMHelpdesk::getInfo( $translated, YDConfig::get( 'YDCMHELPDESK_STATES' ) );
+		}
+
+
+        /**
+         *  This static function returns an array of possible urgencies
+         *
+         *  @param $translated  (Optional) boolean that defines if result uses translation strings
+         */
+		function getUrgencies( $translated = false ){
+		
+			return YDCMHelpdesk::getInfo( $translated, array_keys( YDConfig::get( 'YDCMHELPDESK_URGENCIES' ) ) );
+		}
+		
+		
+        /**
+         *  This private static function returns an array/associative array based on states/urgencies
+         *
+         *  @param $translated  (Optional) boolean that defines if result uses translation strings
+         */
+		function getInfo( $translated, $arr ){
+			
+			// if we don't want translation, just return
+			if ( $translated != false ) return $arr;
+			
+			// compute associative array
+			$tmp = array();
+			foreach( $states as $s )
+				$tmp[ $s ] = t( $s );
+
+			return $tmp;
+		}
+
+    }
+
+
+
+    class YDCMHelpdesk_posts extends YDDatabaseObject {
+    
+        function YDCMHelpdesk_posts() {
+        
+			// init component
+            $this-&gt;YDDatabaseObject();
+
+			// register database as default
+            $this-&gt;registerDatabase();
+
+			// register table for this component
+            $this-&gt;registerTable( 'YDCMHelpdesk_posts' );
+
+			// register Key
+			$this-&gt;registerKey( 'post_id', true );
+
+			// register custom fields
+			$this-&gt;registerField( 'component_id' );
+			$this-&gt;registerField( 'user_id' );
+			$this-&gt;registerField( 'subject' );
+			$this-&gt;registerField( 'urgency_id' );
+			$this-&gt;registerField( 'state_id' );
+			$this-&gt;registerField( 'text' );
+			$this-&gt;registerField( 'creation_date' );
+			$this-&gt;registerField( 'reportedby_user' );
+			$this-&gt;registerField( 'reportedby_type' );
+			$this-&gt;registerField( 'reportedby_local' );
+			$this-&gt;registerField( 'reportedby_date' );
+			$this-&gt;registerField( 'assignedto_user' );
+			$this-&gt;registerField( 'assignedto_type' );
+			$this-&gt;registerField( 'assignedto_local' );
+			$this-&gt;registerField( 'assignedto_date' );
+
+			// custom relation
+            $rel = &amp; $this-&gt;registerRelation( 'YDCMHelpdesk', false, 'YDCMHelpdesk' );
+			$rel-&gt;setLocalKey( 'component_id' );
+            $rel-&gt;setForeignKey( 'component_id' );
+
+            $relUsers = &amp; $this-&gt;registerRelation( 'users', false, 'YDCMUsers' );
+			$relUsers-&gt;setLocalKey( 'user_id' );
+            $relUsers-&gt;setForeignKey( 'user_id' );
+
+            $relResponse = &amp; $this-&gt;registerRelation( 'YDCMHelpdesk_response', false, 'YDCMHelpdesk_response' );
+			$relResponse-&gt;setLocalKey( 'post_id' );
+            $relResponse-&gt;setForeignKey( 'post_id' );
+			$relResponse-&gt;setForeignJoin( 'LEFT' );
+
+			// set default columns information
+			$this-&gt;columns = array(	'post_id'       =&gt; array('sortable' =&gt; true), 
+									'subject'       =&gt; array('sortable' =&gt; true),
+									'name'          =&gt; array('sortable' =&gt; true), 
+									'creation_date' =&gt; array('sortable' =&gt; true) );
+		}
+
+
+        /**
+         *  This function defines columns to use in recordsets/ajaxgrids
+         *
+         *  @param $columns  Helpdesk post columns for recorsets/ajaxgrids
+         */
+		function setColumns( $columns ){
+		
+			$this-&gt;columns = $columns;
+		}
+
+
+        /**
+         *  This function returns a form for posts
+         */
+		function getFormPost(){
+		
+			// create a form for new posts
+            $form = new YDForm( YDConfig::get( 'YDCMHELPDESK_FORMPOST' ) );
+
+			// get urgencies, states and types
+			$urgencies = array_keys( YDConfig::get( 'YDCMHELPDESK_URGENCIES' ) );
+			$states    = YDConfig::get( 'YDCMHELPDESK_STATES' );
+			$types     = YDConfig::get( 'YDCMHELPDESK_TYPES' );
+
+			// delete 'allstates' and 'allurgencies' from states and types
+			array_shift( $urgencies );
+			array_shift( $states );
+
+			// add new form elements
+            $form-&gt;addElement( 'text',			'subject',			 t('ticket_subject'),           array('size' =&gt; 50) );
+            $form-&gt;addElement( 'select', 		'urgency_id',		 t('ticket_urgency_id'),        array(), $urgencies );
+            $form-&gt;addElement( 'select',		'state_id',			 t('ticket_state_id'),          array(), $states );
+            $form-&gt;addElement( 'textarea',		'text',              t('ticket_text'),              array('cols' =&gt; 80, 'rows' =&gt; 15) );
+
+            $form-&gt;addElement( 'span',			'creation_user',	 t('ticket_creation_user') );
+            $form-&gt;addElement( 'datetimeselect','creation_date',     t('ticket_creation_date') );
+
+            $form-&gt;addElement( 'text',			'reportedby_user',	 t('ticket_reportedby_user'),  array('size' =&gt; 50) );
+            $form-&gt;addElement( 'select', 		'reportedby_type',	 t('ticket_reportedby_type'),  array(), $types );
+            $form-&gt;addElement( 'text',			'reportedby_local',  t('ticket_reportedby_local') );
+            $form-&gt;addElement( 'datetimeselect','reportedby_date',	 t('ticket_reportedby_date') );
+  
+            $form-&gt;addElement( 'text',          'assignedto_user',	 t('ticket_assignedto_user'),  array('size' =&gt; 50) );
+            $form-&gt;addElement( 'select',		'assignedto_type',	 t('ticket_assignedto_type'),  array(), $types  );
+            $form-&gt;addElement( 'text', 		    'assignedto_local',	 t('ticket_assignedto_local') );
+            $form-&gt;addElement( 'datetimeselect','assignedto_date',   t('ticket_assignedto_date') );
+
+			$form-&gt;setDefault( 'urgency_id', 1 );
+			$form-&gt;setDefault( 'state_id',   1 );
+
+			return $form;
+		}
+
+
+        /**
+         *  This function adds a new post
+         *
+         *  @param $helpdesk_id  helpdesk id of this post
+         *  @param $user_id  User id
+         *  @param $values  Array of values
+         */
+		function addPost( $helpdesk_id, $user_id, $values ){
+
+			// get YDForm object
+			$form = $this-&gt;getFormPost();
+
+			// check form validation
+			if ( !$form-&gt;validate( $values ) )
+				return $form-&gt;getErrors();
+
+			$this-&gt;resetValues();
+		
+			// add required fields
+			// TODO: check if user, urgency and state exist
+			$this-&gt;setValues( $form-&gt;getValues() );
+
+			$this-&gt;component_id = $helpdesk_id;
+			$this-&gt;user_id      = $user_id;
+
+			// parse dates (convert ugly array in a date time sqlformat )
+			$this-&gt;creation_date   = YDStringUtil::formatDate( $this-&gt;creation_date,   'datetimesql' );
+			$this-&gt;reportedby_date = YDStringUtil::formatDate( $this-&gt;reportedby_date, 'datetimesql' );
+			$this-&gt;assignedto_date = YDStringUtil::formatDate( $this-&gt;assignedto_date, 'datetimesql' );
+
+			return $this-&gt;insert();
+		}
+		
+
+        /**
+         *  This function just deletes a post given its id
+         *
+         *  @param $post_id  Post id to delete
+         */
+		function deletePost( $post_id ){
+		
+			$this-&gt;resetValues();
+			
+			$this-&gt;post_id = intval( $post_id );
+			
+			return $this-&gt;delete();
+		}
+
+
+        /**
+         *  This function deletes all posts of a helpdesk
+         *
+         *  @param $helpdesk_id  Helpdesk id
+         */
+		function deleteAll( $helpdesk_id ){
+		
+			$this-&gt;resetValues();
+			
+			$this-&gt;component_id = intval( $helpdesk_id );
+			
+			return $this-&gt;delete();
+		}
+
+
+        /**
+         *  This function deletes all posts using a parent id
+         *
+         *  @param $parent_id  parent id
+         */
+		function deleteParent( $parent_id ){
+		
+			$this-&gt;resetValues();
+			
+			$this-&gt;parent_id = intval( $parent_id );
+			
+			return $this-&gt;delete();
+		}
+
+
+        /**
+         *  This function returns a recordset with posts
+         *
+         *  @param $fields  Array of fields
+         */
+		function getRecordSet( $fields ){
+
+			// delete previous values
+			$this-&gt;resetValues();
+
+			// check column name. TODO: check if column is a valid helpdesk or user column
+			if ( isset( $fields[ 'grid_column' ] ) ) $column = $fields[ 'grid_column' ];
+			else                                     $column = 'creation_date';
+
+			// check direction
+			if ( isset( $fields[ 'grid_direction' ] ) &amp;&amp; $fields[ 'grid_direction' ] == 'asc' ) $desc = false;
+			else                                                                                $desc = true;
+
+			// apply column order
+            $this-&gt;order( $column . ' ' . $fields['g'] );
+
+			// apply state
+			if ( isset( $fields[ 'grid_state' ] ) &amp;&amp; in_array( $fields[ 'grid_state' ], array_keys( YDConfig::get( 'YDCMHELPDESK_STATES' ) ) ) )
+				$this-&gt;state_id = $fields[ 'grid_state' ];
+
+			// apply urgency
+			if ( isset( $fields[ 'grid_urgency' ] ) &amp;&amp; in_array( $fields[ 'grid_urgency' ], YDConfig::get( 'YDCMHELPDESK_URGENCIES' ) ) )
+				$this-&gt;urgency_id = $fields[ 'grid_urgency' ];
+
+			// get information of users too
+			$this-&gt;find( 'users' );
+
+			// check page to show
+			if ( isset( $fields[ 'grid_page' ] ) &amp;&amp; is_numeric( $fields[ 'grid_page' ] ) ) $page = intval( $fields[ 'grid_page' ] );
+			else                                                                           $page = 1;
+
+			// create a recordset
+			return new YDRecordSet( $this-&gt;getResultsAsAssocArray( 'post_id', array_keys( $this-&gt;columns ), false, false, false, false ), $page, 3 );
+		}
+
+
+        /**
+         *  This function returns a ajax grid
+         *
+         *  @param $fields  Array of fields
+         */
+		function getAjaxGrid( $fields = array() ){
+		
+			// include grid lib
+			YDInclude( 'YDFormElement_Grid.php' );
+
+			// init grid
+			$grid = new YDFormElement_Grid();
+
+			// add recordset to grid
+			$grid-&gt;setValue( $this-&gt;getRecordSet( $fields ) );
+			
+			// add columns information to grid
+			$grid-&gt;setColumns( $this-&gt;columns );
+
+			return $grid;
+		}
+		
+		
+
+	}
+
+
+
+    class YDCMHelpdesk_response extends YDDatabaseObject {
+    
+        function YDCMHelpdesk_response() {
+        
+			// init component
+            $this-&gt;YDDatabaseObject();
+
+			// register database as default
+            $this-&gt;registerDatabase();
+
+			// register table for this component
+            $this-&gt;registerTable( 'YDCMHelpdesk_response' );
+
+			// register Key
+			$this-&gt;registerKey( 'response_id', true );
+
+			// register custom fields
+			$this-&gt;registerField( 'post_id' );
+			$this-&gt;registerField( 'user_id' );
+			$this-&gt;registerField( 'date' );
+			$this-&gt;registerField( 'description' );
+
+			// custom relations
+            $rel = &amp; $this-&gt;registerRelation( 'YDCMHelpdesk_posts', false, 'YDCMHelpdesk_posts' );
+			$rel-&gt;setLocalKey( 'post_id' );
+            $rel-&gt;setForeignKey( 'post_id' );
+
+            $relUsers = &amp; $this-&gt;registerRelation( 'YDCMUsers', false, 'YDCMUsers' );
+			$relUsers-&gt;setLocalKey( 'user_id' );
+            $relUsers-&gt;setForeignKey( 'user_id' );
+		}
+
+
+
+		function addResponse( $post_id, $user_id, $message ){
+		
+			YDInclude( 'YDUtil.php' );
+
+			$this-&gt;resetValues();
+		
+			// create response
+			// TODO: check if post_id and user_id are valid
+			$this-&gt;post_id     = intval( $post_id );
+			$this-&gt;user_id     = intval( $user_id );
+			$this-&gt;date        = YDStringUtil::formatDate( time(), 'datetimesql' );
+			$this-&gt;description = $message;
+
+			return $this-&gt;insert();
+		}
+		
+		
+	}	
+
+
+?&gt;
\ No newline at end of file

Added: YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMLanguages.php
===================================================================
--- YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMLanguages.php	2006-08-23 15:09:37 UTC (rev 2039)
+++ YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMLanguages.php	2006-08-23 15:11:13 UTC (rev 2040)
@@ -0,0 +1,99 @@
+&lt;?php
+
+    /*
+
+        Yellow Duck Framework version 2.0
+        (c) Copyright 2002-2005 Pieter Claerhout
+
+        This library is free software; you can redistribute it and/or
+        modify it under the terms of the GNU Lesser General Public
+        License as published by the Free Software Foundation; either
+        version 2.1 of the License, or (at your option) any later version.
+
+        This library is distributed in the hope that it will be useful,
+        but WITHOUT ANY WARRANTY; without even the implied warranty of
+        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
+        Lesser General Public License for more details.
+
+        You should have received a copy of the GNU Lesser General Public
+        License along with this library; if not, write to the Free Software
+        Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
+
+    */
+
+    // Check if the framework is loaded
+    if ( ! defined( 'YD_FW_NAME' ) ) {
+        die( 'Yellow Duck Framework is not loaded.' );
+    }
+
+
+    class YDCMLanguages extends YDDatabaseObject {
+
+        function YDCMLanguages() {
+        
+			// init DB object
+            $this-&gt;YDDatabaseObject();
+
+			// register database as default
+            $this-&gt;registerDatabase();
+
+			// register table for this component
+            $this-&gt;registerTable( 'YDCMLanguages' );
+
+            // define custom key
+            $this-&gt;registerKey( 'language_id', true );
+
+			// Fields
+			$this-&gt;registerField( 'name' );
+			$this-&gt;registerField( 'active' );
+			$this-&gt;registerField( 'visitors_default' );
+			$this-&gt;registerField( 'admin_default' );
+
+			// we don't have relations from here (just TO here, and we don't need to define that)
+		}
+
+
+        /**
+         *  This function returns all active languages
+         *
+         *  @returns    Array of languages, eg: array( 'en' =&gt; 'English', 'pt' =&gt; ... )
+         */
+		function active(){
+		
+			// reset values
+			$this-&gt;resetValues();
+
+			// we want only results where active is 1
+			$this-&gt;active = 1;
+
+			// find all languages
+			$this-&gt;find();
+
+			// return results as array
+			return $this-&gt;getResultsAsAssocArray( 'language_id', 'name' );
+		}
+
+
+        /**
+         *  This function returns the default language for content creation
+         *
+         *  @returns    Language code, eg: 'en'. or false
+         */
+		function adminDefault(){
+		
+			// reset values
+			$this-&gt;resetValues();
+
+			// we want the result where admin default is 1
+			$this-&gt;admin_default = 1;
+			$this-&gt;limit( 1 );
+			
+			// find language
+			if ( $this-&gt;find() == 1 ) return $this-&gt;language_id;
+			
+			return false;
+		}
+
+
+    }
+?&gt;
\ No newline at end of file

Added: YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMLink.php
===================================================================
--- YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMLink.php	2006-08-23 15:09:37 UTC (rev 2039)
+++ YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMLink.php	2006-08-23 15:11:13 UTC (rev 2040)
@@ -0,0 +1,70 @@
+&lt;?php
+
+    /*
+
+        Yellow Duck Framework version 2.0
+        (c) Copyright 2002-2005 Pieter Claerhout
+
+        This library is free software; you can redistribute it and/or
+        modify it under the terms of the GNU Lesser General Public
+        License as published by the Free Software Foundation; either
+        version 2.1 of the License, or (at your option) any later version.
+
+        This library is distributed in the hope that it will be useful,
+        but WITHOUT ANY WARRANTY; without even the implied warranty of
+        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
+        Lesser General Public License for more details.
+
+        You should have received a copy of the GNU Lesser General Public
+        License along with this library; if not, write to the Free Software
+        Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
+
+    */
+
+    // Check if the framework is loaded
+    if ( ! defined( 'YD_FW_NAME' ) ) {
+        die( 'Yellow Duck Framework is not loaded.' );
+    }
+
+	YDInclude( 'YDCMComponent.php' );
+
+
+    class YDCMLink extends YDCMComponent {
+    
+        function YDCMLink() {
+        
+			// init component
+            $this-&gt;YDCMComponent( 'YDCMLink' );
+
+            $this-&gt;_author = 'Francisco Azevedo';
+            $this-&gt;_version = '0.1';
+            $this-&gt;_copyright = '(c) Copyright 2006 Francisco Azevedo';
+            $this-&gt;_description = 'This is a link component';
+
+			// register custom fields
+			$this-&gt;registerField( 'url' );
+			$this-&gt;registerField( 'num_visits' );
+
+			// we don't have custom relations
+		}
+
+
+        /**
+         *  This function will render this element (to be used in a menu)
+         *
+         *  @returns    Html link
+         */
+		function render( $component, &amp; $url ){
+
+			$url-&gt;setQueryVar( 'component', $component[ 'type' ] );
+			$url-&gt;setQueryVar( 'id',        $component[ 'content_id' ] );
+
+			// get url properties from DB
+			$this-&gt;getNode( $component[ 'content_id' ] );
+
+			return '&lt;a href=&quot;' . $this-&gt;url . '&quot;&gt;' . $component[ 'title' ] . '&lt;/a&gt;';
+		}
+
+
+    }
+?&gt;
\ No newline at end of file

Added: YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMLocks.php
===================================================================
--- YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMLocks.php	2006-08-23 15:09:37 UTC (rev 2039)
+++ YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMLocks.php	2006-08-23 15:11:13 UTC (rev 2040)
@@ -0,0 +1,58 @@
+&lt;?php
+
+    /*
+
+        Yellow Duck Framework version 2.0
+        (c) Copyright 2002-2005 Pieter Claerhout
+
+        This library is free software; you can redistribute it and/or
+        modify it under the terms of the GNU Lesser General Public
+        License as published by the Free Software Foundation; either
+        version 2.1 of the License, or (at your option) any later version.
+
+        This library is distributed in the hope that it will be useful,
+        but WITHOUT ANY WARRANTY; without even the implied warranty of
+        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
+        Lesser General Public License for more details.
+
+        You should have received a copy of the GNU Lesser General Public
+        License along with this library; if not, write to the Free Software
+        Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
+
+    */
+
+    // Check if the framework is loaded
+    if ( ! defined( 'YD_FW_NAME' ) ) {
+        die( 'Yellow Duck Framework is not loaded.' );
+    }
+
+    class YDCMLocks extends YDDatabaseObject {
+    
+        function YDCMLocks() {
+        
+			// init component as non default
+            $this-&gt;YDDatabaseObject();
+			
+			// register database as default
+            $this-&gt;registerDatabase();
+
+			// register table for this component
+            $this-&gt;registerTable( 'YDCMLocks' );
+
+            // register custom fields
+			$this-&gt;registerField( 'content_id' );
+			$this-&gt;registerField( 'user_id' );
+
+			// register custom relations
+            $relTree = &amp; $this-&gt;registerRelation( 'YDCMTree', false, 'YDCMTree' );
+			$relTree-&gt;setLocalKey( 'content_id' );
+            $relTree-&gt;setForeignKey( 'content_id' );
+
+            $relUsers = &amp; $this-&gt;registerRelation( 'YDCMUsers', false, 'YDCMUsers' );
+			$relUsers-&gt;setLocalKey( 'user_id' );
+            $relUsers-&gt;setForeignKey( 'user_id' );
+		}
+
+
+    }
+?&gt;
\ No newline at end of file

Added: YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMPage.php
===================================================================
--- YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMPage.php	2006-08-23 15:09:37 UTC (rev 2039)
+++ YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMPage.php	2006-08-23 15:11:13 UTC (rev 2040)
@@ -0,0 +1,229 @@
+&lt;?php
+
+    /*
+
+        Yellow Duck Framework version 2.0
+        (c) Copyright 2002-2005 Pieter Claerhout
+
+        This library is free software; you can redistribute it and/or
+        modify it under the terms of the GNU Lesser General Public
+        License as published by the Free Software Foundation; either
+        version 2.1 of the License, or (at your option) any later version.
+
+        This library is distributed in the hope that it will be useful,
+        but WITHOUT ANY WARRANTY; without even the implied warranty of
+        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
+        Lesser General Public License for more details.
+
+        You should have received a copy of the GNU Lesser General Public
+        License along with this library; if not, write to the Free Software
+        Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
+
+    */
+
+    // Check if the framework is loaded
+    if ( ! defined( 'YD_FW_NAME' ) ) {
+        die( 'Yellow Duck Framework is not loaded.' );
+    }
+
+	YDInclude( 'YDCMComponent.php' );
+
+	// add local translation directory
+	YDLocale::addDirectory( dirname( __FILE__ ) . '/languages/' );
+
+	// set page form name
+	YDConfig::set( 'YDCMPAGE_FORMPAGE', 'YDCMPageForm', false );
+
+
+    class YDCMPage extends YDCMComponent {
+    
+        function YDCMPage( $id = null ) {
+
+			// init component
+            $this-&gt;YDCMComponent( 'YDCMPage', $id );
+
+            $this-&gt;_author = 'Francisco Azevedo';
+            $this-&gt;_version = '0.1';
+            $this-&gt;_copyright = '(c) Copyright 2006 Francisco Azevedo';
+            $this-&gt;_description = 'This is a page component';
+
+            // define custom fields
+			$this-&gt;registerField( 'current_version' );
+			$this-&gt;registerField( 'html' );
+			$this-&gt;registerField( 'xhtml' );
+			$this-&gt;registerField( 'template_pack' );
+			$this-&gt;registerField( 'template' );
+			$this-&gt;registerField( 'metatags' );			
+			$this-&gt;registerField( 'description' );
+			$this-&gt;registerField( 'keywords' );			
+
+			// we don't have custom relations
+		}
+
+		
+        /**
+         *  This function will render this element (to be used in a menu)
+         *
+         *  @returns    Html link
+         */
+		function render( $component, &amp; $url ){
+
+			$url-&gt;setQueryVar( 'component', $component[ 'type' ] );
+			$url-&gt;setQueryVar( 'id',        $component[ 'content_id' ] );
+
+			return '&lt;a href=&quot;' . $url-&gt;getUrl() . '&quot;&gt;' . $component[ 'title' ] . '&lt;/a&gt;';
+		}
+
+
+        /**
+         *  This function returns the page form (form admin edition)
+         *
+         *  @returns    YDForm object
+         */
+		function getFormPage(){
+
+			YDInclude( 'YDForm.php' );
+
+			// get template and language object
+			$templates = YDCMComponent::module( 'YDCMTemplates' );
+			$languages = YDCMComponent::module( 'YDCMLanguages' );
+
+			// create access options
+			$access = array( 0 =&gt; t('public'), 1 =&gt; t('private') );
+
+			// create 'template pack' options
+			$template_pack = array(	1	=&gt; t('use templatepack') . ' (' . $templates-&gt;template_pack() . ')',
+									0	=&gt; t('use custom template') );
+	
+			// create form object
+			$form = new YDForm( YDConfig::get( 'YDCMPAGE_FORMPAGE' ) );
+
+	        $form-&gt;addElement( 'text',           'reference',            t('page_reference'),      array('size' =&gt; 25, 'maxlength' =&gt; 35) );
+	        $form-&gt;addElement( 'text',           'title',                t('page_title'),          array('size' =&gt; 70, 'maxlength' =&gt; 70) );
+	        $form-&gt;addElement( 'textarea',       'html',                 t('page_html') );
+	        $form-&gt;addElement( 'textarea',       'xhtml',                t('page_xhtml') );
+	        $form-&gt;addElement( 'select',         'access',               t('page_access'),         array(), $access);
+	        $form-&gt;addElement( 'select',         'state',                t('page_state'),          array(), array(1 =&gt; t('yes'), 0 =&gt; t('no'), 2 =&gt; t('schedule')) );
+	        $form-&gt;addElement( 'datetimeselect', 'published_date_start', t('page_startdate') );
+	        $form-&gt;addElement( 'datetimeselect', 'published_date_end',   t('page_enddate'));
+	        $form-&gt;addElement( 'select',         'template_pack',        '',                       array(), $template_pack );
+	        $form-&gt;addElement( 'select',         'template',             t('page_template'),       array(), $templates-&gt;visitors_templates());
+	        $form-&gt;addElement( 'select',         'metatags',             t('page_metatags'),       array(), array( 0 =&gt; t('no'), 1 =&gt; t('yes') ) );
+	        $form-&gt;addElement( 'textarea',       'description',          t('page_description'),    array( 'cols' =&gt; 50, 'rows' =&gt; 5 ) );
+	        $form-&gt;addElement( 'textarea',       'keywords',             t('page_keywords'),       array( 'cols' =&gt; 50, 'rows' =&gt; 5 ) );
+	        $form-&gt;addElement( 'select',         'searcheable',          t('page_search'),         array(), array( 0 =&gt; t('no'), 1 =&gt; t('yes') ) );
+	        $form-&gt;addElement( 'hidden',         'content_id' );
+	        $form-&gt;addElement( 'hidden',         'parent_id' );
+	        $form-&gt;addElement( 'hidden',         'language_id' );
+
+			// parent of new page is 0 by default
+			$form-&gt;setDefault( 'content_id',  0 );
+			$form-&gt;setDefault( 'parent_id',   0 );
+			$form-&gt;setDefault( 'language_id', $languages-&gt;adminDefault() );
+
+			// add form rules
+			$form-&gt;addRule( 'reference',      'required',       t('reference_required') );
+			$form-&gt;addRule( 'reference',      'alphanumeric',   t('reference_alphanumeric') );
+			$form-&gt;addRule( 'reference',      'maxwords',       t('reference_maxwords'),  1 );
+			$form-&gt;addRule( 'reference',      'maxlength',      t('reference_maxlength'), 100 );
+			$form-&gt;addRule( 'title',          'required',       t('title_required') );
+			$form-&gt;addRule( 'title',          'maxlength',      t('title_maxlength'), 255 );
+			$form-&gt;addRule( 'content_id',     'required',       t('content_id_required') );
+			$form-&gt;addRule( 'content_id',     'numeric',        t('content_id_numeric') );
+			$form-&gt;addRule( 'parent_id',      'required',       t('parent_id_required') );
+			$form-&gt;addRule( 'parent_id',      'numeric',        t('parent_id_numeric') );
+			$form-&gt;addRule( 'html',           'maxlength',      t('html_maxlength'),  50000 );
+			$form-&gt;addRule( 'xhtml',          'maxlength',      t('xhtml_maxlength'), 50000 );
+			$form-&gt;addRule( 'template_pack',  'in_array',       t('template_pack_invalid'), array( 0, 1 ) );
+			$form-&gt;addRule( 'template',       'in_array',       t('template_invalid'),      array_keys( $templates-&gt;visitors_templates() ) );
+			$form-&gt;addRule( 'metatags',       'in_array',       t('metatags_invalid'),      array( 0, 1 ) );
+			$form-&gt;addRule( 'description',    'maxlength',      t('description_maxlength'), 2000 );
+			$form-&gt;addRule( 'keywords',       'maxlength',      t('keywords_maxlength'),    2000 );
+
+			return $form;
+		}
+
+
+
+        /**
+         *  This function adds/updates a page (if content_id is 0 will add a page, otherwise will update)
+         *
+         *  @param $formvalues  Array with page attributes from the standard form
+         *
+         *  @returns    content_id updated or new content_id
+         */
+		function savePageForm( $formvalues = array() ){
+
+			// get page YDForm object
+			$form = $this-&gt;getFormPage();
+
+			// check form validation
+			if ( !$form-&gt;validate( $formvalues ) )
+				return $form-&gt;getErrors();
+
+			// init node values
+			$node = array();			
+			$node[ 'type' ]        = 'YDCMPage';
+			$node[ 'reference' ]   = $form-&gt;getValue( 'reference' );
+			$node[ 'state' ]       = $form-&gt;getValue( 'state' );
+			$node[ 'access' ]      = $form-&gt;getValue( 'access' );
+			$node[ 'searcheable' ] = $form-&gt;getValue( 'searcheable' );
+
+			// convert published date start/end timestamp to a db datetime format
+			$node[ 'published_date_start' ] = YDStringUtil::formatDate( $form-&gt;getValue( 'published_date_start' ), 'datetimesql' );
+			$node[ 'published_date_end' ]   = YDStringUtil::formatDate( $form-&gt;getValue( 'published_date_end' ),   'datetimesql' );
+
+			// get id of this node
+			$id = $form-&gt;getValue( 'content_id' );
+
+			// if content_id is 0 we are trying to add a new node, otherwise we only need to update it
+			if ( $id == 0 ) $id = $this-&gt;addNode(    $node, intval( $form-&gt;getValue( 'parent_id' ) ) );
+			else                  $this-&gt;updateNode( $node, intval( $form-&gt;getValue( 'content_id' ) ) );
+			
+			// create page
+			$page = array();
+
+			$page[ 'content_id' ]    = $id;
+			$page[ 'language_id' ]   = $form-&gt;getValue( 'language_id' );
+			$page[ 'title' ]         = $form-&gt;getValue( 'title' );
+			$page[ 'html' ]          = $form-&gt;getValue( 'html' );
+			$page[ 'xhtml' ]         = $form-&gt;getValue( 'xhtml' );
+			$page[ 'template_pack' ] = $form-&gt;getValue( 'template_pack' );
+			$page[ 'template' ]      = $form-&gt;getValue( 'template' );
+			$page[ 'metatags' ]      = $form-&gt;getValue( 'metatags' );
+			$page[ 'description' ]   = $form-&gt;getValue( 'description' );
+			$page[ 'keywords' ]      = $form-&gt;getValue( 'keywords' );
+
+			// TODO: care about version control
+			$page[ 'current_version' ] = 1;
+						
+			// add page
+			$this-&gt;resetValues();
+			
+			$this-&gt;setValues( $page );
+
+			$this-&gt;insert();
+			
+			return $id;
+		}
+
+
+        /**
+         *  This function will delete a page node (and not its children)
+         *
+         *  @param $id  Node id
+         */
+		function deleteElement( $id ){
+
+			// delete all element from this node
+			$this-&gt;resetValues();
+
+			$this-&gt;content_id = intval( $id );
+			$this-&gt;delete();
+			
+			// delete node from tree
+			$this-&gt;deleteNode( $id );
+		}
+
+    }
+?&gt;
\ No newline at end of file

Added: YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMPermissions.php
===================================================================
--- YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMPermissions.php	2006-08-23 15:09:37 UTC (rev 2039)
+++ YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMPermissions.php	2006-08-23 15:11:13 UTC (rev 2040)
@@ -0,0 +1,184 @@
+&lt;?php
+
+    /*
+
+        Yellow Duck Framework version 2.0
+        (c) Copyright 2002-2005 Pieter Claerhout
+
+        This library is free software; you can redistribute it and/or
+        modify it under the terms of the GNU Lesser General Public
+        License as published by the Free Software Foundation; either
+        version 2.1 of the License, or (at your option) any later version.
+
+        This library is distributed in the hope that it will be useful,
+        but WITHOUT ANY WARRANTY; without even the implied warranty of
+        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
+        Lesser General Public License for more details.
+
+        You should have received a copy of the GNU Lesser General Public
+        License along with this library; if not, write to the Free Software
+        Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
+
+    */
+
+    // Check if the framework is loaded
+    if ( ! defined( 'YD_FW_NAME' ) ) {
+        die( 'Yellow Duck Framework is not loaded.' );
+    }
+
+
+    class YDCMPermissions extends YDDatabaseObject {
+    
+        function YDCMPermissions() {
+
+			// init component as non default
+            $this-&gt;YDDatabaseObject();
+			
+			// register database as default
+            $this-&gt;registerDatabase();
+
+			// register table for this component
+            $this-&gt;registerTable( 'YDCMPermissions' );
+
+            // register custom key
+            $this-&gt;registerKey( 'permission_id', true );
+
+			// register fields	
+			$this-&gt;registerField( 'user_id' );
+			$this-&gt;registerField( 'object' );
+			$this-&gt;registerField( 'object_action' );
+		}
+
+
+        /**
+         *  This function return an array of permissions
+         *
+         *  @param     $user_id    User id to get permissions
+         *  @param     $translate  (Optional) Translate permissions
+		 *
+         *  @returns    An array with all permission groupby object
+         */
+		function getPermissions( $user_id, $translate = false ){
+		
+			$this-&gt;resetValues();
+			$this-&gt;user_id = intval( $user_id );
+			$this-&gt;orderby( 'object DESC, object_action DESC' );
+			$this-&gt;find();
+
+			$permissions = $this-&gt;getResultsAsAssocArray( array( 'object', 'object_action' ) );
+			
+			if ( !$translate ) return $permissions;
+
+			$arr_translated = array();
+
+			// cycle objects and compute translated actions
+			foreach( $permissions as $obj =&gt; $perms ){
+
+				// get permission translations of this component
+				YDLocale::addDirectory( YD_DIR_HOME_ADD . '/' . $obj . '/languages/' );
+
+				if (!isset( $arr_translated[ $obj ] ) ) $arr_translated[] = $obj;
+
+				foreach( $perms as $p )
+					$arr_translated[ $obj ][] = t( $p );
+			}
+			
+			return $arr_translated;
+		}
+
+
+        /**
+         *  This function return an array of permissions
+         *
+         *  @param     $user_id   User id (or Array of ids ) to delete
+         */
+		function deletePermissions( $user_id ){
+
+			if ( !is_array( $user_id ) ) $user_id = array( $user_id );
+
+			$this-&gt;resetValues();
+			$this-&gt;where( 'user_id IN (&quot;' . implode( '&quot;,&quot;', $user_id ) . '&quot;)' );
+
+			return $this-&gt;delete();
+		}
+
+
+        /**
+         *  This function assigns an array of permissions to a user
+         *
+         *  @param     $user_id     User id to get permissions
+         *  @param     $parend_id   Parent id form permission comparation
+         *  @param     $permissions Array with permissions
+         */
+		function setPermissions( $user_id, $parent_id, $values ){
+
+			// init temp array permissions
+			$permissions_valid  = array();
+			$permissions_to_add = array();
+			$permissions_to_del = array();
+
+			// get parent permissions
+			$permissions_parent = $this-&gt;getPermissions( $parent_id );
+
+			// filter $values and get permissions that are in parent
+			foreach( $permissions_parent as $obj =&gt; $perms )
+				foreach( $perms as $p =&gt; $arr )
+					if( isset( $values[ $obj ][ $p ] ) &amp;&amp; $values[ $obj ][ $p ] == 1 )
+						$permissions_valid[ $obj ][] = $p;
+
+			// get user permissions
+			$permissions_user = $this-&gt;getPermissions( $user_id );
+
+			// cycle user permissions to see the ones we need to delete
+			foreach( $permissions_user as $obj =&gt; $perms )
+				foreach( $perms as $p =&gt; $arr )
+					if ( !isset( $permissions_valid[ $obj ] ) || !in_array( $p, $permissions_valid[ $obj ] ) ) 
+						$permissions_to_del[ $obj ][] = $p;
+
+			// cycle current permissions to see the ones we need to add
+			foreach( $permissions_valid as $obj =&gt; $perms )
+				foreach( $perms as $p )
+					if ( !isset( $permissions[ $obj ][$p] ) )
+						$permissions_to_add[ $obj ][] = $p;
+
+
+			$p_add = 0;
+			$t_add = 0;
+
+			$p_del = 0;
+			$t_del = 0;
+
+			// cycle permissions to delete and delete them from db
+			foreach ( $permissions_to_del as $obj =&gt; $perms )
+				foreach ( array_values( $perms ) as $p ){
+
+					$this-&gt;resetAll();
+					$this-&gt;user_id        = $user_id;
+					$this-&gt;object         = $obj;
+					$this-&gt;object_action  = $p;
+
+					if ($this-&gt;delete()) $p_del++;
+					$t_del++;
+				}
+
+			// cycle permissions to add and insert them in db
+			foreach ( $permissions_to_add as $obj =&gt; $perms )
+				foreach ( array_values( $perms ) as $p ){
+
+					$this-&gt;resetAll();
+					$this-&gt;user_id        = $user_id;
+					$this-&gt;object         = $obj;
+					$this-&gt;object_action  = $p;
+
+					if ($this-&gt;insert()) $p_add++;
+					$t_add++;
+				}
+
+			if ($p_add == $t_add &amp;&amp; $p_del == $t_del ) return true;
+			
+			return false;
+		}
+
+}
+
+?&gt;
\ No newline at end of file

Added: YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMRootmenu.php
===================================================================
--- YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMRootmenu.php	2006-08-23 15:09:37 UTC (rev 2039)
+++ YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMRootmenu.php	2006-08-23 15:11:13 UTC (rev 2040)
@@ -0,0 +1,51 @@
+&lt;?php
+
+    /*
+
+        Yellow Duck Framework version 2.0
+        (c) Copyright 2002-2005 Pieter Claerhout
+
+        This library is free software; you can redistribute it and/or
+        modify it under the terms of the GNU Lesser General Public
+        License as published by the Free Software Foundation; either
+        version 2.1 of the License, or (at your option) any later version.
+
+        This library is distributed in the hope that it will be useful,
+        but WITHOUT ANY WARRANTY; without even the implied warranty of
+        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
+        Lesser General Public License for more details.
+
+        You should have received a copy of the GNU Lesser General Public
+        License along with this library; if not, write to the Free Software
+        Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
+
+    */
+
+    // Check if the framework is loaded
+    if ( ! defined( 'YD_FW_NAME' ) ) {
+        die( 'Yellow Duck Framework is not loaded.' );
+    }
+
+	YDInclude( 'YDCMComponent.php' );
+
+
+    class YDCMRootmenu extends YDCMComponent {
+    
+        function YDCMRootmenu( $id = null ) {
+        
+			// init component
+            $this-&gt;YDCMComponent( 'YDCMRootmenu', $id );
+
+            $this-&gt;_author = 'Francisco Azevedo';
+            $this-&gt;_version = '0.1';
+            $this-&gt;_copyright = '(c) Copyright 2006 Francisco Azevedo';
+            $this-&gt;_description = 'This is a menu component';
+
+			// register custom fields
+			$this-&gt;registerField( 'title' );
+
+			// we don't have custom relations
+		}
+
+    }
+?&gt;
\ No newline at end of file

Added: YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMStatistics.php
===================================================================
--- YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMStatistics.php	2006-08-23 15:09:37 UTC (rev 2039)
+++ YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMStatistics.php	2006-08-23 15:11:13 UTC (rev 2040)
@@ -0,0 +1,111 @@
+&lt;?php
+
+    /*
+
+        Yellow Duck Framework version 2.0
+        (c) Copyright 2002-2005 Pieter Claerhout
+
+        This library is free software; you can redistribute it and/or
+        modify it under the terms of the GNU Lesser General Public
+        License as published by the Free Software Foundation; either
+        version 2.1 of the License, or (at your option) any later version.
+
+        This library is distributed in the hope that it will be useful,
+        but WITHOUT ANY WARRANTY; without even the implied warranty of
+        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
+        Lesser General Public License for more details.
+
+        You should have received a copy of the GNU Lesser General Public
+        License along with this library; if not, write to the Free Software
+        Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
+
+    */
+
+    // Check if the framework is loaded
+    if ( ! defined( 'YD_FW_NAME' ) ) {
+        die( 'Yellow Duck Framework is not loaded.' );
+    }
+
+
+    class YDCMStatistics {
+
+        function YDCMStatistics() {
+		}
+		
+
+        /**
+         *  This static function returns php informations
+         *
+         *  @returns    an array with php info
+         */
+		function php(){
+		
+            // Get the general PHP info
+            ob_start();
+            phpinfo( INFO_GENERAL );
+            $phpInfo .= ob_get_contents();
+            ob_end_clean();
+
+            // Get the right part
+            $phpInfo = substr( $phpInfo, strpos( $phpInfo, '&lt;tr&gt;' ) );
+            $phpInfo = substr( $phpInfo, 0, strpos( $phpInfo, '&lt;/table&gt;' ) );
+
+            // Strip unneeded things
+            $phpInfo = str_replace( '&lt;tr&gt;&lt;td class=&quot;e&quot;&gt;', '', $phpInfo );
+            $phpInfo = str_replace( ' &lt;/td&gt;&lt;/tr&gt;', '', $phpInfo );
+            $phpInfo = trim( $phpInfo );
+
+            // Get the settings
+            $settings = array();
+            foreach ( explode( &quot;\n&quot;, $phpInfo ) as $line ) {
+                $line = explode( ' &lt;/td&gt;&lt;td class=&quot;v&quot;&gt;', $line );
+                if ( isset( $line[1] ) ) $settings[ strtolower( str_replace( ' ', '_', $line[0] ) ) ] = $line[1];
+                else                     $settings[ strtolower( str_replace( ' ', '_', $line[0] ) ) ] = '';
+            }
+
+			// export other values
+			$settings[ 'version' ]     = phpversion();
+			$settings[ 'modules' ]     = implode( get_loaded_extensions(), ', ' );
+			$settings[ 'os' ]          = PHP_OS;
+			$settings[ 'includePath' ] = $GLOBALS['YD_INCLUDE_PATH'];
+
+			return $settings;
+		}
+
+
+        /**
+         *  This static function returns the mail info
+         *
+         *  @returns    an array with mail info
+         */
+		function mailer(){
+
+		    // Includes
+		    require_once( dirname( __FILE__ ) . '/../3rdparty/phpmailer/class.phpmailer.php' );
+
+            // Get the version of phpMailer
+            $PHPMailer = new PHPMailer();
+
+			return array( 'version' =&gt; $PHPMailer-&gt;Version, 'complete' =&gt; 'PHPMailer [version ' . $PHPMailer-&gt;Version . ']' );
+		}
+
+
+        /**
+         *  This static function returns an YDCMStatistics module
+         *
+         *  @returns    an module object
+         */
+		function module( $name ){
+
+			// include lib
+			// TODO: check if name is a valid lib name
+			require_once( YDConfig::get( 'YD_DBOBJECT_PATH' ) . '/' . $name . '.php' );
+
+			// return class
+			return new $name();
+		}
+
+
+    }
+
+?&gt;
\ No newline at end of file

Added: YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMStatistics_system.php
===================================================================
--- YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMStatistics_system.php	2006-08-23 15:09:37 UTC (rev 2039)
+++ YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMStatistics_system.php	2006-08-23 15:11:13 UTC (rev 2040)
@@ -0,0 +1,87 @@
+&lt;?php
+
+    /*
+
+        Yellow Duck Framework version 2.0
+        (c) Copyright 2002-2005 Pieter Claerhout
+
+        This library is free software; you can redistribute it and/or
+        modify it under the terms of the GNU Lesser General Public
+        License as published by the Free Software Foundation; either
+        version 2.1 of the License, or (at your option) any later version.
+
+        This library is distributed in the hope that it will be useful,
+        but WITHOUT ANY WARRANTY; without even the implied warranty of
+        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
+        Lesser General Public License for more details.
+
+        You should have received a copy of the GNU Lesser General Public
+        License along with this library; if not, write to the Free Software
+        Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
+
+    */
+
+    // Check if the framework is loaded
+    if ( ! defined( 'YD_FW_NAME' ) ) {
+        die( 'Yellow Duck Framework is not loaded.' );
+    }
+
+    class YDCMStatistics_system {
+    
+        function YDCMStatistics_system() {
+		}
+
+
+		function getPHPInfo(){
+
+            // Get the general PHP info
+            ob_start();
+            phpinfo( INFO_GENERAL );
+            $phpInfo .= ob_get_contents();
+            ob_end_clean();
+
+            // Get the right part
+            $phpInfo = substr( $phpInfo, strpos( $phpInfo, '&lt;tr&gt;' ) );
+            $phpInfo = substr( $phpInfo, 0, strpos( $phpInfo, '&lt;/table&gt;' ) );
+
+            // Strip unneeded things
+            $phpInfo = str_replace( '&lt;tr&gt;&lt;td class=&quot;e&quot;&gt;', '', $phpInfo );
+            $phpInfo = str_replace( ' &lt;/td&gt;&lt;/tr&gt;', '', $phpInfo );
+            $phpInfo = trim( $phpInfo );
+
+            // Get the settings
+            $settings = array();
+            foreach ( explode( &quot;\n&quot;, $phpInfo ) as $line ) {
+                $line = explode( ' &lt;/td&gt;&lt;td class=&quot;v&quot;&gt;', $line );
+
+                if ( isset( $line[1] ) ) $settings[ strtolower( str_replace( ' ', '_', $line[0] ) ) ] = $line[1];
+                else                     $settings[ strtolower( str_replace( ' ', '_', $line[0] ) ) ] = '';
+			}
+			
+			$settings[ 'version']  = phpversion();
+			$settings[ 'modules' ] = implode( get_loaded_extensions(), ', ' );
+			
+			ksort( $settings );
+			
+			return $settings;
+		}
+
+
+
+		function getMailInfo(){
+
+			// Includes
+			YDInclude( 'phpmailer/class.phpmailer.php' );
+		
+			$p = new PHPMailer();
+			
+			$settings = array( 'system' =&gt; 'PHPMailer',
+							   'version' =&gt; $p-&gt;Version );
+
+			ksort( $settings );
+			
+			return $settings;
+		}
+
+    }
+?&gt;
\ No newline at end of file

Added: YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMStatistics_visits.php
===================================================================
--- YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMStatistics_visits.php	2006-08-23 15:09:37 UTC (rev 2039)
+++ YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMStatistics_visits.php	2006-08-23 15:11:13 UTC (rev 2040)
@@ -0,0 +1,55 @@
+&lt;?php
+
+    /*
+
+        Yellow Duck Framework version 2.0
+        (c) Copyright 2002-2005 Pieter Claerhout
+
+        This library is free software; you can redistribute it and/or
+        modify it under the terms of the GNU Lesser General Public
+        License as published by the Free Software Foundation; either
+        version 2.1 of the License, or (at your option) any later version.
+
+        This library is distributed in the hope that it will be useful,
+        but WITHOUT ANY WARRANTY; without even the implied warranty of
+        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
+        Lesser General Public License for more details.
+
+        You should have received a copy of the GNU Lesser General Public
+        License along with this library; if not, write to the Free Software
+        Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
+
+    */
+
+    // Check if the framework is loaded
+    if ( ! defined( 'YD_FW_NAME' ) ) {
+        die( 'Yellow Duck Framework is not loaded.' );
+    }
+
+    class YDCMStatistics_visits extends YDDatabaseObject {
+    
+        function YDCMStatistics_visits() {
+        
+			// init database object
+            $this-&gt;YDDatabaseObject();
+			
+			// register database as default
+            $this-&gt;registerDatabase();
+
+			// register table for this component
+            $this-&gt;registerTable( 'YDCMStatistics_visits' );
+
+            // register custom key
+            $this-&gt;registerKey( 'visit_id', true );
+
+            // register custom fields
+			$this-&gt;registerField( 'date' );
+			$this-&gt;registerField( 'browser' );
+			$this-&gt;registerField( 'platform' );
+			$this-&gt;registerField( 'url' );
+			$this-&gt;registerField( 'hits' );
+		}
+
+
+    }
+?&gt;
\ No newline at end of file

Added: YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMTemplates.php
===================================================================
--- YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMTemplates.php	2006-08-23 15:09:37 UTC (rev 2039)
+++ YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMTemplates.php	2006-08-23 15:11:13 UTC (rev 2040)
@@ -0,0 +1,162 @@
+&lt;?php
+
+    /*
+
+        Yellow Duck Framework version 2.0
+        (c) Copyright 2002-2005 Pieter Claerhout
+
+        This library is free software; you can redistribute it and/or
+        modify it under the terms of the GNU Lesser General Public
+        License as published by the Free Software Foundation; either
+        version 2.1 of the License, or (at your option) any later version.
+
+        This library is distributed in the hope that it will be useful,
+        but WITHOUT ANY WARRANTY; without even the implied warranty of
+        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
+        Lesser General Public License for more details.
+
+        You should have received a copy of the GNU Lesser General Public
+        License along with this library; if not, write to the Free Software
+        Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
+
+    */
+
+    // Check if the framework is loaded
+    if ( ! defined( 'YD_FW_NAME' ) ) {
+        die( 'Yellow Duck Framework is not loaded.' );
+    }
+
+	YDInclude( 'YDFileSystem.php' );
+
+	// set admin template directory (without template name directory)
+	YDConfig::set( 'YDCMTEMPLATES_ADMIN_PATH', YD_SELF_DIR, false );
+
+	// set admin template name
+	YDConfig::set( 'YDCMTEMPLATES_ADMIN_TEMPLATE', '', false );
+
+	// set visitors template directory (without template name directory)
+	YDConfig::set( 'YDCMTEMPLATES_VISITORS_PATH', YD_SELF_DIR, false );
+
+	// set visitors template name
+	YDConfig::set( 'YDCMTEMPLATES_VISITORS_TEMPLATE', '', false );
+
+	// set template pack ( a pH technology )
+	YDConfig::set( 'YDCMTEMPLATES_PACK', false, false );
+
+
+	// this is a very special component because don't have any DB table (that's way do not extends YDCMComponent)
+    class YDCMTemplates {
+
+        function YDCMTemplates() {
+        
+			$this-&gt;admin_path        = YDConfig::get( 'YDCMTEMPLATES_ADMIN_PATH' );
+			$this-&gt;admin_template    = YDConfig::get( 'YDCMTEMPLATES_ADMIN_TEMPLATE' );
+			$this-&gt;visitors_path     = YDConfig::get( 'YDCMTEMPLATES_VISITORS_PATH' );
+			$this-&gt;visitors_template = YDConfig::get( 'YDCMTEMPLATES_VISITORS_TEMPLATE' );
+			$this-&gt;template_pack     = YDConfig::get( 'YDCMTEMPLATES_PACK' );
+		}
+
+
+        /**
+         *  This function returns all possible templates for administration side
+         *
+         *  @returns    Associative array of templates, eg: array( 'Default' =&gt; 'Default', 'orange' =&gt; ... )
+         */
+		function admin_templates(){
+		
+			return $this-&gt;__getFiles( $this-&gt;admin_path );
+		}
+
+
+        /**
+         *  This function return the template name of administration side
+         *
+         *  @returns    Template name
+         */
+		function admin_template(){
+		
+			return $this-&gt;admin_template;
+		}
+
+
+        /**
+         *  This function return the full template path of administration side
+         *
+         *  @param $subdir  (Optional) template subdirectory
+         *
+         *  @returns    full path
+         */
+		function admin_complete( $subdir = '' ){
+		
+			return $this-&gt;admin_path . '/' . $this-&gt;admin_template . '/' . $subdir;
+		}
+
+
+        /**
+         *  This function return the template pack
+         *
+         *  @returns    full path
+         */
+		function template_pack(){
+		
+			return $this-&gt;template_pack;
+		}
+
+
+        /**
+         *  This function returns all possible templates for visitors side
+         *
+         *  @returns    Associative array of templates, eg: array( 'Default' =&gt; 'Default', 'orange' =&gt; ... )
+         */
+		function visitors_templates(){
+		
+			return $this-&gt;__getFiles( $this-&gt;visitors_path );
+		}
+
+
+        /**
+         *  This function return the template name of administration side
+         *
+         *  @returns    Template name
+         */
+		function visitors_template(){
+		
+			return $this-&gt;visitors_template;
+		}
+
+
+        /**
+         *  This function return the full template path of visitors side
+         *
+         *  @param $subdir  (Optional) template subdirectory
+         *
+         *  @returns    full path
+         */
+		function visitors_complete( $subdir = '' ){
+		
+			return $this-&gt;visitors_path . '/' . $this-&gt;visitors_template . '/' . $subdir;
+		}
+
+
+        /**
+         *  This private function returns all filenames of a directory
+         *
+         *  @returns    Array of filenames, eg: array( 'default' =&gt; 'Default', 'orange' =&gt; ... )
+         */
+		function __getFiles( $dir ){
+		
+			// init directories
+			$directories = array();
+
+			// init template directory
+			$dir = new YDFSDirectory( $dir );
+			
+			// compute directories array
+			foreach( $dir-&gt;getContents( '!.*', '', 'YDFSDirectory' ) as $d )
+				$directories[ $d ] = $d;
+
+			return $directories;
+		}
+
+    }
+?&gt;
\ No newline at end of file

Added: YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMTree.php
===================================================================
--- YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMTree.php	2006-08-23 15:09:37 UTC (rev 2039)
+++ YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMTree.php	2006-08-23 15:11:13 UTC (rev 2040)
@@ -0,0 +1,94 @@
+&lt;?php
+
+    /*
+
+        Yellow Duck Framework version 2.0
+        (c) Copyright 2002-2005 Pieter Claerhout
+
+        This library is free software; you can redistribute it and/or
+        modify it under the terms of the GNU Lesser General Public
+        License as published by the Free Software Foundation; either
+        version 2.1 of the License, or (at your option) any later version.
+
+        This library is distributed in the hope that it will be useful,
+        but WITHOUT ANY WARRANTY; without even the implied warranty of
+        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
+        Lesser General Public License for more details.
+
+        You should have received a copy of the GNU Lesser General Public
+        License along with this library; if not, write to the Free Software
+        Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
+
+    */
+
+    // Check if the framework is loaded
+    if ( ! defined( 'YD_FW_NAME' ) ) {
+        die( 'Yellow Duck Framework is not loaded.' );
+    }
+
+
+    class YDCMTree extends YDDatabaseObject {
+    
+        function YDCMTree() {
+        
+			// init component as non default
+            $this-&gt;YDDatabaseObject();
+			
+			// register database as default
+            $this-&gt;registerDatabase();
+
+			// register table for this component
+            $this-&gt;registerTable( 'YDCMTree' );
+
+            // register custom key
+            $this-&gt;registerKey( 'content_id', true );
+
+			// register fields	
+			$this-&gt;registerField( 'parent_id' );
+			$this-&gt;registerField( 'type' );
+			$this-&gt;registerField( 'state' );
+			$this-&gt;registerField( 'reference' );
+			$this-&gt;registerField( 'access' );			
+			$this-&gt;registerField( 'searcheable' );			
+			$this-&gt;registerField( 'published_date_start' );
+			$this-&gt;registerField( 'published_date_end' );			
+			$this-&gt;registerField( 'candrag' );
+			$this-&gt;registerField( 'candrop' );
+			$this-&gt;registerField( 'nleft' );
+			$this-&gt;registerField( 'nright' );
+
+		}
+
+
+        /**
+         *  This function checks if elements are valid drag&amp;dropable
+         *
+         *  @param $x  Id of dragable node
+         *
+         *  @param $y  Id of dropable node
+
+         *  @returns    false if elements are invalid, an associative array with node information
+         */
+		function getDragDropElements( $x = null, $y = null){
+		
+			// check if elements are numeric
+			if ( !is_numeric( $x ) || !is_numeric( $y ) ) return false;
+		
+			// reset old values and get current table	
+			$this-&gt;resetValues();
+
+			// set custom where to get those 2 elements
+			$this-&gt;where( '((content_id = ' . intval( $x ) . ' AND candrag = 1) OR (content_id = ' . intval( $y ) . ' AND candrop = 1))' );
+
+			// we must get always 2 elements otherwise they were not valid
+			if ( $this-&gt;find() != 2 ) return false;
+
+			// return associative array
+			return $this-&gt;getResultsAsAssocArray( 'content_id' );
+		}
+
+
+
+	}
+
+?&gt;
\ No newline at end of file

Added: YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMUsers.php
===================================================================
--- YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMUsers.php	2006-08-23 15:09:37 UTC (rev 2039)
+++ YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/YDCMUsers.php	2006-08-23 15:11:13 UTC (rev 2040)
@@ -0,0 +1,705 @@
+&lt;?php
+
+    /*
+
+        Yellow Duck Framework version 2.0
+        (c) Copyright 2002-2005 Pieter Claerhout
+
+        This library is free software; you can redistribute it and/or
+        modify it under the terms of the GNU Lesser General Public
+        License as published by the Free Software Foundation; either
+        version 2.1 of the License, or (at your option) any later version.
+
+        This library is distributed in the hope that it will be useful,
+        but WITHOUT ANY WARRANTY; without even the implied warranty of
+        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
+        Lesser General Public License for more details.
+
+        You should have received a copy of the GNU Lesser General Public
+        License along with this library; if not, write to the Free Software
+        Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
+
+    */
+
+    // Check if the framework is loaded
+    if ( ! defined( 'YD_FW_NAME' ) ) {
+        die( 'Yellow Duck Framework is not loaded.' );
+    }
+
+
+	// add YD libs
+	YDInclude( 'YDForm.php' );
+
+	// add YDCM libs
+	YDInclude( 'YDCMPermissions.php' );
+
+	// add local translation directory
+	YDLocale::addDirectory( dirname( __FILE__ ) . '/languages/YDCMUsers/' );
+
+
+    class YDCMUsers extends YDDatabaseObject {
+    
+        function YDCMUsers() {
+        
+			// init DB object
+            $this-&gt;YDDatabaseObject();
+
+			// register database as default
+            $this-&gt;registerDatabase();
+
+			// register table for this component
+            $this-&gt;registerTable( 'YDCMUsers' );
+
+            // register custom key
+            $this-&gt;registerKey( 'user_id', true );
+
+			// register custom fields
+			$this-&gt;registerField( 'parent_id' );
+			$this-&gt;registerField( 'nleft' );
+			$this-&gt;registerField( 'nright' );
+			$this-&gt;registerField( 'nlevel' );
+			$this-&gt;registerField( 'username' );
+			$this-&gt;registerField( 'password' );
+			$this-&gt;registerField( 'name' );
+			$this-&gt;registerField( 'email' );			
+			$this-&gt;registerField( 'other' );			
+			$this-&gt;registerField( 'language_id' );
+			$this-&gt;registerField( 'state' );
+			$this-&gt;registerField( 'login_start' );
+			$this-&gt;registerField( 'login_end' );
+			$this-&gt;registerField( 'login_counter' );			
+			$this-&gt;registerField( 'login_last' );
+			$this-&gt;registerField( 'login_current' );
+			$this-&gt;registerField( 'created_user' );
+			$this-&gt;registerField( 'created_date' );
+			$this-&gt;registerField( 'template' );
+
+			// relation with languages table
+            $rel = &amp; $this-&gt;registerRelation( 'ydcmlanguages', false, 'ydcmlanguages' );
+			$rel-&gt;setLocalKey( 'language_id' );
+            $rel-&gt;setForeignKey( 'language_id' );
+
+			// create tree object
+			$this-&gt;tree = new YDDatabaseTree( 'default', 'YDCMUsers', 'user_id', 'parent_id', 'parent_id' );
+
+			// add tree fields
+			$this-&gt;tree-&gt;addField( 'parent_id' );
+			$this-&gt;tree-&gt;addField( 'username' );
+			$this-&gt;tree-&gt;addField( 'password' );
+			$this-&gt;tree-&gt;addField( 'name' );
+			$this-&gt;tree-&gt;addField( 'email' );			
+			$this-&gt;tree-&gt;addField( 'other' );			
+			$this-&gt;tree-&gt;addField( 'language_id' );
+			$this-&gt;tree-&gt;addField( 'state' );			
+			$this-&gt;tree-&gt;addField( 'login_start' );
+			$this-&gt;tree-&gt;addField( 'login_end' );
+			$this-&gt;tree-&gt;addField( 'login_counter' );			
+			$this-&gt;tree-&gt;addField( 'login_last' );
+			$this-&gt;tree-&gt;addField( 'login_current' );
+			$this-&gt;tree-&gt;addField( 'type' );
+			$this-&gt;tree-&gt;addField( 'created_user' );
+			$this-&gt;tree-&gt;addField( 'created_date' );
+			$this-&gt;tree-&gt;addField( 'template' );
+
+			// init permissions
+			$this-&gt;perm = new YDCMPermissions();
+		}
+
+
+        /**
+         *  This method returns all sub users of a user
+         *
+         *  @param  $parent_id   Parent id
+         *
+         *  @returns    Array with user and children nodes
+         */
+		function getTreeElements( $parent_id ){
+
+			return $this-&gt;tree-&gt;getDescendants( $parent_id, true );
+		}
+
+
+        /**
+         *  This method checks if a user is descendant of another user
+         *
+         *  @param      $id          User id to test if id descendant
+         *  @param      $parent_id   Parent id
+         *
+         *  @returns    boolean. TRUE if is descendant, FALSE if not descendant
+         */
+		function isDescendantOf( $user_id, $parent_id ){
+
+			return $this-&gt;tree-&gt;isDescendantOf( intval( $user_id ), intval( $parent_id ) );
+		}
+
+
+        /**
+         *  This method checks if a username and password are valid
+         *
+         *  @param $username  User username
+         *  @param $password  User password (if password length is smaller than 32 we must md5 it, password form elements must have max 31)
+         *
+         *  @returns    true if valid, false otherwise
+         */
+		function valid( $username = '', $password = '' ){
+
+			// teste username and password rules
+			if (!YDValidateRules::alphanumeric(	$username))			return false;
+			if (!YDValidateRules::maxlength(	$username, 100))	return false;
+			if (!YDValidateRules::alphanumeric(	$password))			return false;
+			if (!YDValidateRules::maxlength(	$password, 32))		return false;
+
+			// reset values
+			$this-&gt;resetValues();
+
+			// set username
+			$this-&gt;username = $username;
+
+			// if password is not in md5 format we must set it
+			if ( strlen( $password ) != 32 ) $password = md5( $password );
+
+			// set password
+			$this-&gt;password = $password;
+			
+			// check user state based on state and/or user login schedule
+			$now = YDStringUtil::formatDate( time(), 'datetimesql' );
+
+			$this-&gt;where( '(state = 1 OR (state = 2 AND login_start &lt; &quot;' . $now . '&quot; AND login_end &gt; &quot;' . $now . '&quot;))' );
+
+			// test if we get just one user
+			if ( $this-&gt;find() == 1 ) return true;
+
+			return false;
+		}
+
+
+        /**
+         *  This method deletes a user (and all children) or just the children
+         *
+         *  @param $user_id        User id
+         *  @param $includeParent  (Optional) Boolean TRUE (default) deletes user id and children, FALSE deletes children only
+         *
+         *  @returns    TRUE if deleted, ARRAY with form errors otherwise
+         */
+		function deleteUser( $user_id, $includeParent = true ){
+		
+			// get ids to delete
+			$ids = $this-&gt;tree-&gt;getDescendants( intval( $user_id ), $includeParent, false, null, null, 'user_id' );
+
+			// delete all permissions of this users
+			$this-&gt;perm-&gt;deletePermissions( $ids );
+
+			// delete node from users table
+			$this-&gt;tree-&gt;deleteNode( $user_id, $includeParent );
+		}
+
+
+        /**
+         *  This method adds form elements for user editing
+		 *
+		 * @param $user_id      User id to edit
+		 *
+		 * @param $username     (Optional) Defines if the username is a box (editable), a span for information only or inexistent
+		 *                                 TRUE: is a box (editable); FALSE: is a span; NULL: inexistent
+		 * 
+		 * @param $password     (Optional) Defines if the password is a box (editable) or inexistent
+		 *                                 TRUE: is a box (editable); NULL: inexistent
+		 * 
+		 * @param $logindetails (Optional) Defines if login details are editable (eg: login schedule dates)
+		 *                                 TRUE: login details are editable; FALSE: login details are spans (just information); NULL: login details are inexistent
+		 * 
+		 * @param $userdetails  (Optional) Defines if user details are editable (eg: name, email, other info, template, language)
+		 *                                 TRUE: user details are editable; FALSE: user details are spans (just information); NULL: inexistent
+		 *
+		 * @param $accessinfo   (Optional) Defines if we want to include access information
+		 *                                 TRUE: include information (spans); FALSE or NULL: don't include
+		 *
+		 * @param $permissionediting  (Optional) Defines if permissions are editable
+		 *                                       TRUE: permissions are checkboxgroups; FALSE or NULL: inexistent
+         */
+		function addFormEdit( $id, $username = null, $password = null, $logindetails = null, $userdetails = null, $accessinfo = null, $permissionediting = null ){
+
+		 	return $this-&gt;_addFormDetails( $id, true, $username, $password, $logindetails, $userdetails, $accessinfo, $permissionediting );
+		}
+
+
+        /**
+         *  This method adds form elements for addind a new user
+		 *
+		 * @param $parent_id    Parent id of this new user
+         *
+		 * @param $username     (Optional) Defines if the username is a box (editable), a span for information only or inexistent
+		 *                                 TRUE: is a box (editable); FALSE: is a span; NULL: inexistent
+		 * 
+		 * @param $password     (Optional) Defines if the password is a box (editable) or inexistent
+		 *                                 TRUE: is a box (editable); NULL: inexistent
+		 * 
+		 * @param $logindetails (Optional) Defines if login details are editable (eg: login schedule dates)
+		 *                                 TRUE: login details are editable; FALSE: login details are spans (just information); NULL: login details are inexistent
+		 * 
+		 * @param $userdetails  (Optional) Defines if user details are editable (eg: name, email, other info, template, language)
+		 *                                 TRUE: user details are editable; FALSE: user details are spans (just information); NULL: inexistent
+		 *
+		 * @param $accessinfo   (Optional) Defines if we want to include access information
+		 *                                 TRUE: include information (spans); FALSE or NULL: don't include
+		 *
+		 * @param $permissionediting  (Optional) Defines if permissions are editable
+		 *                                       TRUE: permissions are checkboxgroups; FALSE or NULL: inexistent
+         */
+		function addFormNew( $id, $username = null, $password = null, $logindetails = null, $userdetails = null, $accessinfo = null, $permissionediting = null ){
+
+		 	return $this-&gt;_addFormDetails( $id, false, $username, $password, $logindetails, $userdetails, $accessinfo, $permissionediting );
+		}
+		 
+		
+        /**
+         *  Helper method for user management
+		 *
+		 * @param $id           If you will EDIT some user this is the user id to edit. On $edit (next argument) you must set TRUE
+         *                      If you will ADD a new user this is the parent id of the new user. On $edit (next argument) you must set FALSE
+         *
+		 * @param $edit         If you are editing a user set TRUE. If you are adding a new user set FALSE
+		 *
+		 * @param $username     (Optional) Defines if the username is a box (editable), a span for information only or inexistent
+		 *                                 TRUE: is a box (editable); FALSE: is a span; NULL: inexistent
+		 * 
+		 * @param $password     (Optional) Defines if the password is a box (editable) or inexistent
+		 *                                 TRUE: is a box (editable); NULL: inexistent
+		 * 
+		 * @param $logindetails (Optional) Defines if login details are editable (eg: login schedule dates)
+		 *                                 TRUE: login details are editable; FALSE: login details are spans (just information); NULL: login details are inexistent
+		 * 
+		 * @param $userdetails  (Optional) Defines if user details are editable (eg: name, email, other info, template, language)
+		 *                                 TRUE: user details are editable; FALSE: user details are spans (just information); NULL: inexistent
+		 *
+		 * @param $accessinfo   (Optional) Defines if we want to include access information
+		 *                                 TRUE: include information (spans); FALSE or NULL: don't include
+		 *
+		 * @param $permissionediting  (Optional) Defines if permissions are editable
+		 *                                       TRUE: permissions are checkboxgroups; FALSE or NULL: inexistent
+         */
+		function _addFormDetails( $id, $edit, $username = null, $password = null, $logindetails = null, $userdetails = null, $accessinfo = null, $permissionediting = null ){
+
+			// init form
+			$this-&gt;form = new YDForm( 'YDCMUsers' );
+
+			// add username
+			if ( $username === true )       $this-&gt;form-&gt;addElement( 'text', 'username', t('user_username') );
+			else if ( $username === false ) $this-&gt;form-&gt;addElement( 'span', 'username', t('user_username') );
+
+			// add password
+			if ( $password === true ) $this-&gt;form-&gt;addElement( 'password', 'password', t('user_password') );
+
+			// add login details
+			if ( $logindetails === true ){
+				$this-&gt;form-&gt;addElement( 'select',         'state',       t('login_state'), array(), array(1 =&gt; t('yes'), 0 =&gt; t('no'), 2 =&gt; t('schedule')) );
+				$this-&gt;form-&gt;addElement( 'datetimeselect', 'login_start', t('login_start') );
+				$this-&gt;form-&gt;addElement( 'datetimeselect', 'login_end',   t('login_end'));
+
+			}else if ( $logindetails === false ){
+				$this-&gt;form-&gt;addElement( 'span',           'state',       t('login_state') );
+				$this-&gt;form-&gt;addElement( 'span',           'login_start', t('login_start') );
+				$this-&gt;form-&gt;addElement( 'span',           'login_end',   t('login_end') );
+			}
+
+			// add common user details
+            if ( $userdetails === true ){
+				$this-&gt;form-&gt;addElement( 'text',      'name',          t('user_name'),     array('size' =&gt; 50, 'maxlength' =&gt; 255) );
+				$this-&gt;form-&gt;addElement( 'text',      'email',         t('user_email') );
+				$this-&gt;form-&gt;addElement( 'textarea',  'other',         t('user_other'),    array('rows' =&gt; 4, 'cols' =&gt; 30) );
+
+				$languages = YDCMComponent::module( 'YDCMLanguages' );
+				$languages = $languages-&gt;active();
+				$this-&gt;form-&gt;addElement( 'select',    'language_id',   t('user_language'),      array(), $languages );
+
+				$templates = YDCMComponent::module( 'YDCMTemplates' );
+    	        $this-&gt;form-&gt;addElement( 'select',    'template',      t('user_template'),      array(), $templates-&gt;admin_templates() );
+
+				$this-&gt;form-&gt;addRule( 'name',        'maxlength',      t('name too big'),  255 );
+				$this-&gt;form-&gt;addRule( 'email',       'email',          t('email not valid') );
+				$this-&gt;form-&gt;addRule( 'other',       'maxlength',      t('other too big'), 5000 );
+				$this-&gt;form-&gt;addRule( 'language_id', 'in_array',       t('language not valid'), array_keys( $languages ) );
+				$this-&gt;form-&gt;addRule( 'template',    'in_array',       t('template not valid'), array_keys( $templates-&gt;admin_templates() ) );
+
+			}else if ( $userdetails === false ){
+				$this-&gt;form-&gt;addElement( 'span',      'name',          t('user_name') );
+				$this-&gt;form-&gt;addElement( 'span',      'email',         t('user_email') );
+				$this-&gt;form-&gt;addElement( 'span',      'other',         t('user_other') );
+				$this-&gt;form-&gt;addElement( 'span',      'language_id',   t('user_language') );
+				$this-&gt;form-&gt;addElement( 'span',      'template',      t('user_template') );
+			}
+
+			// add access information
+			if ( $accessinfo === true ){
+				$this-&gt;form-&gt;addElement( 'span', 'login_counter', t('login_counter') );
+    	        $this-&gt;form-&gt;addElement( 'span', 'login_last',    t('login_last') );
+    	        $this-&gt;form-&gt;addElement( 'span', 'login_current', t('login_current') );
+    	        $this-&gt;form-&gt;addElement( 'span', 'created_user',  t('created_user') );
+    	        $this-&gt;form-&gt;addElement( 'span', 'created_date',  t('created_date') );
+			}
+
+			// add submit button
+			if ( $edit ) $this-&gt;form-&gt;addElement( 'submit', '_cmdSubmit', t( 'save' ) );
+			else         $this-&gt;form-&gt;addElement( 'submit', '_cmdSubmit', t( 'add' ) );
+
+			// if we are editing a user it's a good idea to set form defaults with user node attributes
+			if ( $edit ){
+
+				// get user attributes
+				$node = $this-&gt;getUser( $id );
+
+				// set form defaults based on user attributes
+				$this-&gt;form-&gt;setDefaults( $node );
+			}
+
+
+			// PERMISSION CHECKBOXGROUPS
+//			if ( $permissionediting !== true ) return;
+
+			// check if we are editing or creating
+			if ( $edit ){
+
+				// on editing, permissions avaiable are the parent permissions ( parent of $id )
+				$permissions_avaiable = $this-&gt;perm-&gt;getPermissions( $node['parent_id'] );
+
+				// get current user permissions. We will need them to compare with parent permissions
+				$permissions = $node[ 'permissions' ];
+
+			// on adding, permissions avaiable are the parent permissions ( $id permissions )
+			}else{
+				$permissions_avaiable = $this-&gt;perm-&gt;getPermissions( $id );
+			}
+
+			// custom form variable that has the dynamic permissions checkboxgroups html
+			$this-&gt;form-&gt;permissions_html = array();
+
+			// cycle parent permissions to create form checkboxgroup for this user
+			foreach( $permissions_avaiable as $obj =&gt; $perm ){
+
+				// get permission translations of this component
+				YDLocale::addDirectory( YD_DIR_HOME_ADD . '/' . $obj . '/languages/' );
+
+				// init checkboxgroup options
+				$options  = array();
+				$selected = array();
+
+				// cycle all permissions of this object to create checkboxgroup options array
+				foreach( $perm as $p ){
+				
+					// add option with translated string
+					// eg, if we are in 'YDCMPage' object and action is 'delete' we will add ( YDCMPage =&gt; array( 'delete' =&gt; t('YDCMPage_delete') ) )
+					$options[ $p['object_action' ] ] = t( $obj . '_' . $p['object_action' ] );
+
+					// on editing we must check if this action is select of not ( checking if this action is in parent actions)
+					if ( $edit &amp;&amp; isset( $permissions[ $obj ] ) &amp;&amp; in_array( $p['object_action' ], array_keys( $permissions[ $obj ] ) )){
+						$selected[ $p['object_action' ] ] = 1;
+					}
+				}
+
+				// add object checkbox or spans
+				if ( $permissionediting === true )       $el = &amp; $this-&gt;form-&gt;addElement( 'checkboxgroup', $obj, $obj, array(), $options );
+				else if ( $permissionediting === false ) $el = &amp; $this-&gt;form-&gt;addElement( 'span', $obj, $obj );
+
+				// add default for this checkboxgroup if we are editing
+				if ( $edit ){
+					if ( $permissionediting === true )       $this-&gt;form-&gt;setDefault( $obj, $selected );
+					else if ( $permissionediting === false ) $this-&gt;form-&gt;setDefault( $obj, implode( '&lt;br&gt;', array_keys( $selected ) ) );
+				}
+
+				// this will store the checkboxgroups html in a variable for better templating placement
+				$this-&gt;form-&gt;permissions_html[ $obj ] = $el-&gt;toHtml();
+			}
+
+		}
+
+
+        /**
+         *  This method updates user attributes
+         *
+         *  @param $id           User id to save attributes
+         *  @param $created_user User id that wants to create this new user
+         *  @param $formvalues   (Optional) Custom array with user attributes
+         *
+         *  @returns    TRUE if updated, ARRAY with form errors otherwise
+         */
+		function saveFormEdit( $id, $created_user, $formvalues = null ){
+
+			return $this-&gt;_saveFormDetails( $id, true, $created_user, $formvalues );
+		}
+
+
+        /**
+         *  This method adds a new user
+         *
+         *  @param $parent_id    Parent id of this new user
+         *  @param $created_user User id that wants to create this new user
+         *  @param $formvalues   (Optional) Custom array with user attributes
+         *
+         *  @returns    TRUE if added, ARRAY with form errors otherwise
+         */
+		function saveFormNew( $parent_id, $created_user, $formvalues = null ){
+
+			return $this-&gt;_saveFormDetails( $parent_id, false, $created_user, $formvalues );
+		}
+
+
+        /**
+         *  This method adds/saves a user
+         *
+         *  @param $id           If we are editing $id is the user id. If we are adding, $id is the parent_id
+         *  @param $edit         Boolean flag that defines we we are editing $id or adding to $id
+         *  @param $created_user User id that wants to create this new user
+         *  @param $formvalues   (Optional) Custom array with user attributes
+         *
+         *  @returns    TRUE if updated, ARRAY with form errors otherwise
+         */
+		function _saveFormDetails( $id, $edit, $created_user, $formvalues = null ){
+
+			// check form validation
+			if ( !$this-&gt;form-&gt;validate( $formvalues ) )
+				return $this-&gt;form-&gt;getErrors();
+
+			// get form values avaiable
+			$values = $this-&gt;form-&gt;getValues();
+		
+			// parse fixed values
+			$values['type']          = 'YDCMUseradministrator';
+			$values['nlevel']        = 1;
+			$values['created_user']  = intval( $created_user );
+			$values['created_date']  = YDStringUtil::formatDate( time(), 'datetimesql' );
+			$values['login_counter'] = 0;
+
+			// parse special elements
+			if ( $this-&gt;form-&gt;isElement( 'login_start' ) ) $values['login_start'] = YDStringUtil::formatDate( $values['login_start'], 'datetimesql' );
+			if ( $this-&gt;form-&gt;isElement( 'login_start' ) ) $values['login_end']   = YDStringUtil::formatDate( $values['login_end'],   'datetimesql' );
+			if ( $this-&gt;form-&gt;isElement( 'password' ) )    $values['password']    = md5( $values['password'] );
+
+			// check if we are editing or adding an element
+			if ( $edit ){
+
+				// update node to YDUsers table
+				$res = $this-&gt;tree-&gt;updateNode( $values, $id );
+	
+				// change user permissions in YDCMPermissions
+				return $this-&gt;perm-&gt;setPermissions( $id, $this-&gt;getUserAttribute( $id, 'parent_id' ), $values );
+			}else{
+			
+				// add node to YDUsers table
+				$newID = $this-&gt;tree-&gt;addNode( $values, $id );
+
+				// change user permissions in YDCMPermissions
+				return $this-&gt;perm-&gt;setPermissions( $newID, $id, $values );
+			}
+
+		}
+
+
+        /**
+         *  This function adds form elements for password changing
+         *
+         * @param $oldpassword  (Optional) Flag the defines if we should include a box with old password confirmation.
+         *                                 This box is used when the user wants to change its pass and not when we want to change another user pass
+         *                                 TRUE: include box; FALSE: don't include
+         */
+		function addFormPassword( $oldpassword = true ){
+
+			// init form
+			$this-&gt;form = new YDForm( 'YDCMUsers' );
+
+			// add new password box
+            $this-&gt;form-&gt;addElement( 'password',    'new',          t('password_new'),         array('size' =&gt; 30, 'maxlength' =&gt; 31) );
+			$this-&gt;form-&gt;addRule(    'new',         'required',     t('passwords are required') );
+			$this-&gt;form-&gt;addRule(    'new',         'maxlength',    t('passwords too big'), 31 );
+			$this-&gt;form-&gt;addRule(    'new',         'alphanumeric', t('passwords not alphanumeric') );
+
+			// add new_confirm password box
+            $this-&gt;form-&gt;addElement( 'password',    'new_confirm',  t('password_new_confirm'), array('size' =&gt; 30, 'maxlength' =&gt; 31) );
+			$this-&gt;form-&gt;addRule(    'new_confirm', 'required',     t('passwords are required') );
+			$this-&gt;form-&gt;addRule(    'new_confirm', 'maxlength',    t('passwords too big'), 31 );
+			$this-&gt;form-&gt;addRule(    'new_confirm', 'alphanumeric', t('passwords not alphanumeric') );
+
+			// add compare rule to new password and confirmation password
+			$this-&gt;form-&gt;addCompareRule( array( 'new', 'new_confirm' ), 'equal', t('passwords dont match') );
+
+			// add old password box
+			if ( $oldpassword ){
+            	$this-&gt;form-&gt;addElement( 'password', 'old',          t('password_old'),         array('size' =&gt; 20, 'maxlength' =&gt; 31) );
+				$this-&gt;form-&gt;addRule(    'old',      'required',     t('passwords are required') );
+				$this-&gt;form-&gt;addRule(    'old',      'maxlength',    t('passwords too big'), 31 );
+				$this-&gt;form-&gt;addRule(    'old',      'alphanumeric', t('passwords not alphanumeric') );
+			}
+		}
+
+
+        /**
+         *  This function updates a user password
+         *
+         *  @param $user_id     User id to update password
+         *  @param $formvalues  (Otional) Custom array with 2 passwords (new and new_confirm)
+         *
+         *  @returns    true if updated or array with form errors otherwise
+         */
+		function saveFormPassword( $user_id, $formvalues = null ){
+
+			// check form validation
+			if ( !$this-&gt;form-&gt;validate( $formvalues ) )
+				return $this-&gt;form-&gt;getErrors();
+
+			// reset values
+			$this-&gt;resetAll();
+
+			// set new password
+			$this-&gt;user_id  = intval( $user_id );
+			$this-&gt;password = md5( $this-&gt;form-&gt;getValue( 'new' ) );
+
+			// update user and get result
+			if ( $this-&gt;update() == 1 ) return true;
+
+			return false;
+		}
+
+
+        /**
+         *  This returns the user form
+         *
+         *  @param $defaults  (Optional) default values array to apply in form
+         *
+         *  @returns    YDForm object
+         */
+		function &amp; getForm( $defaults = false ){
+
+			// check if we have form defaults and apply them
+			if ( is_array( $defaults ) ) $this-&gt;form-&gt;setDefaults( $defaults );
+
+			return $this-&gt;form;
+		}
+
+
+        /**
+         *  This method returns user attributes
+         *
+         *  @param      $user_id     User id to use (instead of internal)
+         *  @param      $translate   (Optional) Boolean that defines if result must be translated
+         *
+         *  @returns    User details
+         */
+		function getUser( $user_id, $translate = false ){
+
+			$this-&gt;resetValues();
+
+			// set user id
+			$this-&gt;user_id = intval( $user_id );
+
+			// get all attributes
+			if ( $this-&gt;findAll() != 1 ) return false;
+
+			// password should always empty
+			$this-&gt;password = '';
+
+			// check if we want human readable elements
+			if ( $translate ){
+
+				// check if state not schedule
+				if ( $this-&gt;state != 2 ){
+					$this-&gt;login_start = t('not applicable');
+					$this-&gt;login_end   = t('not applicable');
+				}
+
+				if ( $this-&gt;state == 0 )      $this-&gt;state = t('blocked');
+				else if ( $this-&gt;state == 1 ) $this-&gt;state = t('active');
+				else                          $this-&gt;state = t('schedule');
+
+				// check if user is root
+				if ( $this-&gt;created_user == 0 ){
+					$this-&gt;created_user = t('not applicable');
+					$this-&gt;created_date = t('not applicable');
+				}
+			}
+
+			// add permissions
+			$values = $this-&gt;getValues();
+			$values[ 'permissions' ] = $this-&gt;perm-&gt;getPermissions( intval( $user_id ) );
+			
+			return $values;
+		}
+
+
+        /**
+         *  This method returns a specific user attribute
+         *
+         *  @param      $user_id     User id to use (instead of internal)
+         *  @param      $attribute   Attribute string
+         *
+         *  @returns    User details
+         */
+		function getUserAttribute( $user_id, $attribute ){
+
+			$this-&gt;resetValues();
+
+			// set user id
+			$this-&gt;user_id = intval( $user_id );
+
+			// get all attributes
+			if ( $this-&gt;find() != 1 ) return false;
+
+			return $this-&gt;get( $attribute );
+		}
+
+
+        /**
+         *  This function updates current user login details
+         *
+         *  @returns    true if user login details updated, false if user is not valid or details not updated
+         */
+		function updateLogin(){
+
+			YDInclude( 'YDUtil.php' );
+
+			$this-&gt;resetValues();
+			
+			// get current user id
+			$res = $this-&gt;currentID();
+
+			// check if user exists
+			if ( $res == false ) return false;
+			
+			// get all attributes
+			$this-&gt;find();
+
+			// increase login value
+			$this-&gt;login_counter ++;
+
+			// set last login date
+			$this-&gt;login_last = $this-&gt;login_current;
+
+			// set current login
+			$this-&gt;login_current = YDStringUtil::formatDate( time(), 'datetimesql' );
+
+			// return update result
+			if ( $this-&gt;update() == 1 ) return true;
+			
+			return false;
+		}
+		
+		
+        /**
+         *  This method returns the id of the current user if you use PHP_AUTH_USER and PHP_AUTH_PW for authentication
+         */
+		function currentID(){
+		
+			// reset user values
+			$this-&gt;resetValues();
+		
+			// check if user is valid and get user id ( YDCMUsers::valid does it )
+			$valid = $this-&gt;valid( $_SERVER['PHP_AUTH_USER'], $_SERVER['PHP_AUTH_PW'] );
+
+			// if user is not valid we should return false
+			if ( $valid === false ) return false;
+
+			// return user id found by $this-&gt;valid
+			return $this-&gt;user_id;
+		}
+
+
+    }
+?&gt;
\ No newline at end of file

Added: YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/languages/YDCMPage/en.php
===================================================================
--- YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/languages/YDCMPage/en.php	2006-08-23 15:09:37 UTC (rev 2039)
+++ YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/languages/YDCMPage/en.php	2006-08-23 15:11:13 UTC (rev 2040)
@@ -0,0 +1,34 @@
+&lt;?php
+// PERMISSIONS
+$GLOBALS['t']['ydcmpage_create'] = 'Create';
+$GLOBALS['t']['ydcmpage_delete'] = 'Delete';
+
+
+// PAGE FORM
+$GLOBALS['t']['page_reference'] = 'Reference';
+$GLOBALS['t']['page_title'] = 'Title';
+$GLOBALS['t']['page_content'] = 'Content';
+$GLOBALS['t']['page_access'] = 'Access';
+$GLOBALS['t']['page_state'] = 'Published';
+$GLOBALS['t']['page_startdate'] = 'Start date';
+$GLOBALS['t']['page_enddate'] = 'End date';
+$GLOBALS['t']['page_templates'] = 'Templates';
+$GLOBALS['t']['page_template'] = 'Template';
+$GLOBALS['t']['page_metatags'] = 'Metatags';
+$GLOBALS['t']['page_description'] = 'Description';
+$GLOBALS['t']['page_keywords'] = 'Keywords';
+$GLOBALS['t']['page_search'] = 'Searcheable';
+
+// PAGE FORM RULES
+
+// OTHER
+$GLOBALS['t']['page'] = 'Page';
+$GLOBALS['t']['page content'] = 'Content';
+$GLOBALS['t']['page template'] = 'Template';
+$GLOBALS['t']['page access'] = 'Access';
+$GLOBALS['t']['new page'] = 'New page';
+$GLOBALS['t']['edit page'] = 'Edit page';
+$GLOBALS['t']['use custom template'] = 'Use custom template';
+$GLOBALS['t']['use templatepack'] = 'Use template pack';
+
+?&gt;
\ No newline at end of file

Added: YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/languages/YDCMPage/pt.php
===================================================================
--- YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/languages/YDCMPage/pt.php	2006-08-23 15:09:37 UTC (rev 2039)
+++ YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/languages/YDCMPage/pt.php	2006-08-23 15:11:13 UTC (rev 2040)
@@ -0,0 +1,34 @@
+&lt;?php
+// PERMISSIONS
+$GLOBALS['t']['ydcmpage_create'] = 'Criar';
+$GLOBALS['t']['ydcmpage_delete'] = 'Eliminar';
+
+
+// PAGE FORM
+$GLOBALS['t']['page_reference'] = 'Refer&ecirc;ncia';
+$GLOBALS['t']['page_title'] = 'Titulo';
+$GLOBALS['t']['page_content'] = 'Conte&uacute;do';
+$GLOBALS['t']['page_access'] = 'Acesso';
+$GLOBALS['t']['page_state'] = 'Publicado';
+$GLOBALS['t']['page_startdate'] = 'Data inicial';
+$GLOBALS['t']['page_enddate'] = 'Data final';
+$GLOBALS['t']['page_templates'] = 'Templates';
+$GLOBALS['t']['page_template'] = 'Template';
+$GLOBALS['t']['page_metatags'] = 'Metatags';
+$GLOBALS['t']['page_description'] = 'Descri&ccedil;&atilde;o';
+$GLOBALS['t']['page_keywords'] = 'Keywords';
+$GLOBALS['t']['page_search'] = 'Pesquis&aacute;vel';
+
+// PAGE FORM RULES
+
+// OTHER
+$GLOBALS['t']['page'] = 'P&aacute;gina';
+$GLOBALS['t']['page content'] = 'Conte&uacute;do';
+$GLOBALS['t']['page template'] = 'Template';
+$GLOBALS['t']['page access'] = 'Acesso';
+$GLOBALS['t']['new page'] = 'Nova p&aacute;gina';
+$GLOBALS['t']['edit page'] = 'Editar p&aacute;gina';
+$GLOBALS['t']['use custom template'] = 'Usar template especial';
+$GLOBALS['t']['use templatepack'] = 'Usar template pack';
+
+?&gt;
\ No newline at end of file

Added: YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/languages/YDCMUsers/en.php
===================================================================
--- YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/languages/YDCMUsers/en.php	2006-08-23 15:09:37 UTC (rev 2039)
+++ YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/languages/YDCMUsers/en.php	2006-08-23 15:11:13 UTC (rev 2040)
@@ -0,0 +1,53 @@
+&lt;?php
+
+// USER FORM
+$GLOBALS['t']['user_username'] = 'Username';
+$GLOBALS['t']['user_password'] = 'Password';
+$GLOBALS['t']['user_name'] = 'Name';
+$GLOBALS['t']['user_email'] = 'Email';
+$GLOBALS['t']['user_other'] = 'Other';
+$GLOBALS['t']['user_language'] = 'Language';
+$GLOBALS['t']['user_template'] = 'Template';
+$GLOBALS['t']['login_state'] = 'Login';
+$GLOBALS['t']['login_start'] = 'Login start date';
+$GLOBALS['t']['login_end'] = 'Login end date';
+$GLOBALS['t']['login_counter'] = 'Total of logins';
+$GLOBALS['t']['login_last'] = 'Last login date';
+$GLOBALS['t']['login_current'] = 'Current login date';
+$GLOBALS['t']['created_user'] = 'Created by';
+$GLOBALS['t']['created_date'] = 'Created in';
+
+// USER FORM RULES
+$GLOBALS['t']['name too big'] = 'Name is too big';
+$GLOBALS['t']['email not valid'] = 'Email is not valid';
+$GLOBALS['t']['other too big'] = 'Other informations about the user are to big';
+$GLOBALS['t']['language not valid'] = 'Language is not valid';
+$GLOBALS['t']['template not valid'] = 'Template is not valid';
+
+// PASSWORD FORM
+$GLOBALS['t']['password_old'] = 'Current password';
+$GLOBALS['t']['password_new'] = 'New password';
+$GLOBALS['t']['password_new_confirm'] = 'Confirm new password';
+
+// PASSWORD FORM RULES
+$GLOBALS['t']['passwords are required'] = 'All passwords are required';
+$GLOBALS['t']['passwords dont match'] = 'Passwords do not match';
+$GLOBALS['t']['passwords too big'] = 'There is at least one password too big';
+$GLOBALS['t']['passwords not alphanumeric'] = 'All passwords must be alphanumeric';
+
+// OTHER
+$GLOBALS['t']['passwords'] = 'Passwords';
+$GLOBALS['t']['change password'] = 'Change password';
+$GLOBALS['t']['personal info'] = 'Personal informations';
+$GLOBALS['t']['access'] = 'Access';
+$GLOBALS['t']['old password is incorrect'] = 'Current password is incorrect';
+$GLOBALS['t']['user password updated'] = 'Password is updated';
+$GLOBALS['t']['user is incorrect'] = 'Current user is not valid';
+$GLOBALS['t']['user details updated'] = 'User details updated';
+$GLOBALS['t']['password not updated'] = 'Password was not updated';
+$GLOBALS['t']['user not updated'] = 'User was not updated';
+$GLOBALS['t']['user added'] = 'New user added';
+$GLOBALS['t']['administrator and children'] = 'Administrator and children';
+$GLOBALS['t']['children only'] = 'Children only';
+
+?&gt;
\ No newline at end of file

Added: YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/languages/YDCMUsers/pt.php
===================================================================
--- YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/languages/YDCMUsers/pt.php	2006-08-23 15:09:37 UTC (rev 2039)
+++ YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/languages/YDCMUsers/pt.php	2006-08-23 15:11:13 UTC (rev 2040)
@@ -0,0 +1,54 @@
+&lt;?php
+
+// USER FORM
+$GLOBALS['t']['user_username'] = 'Username';
+$GLOBALS['t']['user_password'] = 'Password';
+$GLOBALS['t']['user_name'] = 'Nome';
+$GLOBALS['t']['user_email'] = 'Email';
+$GLOBALS['t']['user_other'] = 'Outras informa&ccedil;oes';
+$GLOBALS['t']['user_language'] = 'Idioma';
+$GLOBALS['t']['user_template'] = 'Template';
+$GLOBALS['t']['login_state'] = 'Login';
+$GLOBALS['t']['login_start'] = 'Data para inicio de login';
+$GLOBALS['t']['login_end'] = 'Data em que o login expira';
+$GLOBALS['t']['login_counter'] = 'Total de logins';
+$GLOBALS['t']['login_last'] = 'Data do &uacute;ltimo login';
+$GLOBALS['t']['login_current'] = 'Data do login actual';
+$GLOBALS['t']['created_user'] = 'Criado por';
+$GLOBALS['t']['created_date'] = 'Criado em';
+
+// USER FORM RULES
+$GLOBALS['t']['name too big'] = 'O nome &eacute; demasiado grande';
+$GLOBALS['t']['email not valid'] = 'O email n&atilde;o &eacute; v&aacute;lido';
+$GLOBALS['t']['other too big'] = 'As informa&ccedil;&otilde;es adicionais s&atilde;o demasiado grandes';
+$GLOBALS['t']['language not valid'] = 'O idioma n&atilde;o &eacute; v&aacute;lido';
+$GLOBALS['t']['template not valid'] = 'O template n&atilde;o &eacute; v&aacute;lido';
+
+// PASSWORD FORM
+$GLOBALS['t']['password_old'] = 'Password actual';
+$GLOBALS['t']['password_new'] = 'Nova password';
+$GLOBALS['t']['password_new_confirm'] = 'Confirme a nova password';
+
+// PASSWORD FORM RULES
+$GLOBALS['t']['passwords are required'] = 'Todas as passwords s&atilde;o obrigat&oacute;rias';
+$GLOBALS['t']['passwords dont match'] = 'As passwords n&atilde;o s&atilde;o iguais';
+$GLOBALS['t']['passwords too big'] = 'Existe pelo menos uma password demasiado grande';
+$GLOBALS['t']['passwords not alphanumeric'] = 'As password t&ecirc;em de ser alfanum&eacute;ricas';
+
+// OTHER
+$GLOBALS['t']['passwords'] = 'Passwords';
+$GLOBALS['t']['change password'] = 'Modificar a password';
+$GLOBALS['t']['personal info'] = 'Configura&ccedil;&otilde;es pessoais';
+$GLOBALS['t']['access'] = 'Acesso';
+$GLOBALS['t']['old password is incorrect'] = 'A password actual &eacute; incorrecta';
+$GLOBALS['t']['user password updated'] = 'A password foi actualizada';
+$GLOBALS['t']['user is incorrect'] = 'O utilizador actual &eacute; incorrecto';
+$GLOBALS['t']['user details updated'] = 'Informa&ccedil;&otilde;es do utilizador actualizadas';
+$GLOBALS['t']['password not updated'] = 'A password n&atilde;o foi actualizada';
+$GLOBALS['t']['user not updated'] = 'O utilizador n&atilde;o foi actualizado';
+$GLOBALS['t']['user added'] = 'Utilizador adicionado';
+$GLOBALS['t']['administrator and children'] = 'Administrador e sub-administratores';
+$GLOBALS['t']['children only'] = 'Apenas sub-administratores';
+
+
+?&gt;
\ No newline at end of file

Added: YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/languages/en.php
===================================================================
--- YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/languages/en.php	2006-08-23 15:09:37 UTC (rev 2039)
+++ YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/languages/en.php	2006-08-23 15:11:13 UTC (rev 2040)
@@ -0,0 +1,64 @@
+&lt;?php
+
+// components
+$GLOBALS['t']['ydcmpage'] = 'Page';
+$GLOBALS['t']['ydcmpage s'] = 'Pages';
+$GLOBALS['t']['ydcmrootmenu'] = 'Menu';
+$GLOBALS['t']['ydcmrootmenu s'] = 'Menus';
+
+$GLOBALS['t']['save'] = 'Save';
+$GLOBALS['t']['close'] = 'Close';
+$GLOBALS['t']['open'] = 'Open';
+$GLOBALS['t']['help'] = 'Help';
+$GLOBALS['t']['back'] = 'Back';
+$GLOBALS['t']['not applicable'] = 'Not applicable';
+$GLOBALS['t']['yes'] = 'Yes';
+$GLOBALS['t']['no'] = 'No';
+$GLOBALS['t']['active'] = 'Active';
+$GLOBALS['t']['blocked'] = 'Blocked';
+$GLOBALS['t']['schedule'] = 'Schedule';
+$GLOBALS['t']['permissions'] = 'Permissions';
+$GLOBALS['t']['delete'] = 'Delete';
+$GLOBALS['t']['toggle state'] = 'Toggle state';
+$GLOBALS['t']['public'] = 'Public';
+$GLOBALS['t']['private'] = 'Private';
+$GLOBALS['t']['not allowed'] = 'Not allowed';
+$GLOBALS['t']['total'] = 'Total';
+$GLOBALS['t']['previous'] = 'Previous';
+$GLOBALS['t']['next'] = 'Next';
+$GLOBALS['t']['state'] = 'State';
+$GLOBALS['t']['add'] = 'Add';
+$GLOBALS['t']['add component'] = 'Add component';
+$GLOBALS['t']['move'] = 'Move';
+$GLOBALS['t']['move up'] = 'Move up';
+$GLOBALS['t']['move down'] = 'Move down';
+$GLOBALS['t']['edit'] = 'Edit';
+$GLOBALS['t']['properties'] = 'Properties';
+$GLOBALS['t']['please wait'] = 'Please wait';
+
+$GLOBALS['t']['visitor'] = 'Visitor';
+$GLOBALS['t']['visitors'] = 'Visitors';
+$GLOBALS['t']['administrator'] = 'Administrator';
+$GLOBALS['t']['administrators'] = 'Administrators';
+
+$GLOBALS['t']['published'] = 'Published';
+$GLOBALS['t']['not published'] = 'Not published';
+$GLOBALS['t']['schedule'] = 'Schedule';
+
+$GLOBALS['t']['translate'] = 'Translate';
+$GLOBALS['t']['translate to'] = 'Translate to';
+
+$GLOBALS['t']['total versions'] = 'Total of versions';
+$GLOBALS['t']['general config'] = 'General configuration';
+$GLOBALS['t']['content versions'] = 'Versions';
+
+$GLOBALS['t']['content'] = 'Content';
+$GLOBALS['t']['general view'] = 'General view';
+$GLOBALS['t']['statistics'] = 'Statistics';
+$GLOBALS['t']['administration'] = 'Administration';
+$GLOBALS['t']['system information'] = 'System information';
+$GLOBALS['t']['backup'] = 'Backup';
+$GLOBALS['t']['audit'] = 'Audit';
+$GLOBALS['t']['user management'] = 'User management';
+$GLOBALS['t']['general configuration'] = 'General configuration';
+?&gt;
\ No newline at end of file

Added: YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/languages/pt.php
===================================================================
--- YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/languages/pt.php	2006-08-23 15:09:37 UTC (rev 2039)
+++ YDFramework2.0/trunk/YDFramework2/addons/YDCMComponent/languages/pt.php	2006-08-23 15:11:13 UTC (rev 2040)
@@ -0,0 +1,62 @@
+&lt;?php
+
+// components
+$GLOBALS['t']['ydcmpage'] = 'P&aacute;gina';
+$GLOBALS['t']['ydcmpage s'] = 'P&aacute;ginas';
+$GLOBALS['t']['ydcmrootmenu'] = 'Menu';
+$GLOBALS['t']['ydcmrootmenu s'] = 'Menus';
+
+$GLOBALS['t']['save'] = 'Guardar';
+$GLOBALS['t']['close'] = 'Fechar';
+$GLOBALS['t']['open'] = 'Abrir';
+$GLOBALS['t']['help'] = 'Ajuda';
+$GLOBALS['t']['back'] = 'Voltar';
+$GLOBALS['t']['not applicable'] = 'N&atilde;o aplic&aacute;vel';
+$GLOBALS['t']['yes'] = 'Sim';
+$GLOBALS['t']['no'] = 'N&atilde;o';
+$GLOBALS['t']['active'] = 'Activo';
+$GLOBALS['t']['blocked'] = 'Bloqueado';
+$GLOBALS['t']['schedule'] = 'Calend&aacute;rio';
+$GLOBALS['t']['permissions'] = 'Permiss&otilde;es';
+$GLOBALS['t']['delete'] = 'Eliminar';
+$GLOBALS['t']['toggle state'] = 'Inverter estado';
+$GLOBALS['t']['public'] = 'P&uacute;blico';
+$GLOBALS['t']['private'] = 'Privado';
+$GLOBALS['t']['not allowed'] = 'N&atilde;o permitido';
+$GLOBALS['t']['total'] = 'Total';
+$GLOBALS['t']['previous'] = 'Anterior';
+$GLOBALS['t']['next'] = 'Seguinte';
+$GLOBALS['t']['state'] = 'Estado';
+$GLOBALS['t']['add'] = 'Adicionar';
+$GLOBALS['t']['add component'] = 'Adicionar component';
+$GLOBALS['t']['move'] = 'Mover';
+$GLOBALS['t']['move up'] = 'Mover para cima';
+$GLOBALS['t']['move down'] = 'Mover para baixo';
+$GLOBALS['t']['edit'] = 'Editar';
+$GLOBALS['t']['properties'] = 'Propriedades';
+$GLOBALS['t']['please wait'] = 'Por favor aguarde';
+
+$GLOBALS['t']['visitor'] = 'Visitante';
+$GLOBALS['t']['visitors'] = 'Visitantes';
+$GLOBALS['t']['administrator'] = 'Administrador';
+$GLOBALS['t']['administrators'] = 'Administradores';
+
+$GLOBALS['t']['translate'] = 'Traduzir';
+$GLOBALS['t']['translate to'] = 'Traduzir para';
+
+$GLOBALS['t']['total versions'] = 'Total de vers&#245;es';
+$GLOBALS['t']['general config'] = 'Configura&#231;&#227;o geral';
+$GLOBALS['t']['content versions'] = 'Vers&#245;es';
+
+$GLOBALS['t']['content'] = 'Conte&uacute;do';
+$GLOBALS['t']['general view'] = 'Vista geral';
+$GLOBALS['t']['statistics'] = 'Estat&iacute;sticas';
+$GLOBALS['t']['administration'] = 'Administra&ccedil;&atilde;o';
+$GLOBALS['t']['system information'] = 'Informa&ccedil;&otilde;es do sistema';
+$GLOBALS['t']['backup'] = 'C&oacute;pias de seguran&ccedil;a';
+$GLOBALS['t']['audit'] = 'Auditoria';
+$GLOBALS['t']['user management'] = 'Gest&atilde;o de utilizadores';
+$GLOBALS['t']['general configuration'] = 'Configura&ccedil;&atilde;o geral';
+
+
+?&gt;
\ No newline at end of file


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000549.html">[ydf-devel] r2039 - YDFramework2.0/trunk/YDFramework2/YDClasses
</A></li>
	<LI>Next message: <A HREF="000551.html">[ydf-devel] r2041 - YDFramework2.0/trunk/examples/cm/backend
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#550">[ date ]</a>
              <a href="thread.html#550">[ thread ]</a>
              <a href="subject.html#550">[ subject ]</a>
              <a href="author.html#550">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/ydframework-devel">More information about the YDFramework-devel
mailing list</a><br>
</body></html>
